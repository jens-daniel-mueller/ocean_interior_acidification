---
title: "OIA Averaging"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

# Libraries

```{r load_libraries_specific, include = FALSE}
library(patchwork)
library(ggalluvial)
library(marelac)
library(ggdist)
library(kableExtra)
library(khroma)
library(ggh4x)
library(ggpattern)
library(colorspace)
library(stars)
library(seacarb)
```

```{r select_basinmask_5}

basinmask <- basinmask %>% 
  filter(MLR_basins == "5") %>% 
  select(lon, lat, basin)

```


```{r define_paths_to_access_eMLR_files, include = FALSE}

# only path_observations needs to be changed to model
path_observations <-
  paste0(path_root, "/observations/")

path_preprocessing    <-
  paste0(path_observations, "preprocessing/")


path_preprocessing_model    <-
  paste0(path_root, "/model/preprocessing/")

path_out <-   paste0(path_observations, "output_publication/")
path_OIA <-   "/nfs/kryo/work/jenmueller/ocean_interior_acidification/"


```

# Read data

## dCant

```{r read_OIA_data}

all_files <- list.files(path_OIA) %>% 
  str_subset(".csv")

acidification_trend <-
  read_csv(paste0(path_OIA, "OIA_Standard case_3.csv"))

OIA_variables <- 
  acidification_trend %>%
  select(contains("delta_total")) %>% 
  names() %>% 
  str_remove("_delta_total")

OIA_variables <- OIA_variables[-c(3,7,8)]

# read_csv(paste0(path_OIA, "OIA_all.csv"))

# acidification_trend %>%
#   filter(Version_ID_group == "Standard case",
#          MLR_basins == "3") %>%
#   write_csv(paste0(path_OIA, "OIA_standard_case.csv"))


```

## Temperature driver

```{r read_OIA_temperature_driven}

temperature_trend <-
  read_csv(paste0(path_OIA, "OIA_Temperature_3.csv"))

dCant_temp_trend_depth_grid <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref),
    temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

dCant_trend <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_temp_trend_depth_grid
  )

temp_trend <-
  inner_join(
    temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_temp_trend_depth_grid
  )


dCant_temp_trend <-
  bind_rows(dCant_trend %>%
              mutate(driver = "dCant"),
            temp_trend %>%
              mutate(driver = "dCant + temp"))

rm(temperature_trend, dCant_trend, temp_trend, dCant_temp_trend_depth_grid)


```

## DIC driver

```{r read_OIA_DIC_driven}

DIC_trend <-
  read_csv(paste0(path_OIA, "OIA_DIC_3.csv"))

DIC_temperature_trend <-
  read_csv(paste0(path_OIA, "OIA_DIC + temp_3.csv"))

# create common grid
DIC_dCant_temp_trend_depth_grid <-
  inner_join(
    DIC_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref),
    DIC_temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

DIC_dCant_temp_trend_depth_grid <-
  inner_join(
    DIC_dCant_temp_trend_depth_grid,
    dCant_temp_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )


# reduce input data frames to common grid
DIC_trend <-
  inner_join(
    DIC_trend %>%
      filter(tref %in% c(2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    DIC_dCant_temp_trend_depth_grid
  )

DIC_temperature_trend <-
  inner_join(
    DIC_temperature_trend %>%
      filter(tref %in% c(2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    DIC_dCant_temp_trend_depth_grid
  )

dCant_temp_trend_temporary <-
  inner_join(
    dCant_temp_trend %>%
      filter(tref %in% c(2014)) %>%
      select(lon, lat, depth, tref, driver, basin_AIP, contains("delta_interval")),
    DIC_dCant_temp_trend_depth_grid
  )


DIC_dCant_temp_trend <-
  bind_rows(DIC_trend %>%
              mutate(driver = "DIC"),
            DIC_temperature_trend %>%
              mutate(driver = "DIC + temp"),
            dCant_temp_trend_temporary)

rm(DIC_trend, DIC_temperature_trend,
   dCant_temp_trend_temporary,
   DIC_dCant_temp_trend_depth_grid)


```

## Buffer changes

```{r read_buffer_changes}

buffer_trend <-
  read_csv(paste0(path_OIA, "buffer_Standard case_3.csv"))

buffer_trend <- buffer_trend %>% 
  select(-c(MLR_basins, Version_ID_group))

buffer_trend <-
  full_join(
    buffer_trend,
    acidification_trend %>% select(lon, lat, depth, tref, basin_AIP,
                                   contains("tco2_talk"))
  )

buffer_variables <- 
  buffer_trend %>%
  select(contains("delta_total")) %>% 
  names() %>% 
  str_remove("_delta_total")

```



# Uncertainty determination

## Reference dCant case

```{r reference_dcant_reconstructions, eval=FALSE}

MLR_basins_reference <- unique(acidification_trend$MLR_basins)[1]

MLR_basins_all <- unique(acidification_trend$MLR_basins)

MLR_basins_uncertainty <-
  MLR_basins_all[!MLR_basins_all %in% MLR_basins_reference]



Version_ID_group_reference <-
  unique(acidification_trend$Version_ID_group)[1]
Version_ID_group_all <-
  unique(acidification_trend$Version_ID_group)

Version_ID_group_uncertainty <-
  Version_ID_group_all[Version_ID_group_all != Version_ID_group_reference]

```

## Additive computation

```{r uncertainty_determination, eval=FALSE}

additive_uncertainty <- function(df){
  
  df_regional_uncertainty <-
    df %>%
    filter(MLR_basins != MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-Version_ID_group) %>% 
    pivot_wider(names_from = MLR_basins,
                values_from = contains("_interval_mean"),
                names_sep = "-") %>%
    pivot_longer(all_of(contains(MLR_basins_uncertainty)),
                 names_to = c("variable","MLR_basins"),
                 names_sep = "-",
                 values_to = "value")
  
  df_regional_reference <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-c(MLR_basins, Version_ID_group)) %>% 
    pivot_longer(contains("_interval_mean"),
                 names_to = c("variable"),
                 values_to = MLR_basins_reference)
  
  df_regional <-
    full_join(df_regional_reference, df_regional_uncertainty)
  
  df_regional <-
    df_regional %>%
    mutate(delta_value = value-!!sym(MLR_basins_reference)) %>%
    select(-c(all_of(MLR_basins_reference), MLR_basins, value))

  df_regional_stat <-
    df_regional %>%
    group_by(across(-delta_value)) %>%
    summarise(sd = mean(abs(delta_value))) %>%
    ungroup()


  df_configuration_uncertainty <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group %in% Version_ID_group_uncertainty) %>% 
    select(-MLR_basins) %>% 
    pivot_wider(names_from = Version_ID_group,
                values_from = contains("_interval_mean"),
                names_sep = "-") %>%
   pivot_longer(all_of(contains(Version_ID_group_uncertainty)),
                 names_to = c("variable","Version_ID_group"),
                 names_sep = "-",
                 values_to = "value")

  
  df <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-c(Version_ID_group, MLR_basins)) %>% 
    pivot_longer(contains("_interval_mean"),
                 names_to = c("variable"),
                 values_to = Version_ID_group_reference)

  df_configuration <-
    full_join(df, df_configuration_uncertainty) 
  
  df_configuration <- df_configuration %>% 
    mutate(delta_value = value-!!sym(Version_ID_group_reference))
  
  
  df_configuration <-
    df_configuration %>%
    rename(sd = delta_value) %>%
    select(-c(value, all_of(Version_ID_group_reference)))
  
  df_factorial <-
    bind_rows(
      df_regional_stat %>%
        mutate(Version_ID_group = "Regional clustering"),
      df_configuration
    )

  df_factorial_stat <-
    df_factorial %>%
    select(-Version_ID_group) %>%
    group_by(across(-sd)) %>%
    summarise(sd = sqrt(sum(sd ^ 2, na.rm = TRUE))) %>%
    ungroup()

  df_stat <-
    full_join(
      df_factorial_stat,
      df %>%
        rename(std_case = all_of(Version_ID_group_reference))
    )

  df_stat <- df_stat %>%
    mutate(
      signif_single = if_else(abs(std_case) >= sd,
                              1,
                              0),
      signif_double = if_else(abs(std_case) >= sd * 2,
                              1,
                              0)
    )

  df_stat_delta <-
    df_stat %>%
    select(-starts_with("signif_")) %>%
    arrange(tref) %>%
    group_by(across(-c(tref, sd, std_case))) %>%
    mutate(
      delta_value = std_case - lag(std_case),
      RSS = sqrt(sd ^ 2 + lag(sd ^ 2)),
      signif_single = if_else(abs(delta_value) >= RSS,
                              1,
                              0),
      signif_double = if_else(abs(delta_value) >= RSS * 2,
                              1,
                              0)
    ) %>%
    ungroup() %>%
    drop_na()
  
  
  df_stat <-
    df_stat %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))
  
  df_factorial <-
    df_factorial %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))
  
  df_stat_delta <-
    df_stat_delta %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))


df_out <- list(df_stat, df_factorial, df_stat_delta)

return(df_out)

}


```

# Color scale settings

##

```{r set_color_range_quantiles}

quantile_high <- 0.98
quantile_low <- 0.02

break_numbers <- 10

```
 
# Surface area mask

```{r surface_area_mask}
# compute grid cell surface area

basinmask <- basinmask %>% 
    mutate(area = earth_surf(lat, lon))

```




# OIA

## Depth layer maps

### Computation

```{r compute_layered_maps}

# total acidification

acidification_depth_layer <- acidification_trend %>%
  mutate(depth = cut(
    depth,
    c(0, 100, 500, 1500, 3000),
    c("A: 0 - 100 m", "B: 100 - 500 m", "C :500 - 1500 m", "D: 1500 - 3000 m"),
    include.lowest = TRUE
  )) %>%
  drop_na() %>%
  select(c(lat, lon, depth, tref),
         where(is.numeric)) %>%
  fgroup_by(lat, lon, depth, tref) %>% {
    add_vars(
      fgroup_vars(., "unique"),
      fmean(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_mean"),
      fsd(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_sd")
    )
  }


# total acidification

acidification_depth_layer_dCant_temp <- dCant_temp_trend %>%
  mutate(depth = cut(
    depth,
    c(0, 100, 500, 1500, 3000),
    c("A: 0 - 100 m", "B: 100 - 500 m", "C :500 - 1500 m", "D: 1500 - 3000 m"),
    include.lowest = TRUE
  )) %>%
  drop_na() %>%
  select(c(lat, lon, depth, tref, driver),
         where(is.numeric)) %>%
  fgroup_by(lat, lon, depth, tref, driver) %>% {
    add_vars(
      fgroup_vars(., "unique"),
      fmean(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_mean"),
      fsd(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_sd")
    )
  }

```

### Incremental changes

#### dCant + temp

```{r depth_layer_incremental_change_dCant_temp, eval=FALSE}

# subset dCant_temp change sections

acidification_depth_layer_dCant_temp <-
  acidification_depth_layer_dCant_temp %>%
  select(lat:driver,
         contains("_delta_interval"),
         -contains("_sd"))

acidification_depth_layer_dCant_temp <-
  acidification_depth_layer_dCant_temp %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))

# create pdf document

pdf(
  here::here("output/maps_depth_layer_dCant_temp_changes.pdf"),
  width = 20,
  height = 6
)

# loop over OIA variables
# print dCant_temp sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_depth_layer_dCant_temp <-
    acidification_depth_layer_dCant_temp %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, driver, delta_interval)

  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_depth_layer_dCant <-
  i_acidification_depth_layer_dCant_temp %>%
    filter(driver == "dCant") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
    ) &
    labs(title = "Driver: dCant")
  
  p_depth_layer_dCant_temp <-
  i_acidification_depth_layer_dCant_temp %>%
    filter(driver == "dCant + temp") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
    ) &
    labs(title = "Driver: dCant + temp")
      
  i_delta_acidification_depth_layer_decadal <-
    i_acidification_depth_layer_dCant_temp %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    select(lon, lat, depth, driver, delta_delta_interval)
  
  low <- i_delta_acidification_depth_layer_decadal %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_decadal %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_decadal <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_decadal <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_decadal <-
    i_delta_acidification_depth_layer_decadal %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "driver",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_decadal,
      dot_size_single = 0.2,
      dot_size_double = 0.005
    ) &
    labs(title = "Decadal difference")
  
  
  i_delta_acidification_depth_layer_driver <-
    i_acidification_depth_layer_dCant_temp %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant + temp` - `dCant`) %>%
    select(lon, lat, depth, tref, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_driver <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_driver <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_driver <-
    i_delta_acidification_depth_layer_driver %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_driver,
      dot_size_single = 0.2,
      dot_size_double = 0.005
    ) &
    labs(title = "Driver difference")
  
  print(
    wrap_plots(
      p_depth_layer_dCant,
      p_depth_layer_dCant_temp,
      p_depth_layer_decadal,
      p_depth_layer_driver,
      ncol = 2
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_dCant_temp,
   i_acidification_depth_layer_dCant_temp,
   i_delta_acidification_depth_layer_decadal,
   i_delta_acidification_depth_layer_driver,
   high, low,
   high_low_decadal,
   high_low_driver,
   breaks_divergent_decadal,
   breaks_divergent_driver,
   p_depth_layer_dCant,
   p_depth_layer_dCant_temp,
   p_depth_layer_decadal,
   p_depth_layer_driver)

```

#### dCant

```{r depth_layer_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_depth_layer_incremental <-
  acidification_depth_layer %>%
  select(lat:Version_ID_group,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_depth_layer_uncertainty <-
  m_grid_horizontal_coarse(acidification_depth_layer_incremental)

acidification_depth_layer_uncertainty <-
  acidification_depth_layer_uncertainty %>% 
  select(-c(lat,lon)) %>% 
  rename(lat = lat_grid, lon = lon_grid) %>% 
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean),
            n = n()) %>%
  ungroup() %>% 
  filter(n == 25) %>% 
  select(-n)

# compute uncertainty

acidification_depth_layer_uncertainty <-
  additive_uncertainty(acidification_depth_layer_uncertainty)

delta_acidification_depth_layer_uncertainty <- acidification_depth_layer_uncertainty[[3]]
acidification_depth_layer_uncertainty <- acidification_depth_layer_uncertainty[[1]]


# subset reference reconstruction

acidification_depth_layer_incremental <-
  acidification_depth_layer_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/maps_depth_layer_incremental_changes.pdf"),
  width = 14,
  height = 7
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_depth_layer_incremental <-
    acidification_depth_layer_incremental %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, delta_interval)

  i_acidification_depth_layer_uncertainty <-
    acidification_depth_layer_uncertainty %>%
    filter(variable == i_var)

  i_acidification_depth_layer_uncertainty <-
    i_acidification_depth_layer_uncertainty %>%
    select(lon, lat, depth, tref, signif_single, signif_double) %>%
    st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat")

  i_delta_acidification_depth_layer_uncertainty <-
    delta_acidification_depth_layer_uncertainty %>%
    filter(variable == i_var)

  i_delta_acidification_depth_layer_uncertainty <-
    i_delta_acidification_depth_layer_uncertainty %>%
    select(lon, lat, depth, tref, signif_single, signif_double) %>%
    st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat")
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_depth_layer_decades <-
  i_acidification_depth_layer_incremental %>%
    p_map_mdim_robinson(
      df_uncertainty = i_acidification_depth_layer_uncertainty,
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005
    )
      
  i_delta_acidification_depth_layer_incremental <-
    i_acidification_depth_layer_incremental %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    select(lon, lat, depth, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  breaks_divergent <-
    c(-Inf, seq(-high_low, high_low, length.out = break_numbers), Inf)
  
  p_depth_layer_offset <-
    i_delta_acidification_depth_layer_incremental %>% 
    p_map_mdim_robinson(
      df_uncertainty = i_delta_acidification_depth_layer_uncertainty,
      dim_col = "depth",
      # dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent,
      dot_size_single = 0.2,
      dot_size_double = 0.005
    )
  
  print(
    wrap_plots(
      p_depth_layer_decades,
      p_depth_layer_offset,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_incremental,
   acidification_depth_layer_uncertainty,
   delta_acidification_depth_layer_uncertainty
   )

```

### Total changes

```{r depth_layer_total_change}

# subset total change sections

acidification_depth_layer_total <-
  acidification_depth_layer %>%
  select(lat:tref,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_depth_layer_total <-
  acidification_depth_layer_total %>%
  # filter(MLR_basins == MLR_basins_reference,
  #        Version_ID_group == Version_ID_group_reference) %>%
  # select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/maps_depth_layer_mean_sections_total_changes.pdf"),
  width = 14,
  height = 5
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables[-8]) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_depth_layer_total <-
    acidification_depth_layer_total %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, delta_total)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_depth_layer_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  # breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  # df <- i_acidification_depth_layer_total
  
  p_total_fill <-
  i_acidification_depth_layer_total %>%
    p_map_mdim_robinson(
      # df_uncertainty = i_acidification_depth_layer_uncertainty,
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_total",
      legend_title = i_var,
      breaks = breaks
    )
  
  print(
  p_total_fill
  )
  
}

dev.off()

rm(acidification_depth_layer_total,
   acidification_depth_layer,
   i_acidification_depth_layer_total)

```


## Saturation horizon maps

```{r compute_saturation_horizon_maps}

acidification_saturation_horizon <- acidification_trend %>%
  # filter(MLR_basins == MLR_basins_reference,
  #        Version_ID_group == Version_ID_group_reference) %>%
  select(lat,lon, depth, tref,
         contains("Omega"),
         -contains("delta"))

acidification_saturation_horizon <-
  acidification_saturation_horizon %>%
  pivot_longer(
    contains("Omega"),
    names_to = "mineral",
    names_prefix = "Omega",
    values_to = "Omega"
  )

# downscaling for computation

acidification_saturation_horizon <-
  m_grid_horizontal_coarse(acidification_saturation_horizon)

acidification_saturation_horizon <-
  acidification_saturation_horizon %>% 
  select(-c(lat,lon)) %>% 
  rename(lat = lat_grid, lon = lon_grid) %>% 
  group_by(lat,lon,tref,depth,mineral) %>%
  summarise(Omega = mean(Omega, na_rm = TRUE),
            n = n()) %>%
  ungroup() %>% 
  filter(n == 25) %>% 
  select(-n)

# depth_grid <-
#   expand_grid(
#     acidification_saturation_horizon %>%
#       distinct(lat, lon, tref, mineral),
#     depth = seq(0, 5500, 10)
#   )
# 
# acidification_saturation_horizon <-
#   full_join(acidification_saturation_horizon,
#             depth_grid)
# 
# rm(depth_grid)
# 
# acidification_saturation_horizon <-
#   acidification_saturation_horizon %>%
#   group_by(lon, lat, tref, mineral) %>%
#   mutate(n = n()) %>%
#   ungroup() 
# 
# acidification_saturation_horizon <-
#   acidification_saturation_horizon %>%
#   filter(n == 553) %>%
#   select(-n)
# 
# # acidification_saturation_horizon <-
# #   acidification_saturation_horizon %>%
# #   arrange(lon, lat, tref, mineral, depth)
# 
# acidification_saturation_horizon <-
#   acidification_saturation_horizon %>%
#   group_by(lon, lat, tref, mineral) %>%
#   mutate(Omega = approxfun(depth, Omega, rule = 1)(depth)) %>%
#   ungroup()
# 
# acidification_saturation_horizon <-
#   acidification_saturation_horizon %>%
#   drop_na()

for(i_sat_level in c(3, 2, 1.5, 1, 0.5)) {
  
  # i_sat_level <- 2
  
  temp <-
    acidification_saturation_horizon %>%
    filter(Omega < i_sat_level) %>%
    group_by(lat, lon, tref, mineral) %>%
    summarise(saturation_horizon = min(depth)) %>%
    ungroup() %>%
    mutate(sat_level = i_sat_level)
  
  temp_volume <- inner_join(temp,
             basinmask)
  
  temp_volume <- temp_volume %>% 
    mutate(volume = saturation_horizon * area) %>% 
    group_by(tref, mineral, basin) %>% 
    summarise(volume = sum(volume, na.rm = TRUE)) %>% 
    ungroup()
  
  temp_volume_global <- temp_volume %>% 
    group_by(tref, mineral) %>% 
    summarise(volume = sum(volume, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(basin = "Global")
  
  
  temp_volume <- bind_rows(temp_volume,
                           temp_volume_global) %>%
    mutate(sat_level = i_sat_level)
  
  if (exists("acidification_saturation_horizon_levels")) {
    acidification_saturation_horizon_levels <-
      bind_rows(acidification_saturation_horizon_levels, temp)
  }
  
  if (!exists("acidification_saturation_horizon_levels")) {
    acidification_saturation_horizon_levels <- temp
  }
  
  if (exists("acidification_volume")) {
    acidification_volume <-
      bind_rows(acidification_volume, temp_volume)
  }
  
  if (!exists("acidification_volume")) {
    acidification_volume <- temp_volume
  }
  
}

# rm(acidification_volume, acidification_saturation_horizon_levels)

pdf(
  here::here("output/maps_saturation_horizon_absolute_state.pdf"),
  width = 10,
  height = 8
)

for (i_sat_level in unique(acidification_saturation_horizon_levels$sat_level)) {
  
  print(
  acidification_saturation_horizon_levels %>%
    relocate(lon) %>%
    filter(sat_level == i_sat_level) %>% 
    select(-sat_level) %>% 
    p_map_mdim_robinson(
      dim_row = "tref",
      dim_col = "mineral",
      var = "saturation_horizon",
      legend_title = "Saturation\nhorizon\n(m)",
      breaks = seq(0, 6000, 500)
    ) +
    labs(title = paste("Saturation threshold:",i_sat_level))
  )
}

dev.off()

pdf(
  here::here("output/maps_saturation_horizon_total_changes.pdf"),
  width = 10,
  height = 6
)


for (i_sat_level in unique(acidification_saturation_horizon_levels$sat_level)) {
  print(
    acidification_saturation_horizon_levels %>%
      filter(sat_level == i_sat_level) %>%
      select(-sat_level) %>%
      arrange(tref) %>%
      group_by(lat, lon, mineral) %>%
      mutate(
        delta_saturation_horizon = saturation_horizon - lag(saturation_horizon),
        period = paste(lag(tref), "-", tref)
      ) %>%
      ungroup() %>%
      drop_na() %>%
      select(lon, lat, period, mineral, delta_saturation_horizon) %>%
      p_map_mdim_robinson(
        dim_row = "period",
        dim_col = "mineral",
        col = "div",
        var = "delta_saturation_horizon",
        legend_title = "Change\nsaturation\nhorizon\n(m)",
        breaks = c(-Inf, -500, -200, -100, -50, -20, 0, 20, 50, 100, 200, 500, Inf)
      ) +
      labs(title = paste("Saturation threshold:", i_sat_level))
  )
}

dev.off()

pdf(
  here::here("output/volume_saturation_total_changes.pdf"),
  width = 10,
  height = 8
)

  print(
    acidification_volume %>%
      filter(sat_level %in% c(1,2)) %>%
      mutate(sat_level = as.factor(sat_level),
             tref = as.factor(tref)) %>% 
      ggplot(aes(tref, volume,col=sat_level)) +
      geom_point()+
      facet_wrap(basin~mineral, scales = "free")
  )

dev.off()

rm(acidification_saturation_horizon,
   acidification_saturation_horizon_levels,
   acidification_volume)

```


## Zonal sections

### Computation


```{r compute_zonal_mean_sections}

acidification_zonal <- acidification_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()



```


```{r compute_zonal_mean_sections_dCant_temp}

acidification_zonal_dCant_temp <- dCant_temp_trend %>%
  group_by(tref, driver) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()



```


```{r compute_zonal_mean_sections_buffer}

acidification_zonal_buffer <- buffer_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()

```


### Incremental changes

#### dCant + Temperature

```{r zonal_dcant_temp_change}

acidification_zonal_dCant_temp <-
  acidification_zonal_dCant_temp %>%
  select(-contains("_sd")) %>% 
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))

# create pdf document

pdf(
  here::here("output/zonal_mean_sections_dCant_temp_changes.pdf"),
  width = 20,
  height = 6
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[10]
  
  # subset OIA variable
  
  i_acidification_zonal_dCant_temp <-
    acidification_zonal_dCant_temp %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_zonal_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_zonal_dcant_temp <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_dCant_temp %>% 
        filter(driver == "dCant + temp"),
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = "Driver: dCant + temp",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)
  
  p_zonal_dcant <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_dCant_temp %>% 
        filter(driver == "dCant"),
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = "Driver: dCant",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)

  p_decadal_offset <-
    i_acidification_zonal_dCant_temp %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, driver, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = "Decadal difference",
      subtitle_text = NULL
    ) +
    facet_grid(driver ~ basin_AIP)

  p_temperature_offset <-
    i_acidification_zonal_dCant_temp %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, driver, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant + temp` - `dCant`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = "Driver difference",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)
  
  print(
    wrap_plots(
      p_zonal_dcant &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_zonal_dcant_temp &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_decadal_offset,
      p_temperature_offset,
      ncol = 2
    )
  )
  
}

dev.off()

rm(acidification_zonal_dCant_temp)

```

#### dCant

```{r zonal_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_zonal_incremental <-
  acidification_zonal %>%
  select(MLR_basins:basin_AIP,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_zonal_uncertainty <-
  acidification_zonal_incremental %>%
  mutate(lat = as.numeric(as.character(cut(
    lat, seq(-90, 90, 10), seq(-85, 85, 10)
  ))),
  depth = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  )))
  ) %>%
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean)) %>%
  ungroup()

# compute uncertainty

acidification_zonal_uncertainty <-
  additive_uncertainty(acidification_zonal_uncertainty)

delta_acidification_zonal_uncertainty <- acidification_zonal_uncertainty[[3]]
acidification_zonal_uncertainty <- acidification_zonal_uncertainty[[1]]


# subset reference reconstruction

acidification_zonal_incremental <-
  acidification_zonal_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/zonal_mean_sections_incremental_changes.pdf"),
  width = 12,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_incremental <-
    acidification_zonal_incremental %>%
    filter(variable == i_var,
           depth <= 3000)
  
  i_acidification_zonal_uncertainty = acidification_zonal_uncertainty %>%
    filter(variable == i_var,
           depth <= 3000)

  i_delta_acidification_zonal_uncertainty = delta_acidification_zonal_uncertainty %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_zonal_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_zonal_dec <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_incremental,
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_single == 0),
      aes(lat, depth),
      shape = 20,
      size = 1,
      col = "grey"
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_double == 0),
      aes(lat, depth),
      shape = 20,
      size = 0.1,
      col = "grey"
    ) +
    facet_grid(tref ~ basin_AIP)

  
  
  
  p_zonal_offset <-
    i_acidification_zonal_incremental %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = NULL,
      subtitle_text = NULL
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_single == 0),
      aes(lat, depth),
      shape = 20,
      size = 1
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_double == 0),
      aes(lat, depth),
      shape = 20,
      size = 0.1
    ) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_zonal_dec &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_zonal_offset,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_incremental,
   acidification_zonal_uncertainty,
   delta_acidification_zonal_uncertainty
   )

```

### Total changes


```{r zonal_total_change}

# subset total change sections

acidification_zonal_total <-
  acidification_zonal %>%
  select(tref:basin_AIP,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_zonal_total <-
  acidification_zonal_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/zonal_mean_sections_total_changes.pdf"),
  width = 10,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_total <-
    acidification_zonal_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_total,
      var = "delta_total",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_total,
      aes(lat, depth, z = delta_total),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_total %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = delta_total,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_total,
   i_acidification_zonal_total)

```



```{r zonal_total_change_buffer}

# subset total change sections

acidification_zonal_buffer_total <-
  acidification_zonal_buffer %>%
  select(tref:basin_AIP,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_zonal_buffer_total <-
  acidification_zonal_buffer_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/zonal_mean_sections_total_changes_buffer.pdf"),
  width = 10,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables) {
  # i_var <- buffer_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_buffer_total <-
    acidification_zonal_buffer_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_buffer_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_buffer_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_buffer_total,
      var = "delta_total",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_buffer_total,
      aes(lat, depth, z = delta_total),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_buffer_total %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = delta_total,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_buffer_total,
   i_acidification_zonal_buffer_total)

```


### Absolute state

```{r zonal_absolute_state}

# subset absolute value sections

acidification_zonal_absolute <-
  acidification_zonal %>%
  select(tref:basin_AIP,
         contains("_mean"),
         -contains(c("_sd", "_delta")))

acidification_zonal_absolute <-
  acidification_zonal_absolute %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))

# create pdf document

pdf(
  here::here("output/zonal_mean_sections_absolute_state.pdf"),
  width = 8,
  height = 8
)
# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_absolute <-
    acidification_zonal_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_absolute,
      var = "mean",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_absolute,
      aes(lat, depth, z = mean),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_absolute %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = mean,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()


rm(acidification_zonal_absolute,
   acidification_zonal,
   i_acidification_zonal_absolute)

```


```{r zonal_absolute_state_buffer}

# subset absolute value sections

acidification_zonal_buffer_absolute <-
  acidification_zonal_buffer %>%
  select(tref:basin_AIP,
         contains("_mean"),
         -contains(c("_sd", "_delta")))

acidification_zonal_buffer_absolute <-
  acidification_zonal_buffer_absolute %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))

# create pdf document

pdf(
  here::here("output/zonal_mean_sections_absolute_state_buffer.pdf"),
  width = 8,
  height = 8
)
# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables) {
  # i_var <- buffer_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_buffer_absolute <-
    acidification_zonal_buffer_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_buffer_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_buffer_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_buffer_absolute,
      var = "mean",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_buffer_absolute,
      aes(lat, depth, z = mean),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_buffer_absolute %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = mean,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()


rm(acidification_zonal_buffer_absolute,
   acidification_zonal_buffer,
   i_acidification_zonal_buffer_absolute)

```



## Global sections

### Computation

```{r compute_global_sections}

acidification_global_section <- acidification_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_section_global_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()

```

### Incremental changes

```{r global_section_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_global_section_incremental <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_global_section_uncertainty <-
  acidification_global_section_incremental %>%
  mutate(dist = as.numeric(as.character(cut(
    dist, seq(0, 50, 1), seq(0.5, 49.5, 1)
  ))),
  depth = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  )))) %>%
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean)) %>%
  ungroup()

# compute uncertainty

acidification_global_section_uncertainty <-
  additive_uncertainty(acidification_global_section_uncertainty)

delta_acidification_global_section_uncertainty <- acidification_global_section_uncertainty[[3]]
acidification_global_section_uncertainty <- acidification_global_section_uncertainty[[1]]


# subset reference reconstruction

acidification_global_section_incremental <-
  acidification_global_section_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/global_sections_incremental_changes.pdf"),
  width = 10,
  height = 12
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_global_section_incremental <-
    acidification_global_section_incremental %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_global_section_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_global_section_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_global_section_dec1 <-
    i_acidification_global_section_incremental %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "delta_interval",
      legend_title = i_var,
      title_text = "A   1994 - 2004",
      df_uncertainty = acidification_global_section_uncertainty %>%
        filter(tref == 2004,
               variable == i_var),
      breaks = breaks,
      col_uncertainty = "grey",
      subtitle_text = NULL,
      plot_slabs = "n"
    ) &
    theme(axis.title.x = element_blank(),
          axis.text.x.bottom = element_blank())
  
  p_global_section_dec2 <-
    i_acidification_global_section_incremental %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "delta_interval",
      title_text = "B   2004 - 2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      df_uncertainty = acidification_global_section_uncertainty %>%
        filter(tref == 2014,
               variable == i_var),
      col_uncertainty = "grey",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  p_global_section_offset <-
    i_acidification_global_section_incremental %>%
    arrange(depth, dist) %>%
    select(depth, dist, tref, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_global(
      var = "delta_delta_interval",
      legend_title = paste("delta\n", i_var),
      df_uncertainty = delta_acidification_global_section_uncertainty %>%
        filter(variable == i_var),
      plot_slabs = "n",
      col = "div",
      title_text = "C   Decadal difference",
      subtitle_text = NULL
    )
  
  print(
    wrap_plots(
      p_global_section_dec1,
      p_global_section_dec2 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_offset &
        theme(axis.text.x.top = element_blank()),
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_global_section_incremental,
   acidification_global_section_uncertainty,
   delta_acidification_global_section_uncertainty
   )

```

### Total changes


```{r global_section_total_change}

# subset total change sections

acidification_global_section_total <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_global_section_total <-
  acidification_global_section_total %>%
  # filter(MLR_basins == MLR_basins_reference,
  #        Version_ID_group == Version_ID_group_reference) %>%
  # select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/global_sections_total_changes.pdf"),
  width = 10,
  height = 12
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_global_section_total <-
    acidification_global_section_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_global_section_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_global_section_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_global_section_period1 <-
    i_acidification_global_section_total %>%
    filter(tref == 1994) %>%
    p_section_global(
      var = "delta_total",
      legend_title = i_var,
      title_text = "A   1800 - 1994",
      breaks = NULL,
      subtitle_text = NULL,
      plot_slabs = "n"
    ) &
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          axis.text.x.bottom = element_blank())
  
  p_global_section_period2 <-
    i_acidification_global_section_total %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "delta_total",
      legend_title = paste("delta\n", i_var),
      title_text = "B   1800 - 2004",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    )
  
  p_global_section_period3 <-
    i_acidification_global_section_total %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "delta_total",
      legend_title = i_var,
      title_text = "C   1800 - 2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  
  print(
    wrap_plots(
      p_global_section_period1,
      p_global_section_period2 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_period3 &
        theme(axis.text.x.top = element_blank()),
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_global_section_total,
   i_acidification_global_section_total)

```

### Absolute state

```{r global_section_absolute_state}

# subset absolute value sections

acidification_global_section_absolute <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_mean"),
         -contains(c("_sd", "_delta")))


# subset reference reconstruction

# acidification_global_section_absolute %>% 
#   distinct(tref, MLR_basins, Version_ID_group)

acidification_global_section_absolute <-
  acidification_global_section_absolute %>%
  # filter(MLR_basins == MLR_basins_reference,
  #        Version_ID_group == Version_ID_group_reference) %>%
  # select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))


# create pdf document

pdf(
  here::here("output/global_sections_absolute_state.pdf"),
  width = 10,
  height = 16
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_global_section_absolute <-
    acidification_global_section_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_global_section_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(.02), names = FALSE)
  
  high <- i_acidification_global_section_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(.98), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = 10), Inf)
  
  p_global_section_period1 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 1800) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "A   1800",
      breaks = breaks,
      subtitle_text = NULL,
      plot_slabs = "n"
    ) &
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          axis.text.x.bottom = element_blank())
  
  p_global_section_period2 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 1994) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "B   1994",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    )
  
  p_global_section_period3 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "C   2004",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  p_global_section_period4<-
    i_acidification_global_section_absolute %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "D   2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  
  print(
    wrap_plots(
      p_global_section_period1,
      p_global_section_period2 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_period3 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_period4 &
        theme(axis.text.x.top = element_blank()),
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_global_section_absolute,
   acidification_global_section,
   i_acidification_global_section_absolute)

```




## Profiles

### Computation

```{r compute_mean_profiles_total_acidification}

# join with 3D acidification fields

acidification_profiles <-
  full_join(basinmask,
            acidification_trend %>%
              select(-c(basin_AIP, MLR_basins, Version_ID_group, contains("temp")))) %>%
  drop_na() %>%
  relocate(tref)

# scale values to surface area

acidification_profiles <- acidification_profiles %>% 
  mutate(across(gamma:H_free_delta_interval,
                ~ . * area))

# calculate regional means

acidification_profiles_regional <- acidification_profiles %>%
  group_by(tref, basin, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

acidification_profiles_global <- acidification_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
acidification_profiles <-
  bind_rows(acidification_profiles_global,
            acidification_profiles_regional)
  
rm(acidification_profiles_regional,
   acidification_profiles_global)


# rename basins

acidification_profiles <- acidification_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

acidification_profiles <- acidification_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_temperature_trend}


# join with 3D acidification fields

dCant_temp_profiles <-
  full_join(basinmask,
            dCant_temp_trend)

# scale values to surface area

dCant_temp_profiles <- dCant_temp_profiles %>% 
  mutate(across(contains("_delta_interval"),
                ~ . * area))

# calculate regional means

dCant_temp_profiles_regional <- dCant_temp_profiles %>%
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

dCant_temp_profiles_global <- dCant_temp_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
dCant_temp_profiles <-
  bind_rows(dCant_temp_profiles_global,
            dCant_temp_profiles_regional)
  
rm(dCant_temp_profiles_regional,
   dCant_temp_profiles_global)


# rename basins

dCant_temp_profiles <- dCant_temp_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

dCant_temp_profiles <- dCant_temp_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_DIC_dCant_temperature_trend}


# join with 3D acidification fields

DIC_dCant_temp_profiles <-
  full_join(basinmask,
            DIC_dCant_temp_trend)

# scale values to surface area

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>% 
  mutate(across(contains("_delta_interval"),
                ~ . * area))

# calculate regional means

DIC_dCant_temp_profiles_regional <- DIC_dCant_temp_profiles %>%
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

DIC_dCant_temp_profiles_global <- DIC_dCant_temp_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
DIC_dCant_temp_profiles <-
  bind_rows(DIC_dCant_temp_profiles_global,
            DIC_dCant_temp_profiles_regional)
  
rm(DIC_dCant_temp_profiles_regional,
   DIC_dCant_temp_profiles_global)


# rename basins

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_buffer}


# join with 3D acidification fields

buffer_profiles <-
  full_join(basinmask,
            buffer_trend %>% select(-basin_AIP))

# scale values to surface area

buffer_profiles <- buffer_profiles %>% 
  mutate(across(gammaDIC:tco2_talk_ratio_delta_interval,
                ~ . * area))

# calculate regional means

buffer_profiles_regional <- buffer_profiles %>%
  group_by(tref, basin, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

buffer_profiles_global <- buffer_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
buffer_profiles <-
  bind_rows(buffer_profiles_global,
            buffer_profiles_regional)
  
rm(buffer_profiles_regional,
   buffer_profiles_global)


# rename basins

buffer_profiles <- buffer_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

buffer_profiles <- buffer_profiles %>%
  mutate(tref = as.factor(tref))

```

### Incremental changes

#### DIC + dCant + Temperature

```{r profiles_DIC_dCant_temp_change}


DIC_dCant_temp_profiles <-
  DIC_dCant_temp_profiles %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval"))


# create pdf document

pdf(
  here::here("output/profiles_DIC_dCant_temp_changes.pdf"),
  width = 14,
  height = 8
)

ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(data = DIC_dCant_temp_profiles, aes(delta_interval,
                                            depth,
                                            col = driver)) +
  scale_color_brewer(palette = "Dark2") +
  labs(y = "Depth (m)",
       title = "Incremental change from previous estimate") +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()

rm(DIC_dCant_temp_profiles, DIC_dCant_temp_profiles_min_max)


```


#### dCant + Temperature

```{r profiles_dCant_temp_change}


dCant_temp_profiles <-
  dCant_temp_profiles %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

dCant_temp_profiles_min_max <-
dCant_temp_profiles %>%
  pivot_wider(values_from = delta_interval,
              names_from = driver)
  
  
  
  
# create pdf document

pdf(
  here::here("output/profiles_dCant_temp_changes.pdf"),
  width = 14,
  height = 8
)

ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(data = dCant_temp_profiles, aes(delta_interval,
                                            depth,
                                            col = tref,
                                            linetype = driver)) +
  geom_ribbon(data = dCant_temp_profiles_min_max,
              aes(y = depth, xmin = dCant, xmax = `dCant + temp`,
                  fill = tref),
              alpha = 0.3) +
  scale_color_manual(values = c("#EE7733", "#009988")) +
  scale_fill_manual(values = c("#EE7733", "#009988")) +
  labs(y = "Depth (m)",
       title = "Incremental change from previous estimate") +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()

rm(dCant_temp_profiles, dCant_temp_profiles_min_max)


```


#### dCant

```{r profiles_incremental_change, eval=FALSE}

# create pdf document

pdf(
  here::here("output/profiles_incremental_changes.pdf"),
  width = 14,
  height = 8
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         MLR_basins,
         Version_ID_group,
         contains("_delta_interval")) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(tref %in% c(2004,2014),
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval")) %>% 
  ggplot(aes(
    delta_interval,
    depth,
    col = tref,
    group = interaction(tref, MLR_basins, Version_ID_group)
  )) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_manual(values = c("#EE7733", "#009988")) +
  labs(y = "Depth (m)",
       title = "Incremental change from previous estimate")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```


### Total changes


```{r profiles_total_change}

# create pdf document

pdf(
  here::here("output/profiles_total_changes.pdf"),
  width = 14,
  height = 8
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  filter(tref != 1800,
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>% 
  ggplot(aes(
    delta_total,
    depth,
    col = tref)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Total change since 1800")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")



dev.off()

# acidification_profiles_interval <-
#   acidification_profiles %>%
#   select(tref,
#          basin,
#          depth,
#          contains("_delta_interval")) %>%
#   pivot_longer(contains("_delta_interval"),
#                names_to = "variable",
#                values_to = "delta_interval") %>%
#   filter(tref != 1800,
#          depth <= 3000) %>%
#   mutate(variable = str_remove(variable, "_delta_interval"))
# # filter(basin == "Global",
# #        variable == "pCO2insitu")
# 
# acidification_profiles_total <-
#   acidification_profiles %>%
#   select(tref,
#          basin,
#          depth,
#          contains("_delta_total")) %>%
#   pivot_longer(contains("_delta_total"),
#                names_to = "variable",
#                values_to = "delta_total") %>%
#   filter(tref != 1800,
#          depth <= 3000) %>%
#   mutate(variable = str_remove(variable, "_delta_total"))
# # filter(basin == "Global",
# #        variable == "pCO2insitu")
# 
# 
# ggplot() +
#   geom_area(
#     data = acidification_profiles_interval,
#     aes(delta_interval,
#         depth,
#         fill = tref),
#     alpha = 0.5,
#     orientation = "y",
#     position = position_stack(reverse = TRUE)
#   ) +
#   geom_path(data = acidification_profiles_total,
#             aes(delta_total,
#                 depth,
#                 group = tref),
#             col = "grey20") +
#   scale_fill_viridis_d(option = "viridis") +
#   labs(y = "Depth (m)",
#        title = "Total change since 1800") +
#   scale_y_continuous(trans = trans_reverser("sqrt"),
#                      breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
#   coord_cartesian(expand = 0) +
#   theme(legend.title = element_blank(),
#         axis.title.x = element_blank()) +
#   facet_grid(basin ~ variable, scales = "free_x")


```


```{r profiles_total_change_buffer}

# create pdf document

pdf(
  here::here("output/profiles_total_changes_buffer.pdf"),
  width = 10,
  height = 8
)

buffer_profiles %>%
  select(tref,
         basin,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  filter(tref != 1800,
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>% 
  ggplot(aes(
    delta_total,
    depth,
    col = tref)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Total change since 1800")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")



dev.off()

```

### Absolute state

```{r profiles_absolute_state}


# create pdf document

pdf(
  here::here("output/profiles_absolute_state.pdf"),
  width = 14,
  height = 8
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         # MLR_basins,
         # Version_ID_group,
         all_of(OIA_variables[-8])) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = tref
  )) +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```



```{r profiles_absolute_state_buffer}


# create pdf document

pdf(
  here::here("output/profiles_absolute_state_buffer.pdf"),
  width = 10,
  height = 8
)

buffer_profiles %>%
  select(tref,
         basin,
         depth,
         gammaDIC:R,
         tco2_talk_ratio) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = tref
  )) +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```



# Write ouput

```{r write_output_files, eval=FALSE}

acidification_trend %>% 
  write_csv(paste0(path_OIA, "OIA.csv"))


acidification_layer %>% 
  write_csv(paste0(path_OIA, "OIA_layer.csv"))

acidification_zonal %>% 
  write_csv(paste0(path_OIA, "OIA_zonal.csv"))


acidification_global_section %>% 
  write_csv(paste0(path_OIA, "OIA_global_section.csv"))

acidification_profiles %>% 
  write_csv(paste0(path_OIA, "OIA_profiles.csv"))




```



