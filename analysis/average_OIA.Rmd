---
title: "OIA Averaging"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

# Libraries

```{r load_libraries_specific, include = FALSE}
library(patchwork)
library(khroma)
library(ggh4x)
library(colorspace)
library(stars)
library(seacarb)
library(ggtext)
library(ggnewscale)
library(lubridate)
library(ggrepel)
library(broom)
```



# Define labels and breaks

```{r define_labels_and_breaks_OIA_variables}

labels_breaks <- function(i_var) {
  if (i_var == "tco2") {
    i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    i_contour_level <- 50
    i_legend_title <- "ΔC<sub>ant</sub><br>(µmol kg<sup>-1</sup>)"
  }
  
  if (i_var == "pH") {
    i_breaks <- c(-Inf, seq(-0.12, 0, 0.02), Inf)
    i_contour_level <- -0.08
    i_legend_title <- "ΔpH<sub>T</sub>"
  }
  
  if (i_var == "OmegaAragonite") {
    i_breaks <- c(-Inf, seq(-0.8, 0, 0.1), Inf)
    i_contour_level <- -0.5
    i_legend_title <- "ΔΩ<sub>arag</sub>"
  }
  
  if (i_var == "SIR") {
    i_breaks <- c(-Inf, seq(-0.08, 0, 0.01), Inf)
    i_contour_level <- -0.05
    i_legend_title <- "ΔSIR"
  }
  
  if (i_var == "H_free") {
    i_breaks <- c(-Inf, seq(0, 3, 0.5), Inf)
    i_contour_level <- 2
    i_legend_title <-
      "ΔH<sup>+</sup><sub>free</sub><br>(nmol kg<sup>-1</sup>)"
  }
  
  if (i_var == "temp") {
    i_breaks <- c(-Inf, seq(-0.6, 0, 0.2), seq(0.2, 0.6, 0.2), Inf)
    i_contour_level <- 0
    i_legend_title <-
      "ΔT (°C)"
  }
  
  all_labels_breaks <- lst(i_breaks,
                           i_contour_level,
                           i_legend_title)
  
  return(all_labels_breaks)
  
}



x_axis_scales <-
  list(
    variable == "tco2" ~ scale_x_continuous(breaks = labels_breaks("tco2")$i_breaks[c(TRUE, FALSE)]),
    variable == "pH" ~ scale_x_continuous(breaks = labels_breaks("pH")$i_breaks[c(TRUE, FALSE)]),
    variable == "OmegaAragonite" ~ scale_x_continuous(breaks = labels_breaks("OmegaAragonite")$i_breaks[c(TRUE, FALSE)]),
    variable == "SIR" ~ scale_x_continuous(breaks = labels_breaks("SIR")$i_breaks[c(TRUE, FALSE)]),
    variable == "H_free" ~ scale_x_continuous(breaks = labels_breaks("H_free")$i_breaks[c(TRUE, FALSE)]),
    variable == "temp" ~ scale_x_continuous(breaks = labels_breaks("temp")$i_breaks[c(TRUE, FALSE)])
  )

x_axis_labels <-
  c(
    "tco2" = labels_breaks("tco2")$i_legend_title,
    "pH" = labels_breaks("pH")$i_legend_title,
    "OmegaAragonite" = labels_breaks("OmegaAragonite")$i_legend_title,
    "SIR" = labels_breaks("SIR")$i_legend_title,
    "H_free" = labels_breaks("H_free")$i_legend_title,
    "temp" = labels_breaks("temp")$i_legend_title
  )


contours <-
  tibble(
    contour =
      c(
        labels_breaks("tco2")$i_contour_level,
        labels_breaks("pH")$i_contour_level,
        labels_breaks("OmegaAragonite")$i_contour_level,
        labels_breaks("SIR")$i_contour_level,
        labels_breaks("H_free")$i_contour_level,
        labels_breaks("temp")$i_contour_level
      ),
    variable =
      c("tco2",
        "pH",
        "OmegaAragonite",
        "SIR",
        "H_free",
        "temp")
  )

```


```{r define_labels_and_breaks_OIA_variables_stations}

x_axis_labels_stations <-
  c(
    x_axis_labels[2:6],
    "pHstar"  =  "ΔpH<sub>T</sub>*",
    "OmegaAragonitestar" = "ΔΩ<sub>arag</sub>*",
    "SIRstar" = "ΔSIR*",
    "H_freestar" = "ΔH<sup>+</sup><sub>free</sub>*<br>(nmol kg<sup>-1</sup>)",
    "tco2" = "ΔC<sub>ant</sub> or ΔDIC<br>(µmol kg<sup>-1</sup>)",
    "tco2star" = "ΔC<sub>ant</sub> or ΔDIC*<br>(µmol kg<sup>-1</sup>)",
    "PO4" = "ΔPO<sub>4</sub><br>(µmol kg<sup>-1</sup>)",
    "sal" = "ΔSalinity",
    "Si" = "ΔSilicate<br>(µmol kg<sup>-1</sup>)",
    "talk" = "ΔTA<br>(µmol kg<sup>-1</sup>)"
  )

x_axis_labels_stations_absolute <-
  c(
    "pH"  =  "pH<sub>T</sub>",
    "pHstar"  =  "pH<sub>T</sub>*",
    "OmegaAragonite" = "Ω<sub>arag</sub>",
    "OmegaAragonitestar" = "Ω<sub>arag</sub>*",
    "SIR" = "SIR",
    "SIRstar" = "SIR*",
    "H_free" = "H<sup>+</sup><sub>free</sub><br>(nmol kg<sup>-1</sup>)",
    "H_freestar" = "H<sup>+</sup><sub>free</sub>*<br>(nmol kg<sup>-1</sup>)",
    "temp" = "T (°C)",
    "tco2" = "DIC<br>(µmol kg<sup>-1</sup>)",
    "tco2star" = "DIC*<br>(µmol kg<sup>-1</sup>)",
    "PO4" = "PO<sub>4</sub><br>(µmol kg<sup>-1</sup>)",
    "sal" = "Salinity",
    "Si" = "Silicate<br>(µmol kg<sup>-1</sup>)",
    "talk" = "TA<br>(µmol kg<sup>-1</sup>)"
  )

```


```{r define_labels_and_breaks_buffer_variables_addition}

labels_breaks_buffer_variables_addition <- function(i_var) {
  if (i_var == "pH") {
    i_breaks <- c(-Inf, seq(-0.0033, -0.0015, 0.0003), Inf)
    i_contour_level <- -0.0027
    i_legend_title <- "ΔpH<sub>T</sub>/ΔDIC<br>(/ µmol kg<sup>-1</sup>)"
  }
  
  if (i_var == "OmegaAragonite") {
    i_breaks <- c(-Inf, seq(-0.011, -0.005, 0.001), Inf)
    i_contour_level <- -0.007
    i_legend_title <-
      "ΔΩ<sub>arag</sub>/ΔDIC<br>(/ µmol kg<sup>-1</sup>)"
  }
  
  if (i_var == "SIR") {
    i_breaks <- c(-Inf, seq(-0.0017, -0.0007, 0.0002), Inf)
    i_contour_level <- -0.0009
    i_legend_title <- "ΔSIR/ΔDIC<br>(/ µmol kg<sup>-1</sup>)"
  }
  
  if (i_var == "H_free") {
    i_breaks <- c(-Inf, seq(-4.3, -1, 0.55), Inf)
    i_contour_level <- -3.2
    i_legend_title <-
      "ΔH<sup>+</sup><sub>free</sub>/ΔDIC<br>(nmol kg<sup>-1</sup> / µmol kg<sup>-1</sup>)"
  }
  
  all_labels_breaks <- lst(i_breaks,
                           i_contour_level,
                           i_legend_title)
  
  return(all_labels_breaks)
  
}


x_axis_scales_buffer_variables_addition <-
  list(
    variable == "pH" ~ scale_x_continuous(breaks = labels_breaks_buffer_variables_addition("pH")$i_breaks[c(TRUE, FALSE)]),
    variable == "OmegaAragonite" ~ scale_x_continuous(breaks = labels_breaks_buffer_variables_addition("OmegaAragonite")$i_breaks[c(TRUE, FALSE)]),
    variable == "SIR" ~ scale_x_continuous(breaks = labels_breaks_buffer_variables_addition("SIR")$i_breaks[c(TRUE, FALSE)]),
    variable == "H_free" ~ scale_x_continuous(breaks = labels_breaks_buffer_variables_addition("H_free")$i_breaks[c(TRUE, FALSE)])
  )

x_axis_labels_buffer_variables_addition <-
  c(
    "pH" = labels_breaks_buffer_variables_addition("pH")$i_legend_title,
    "OmegaAragonite" = labels_breaks_buffer_variables_addition("OmegaAragonite")$i_legend_title,
    "SIR" = labels_breaks_buffer_variables_addition("SIR")$i_legend_title,
    "H_free" = labels_breaks_buffer_variables_addition("H_free")$i_legend_title
  )


contours_buffer_variables_addition <-
  tibble(
    contour =
      c(
        labels_breaks_buffer_variables_addition("pH")$i_contour_level,
        labels_breaks_buffer_variables_addition("OmegaAragonite")$i_contour_level,
        labels_breaks_buffer_variables_addition("SIR")$i_contour_level,
        labels_breaks_buffer_variables_addition("H_free")$i_contour_level
      ),
    variable =
      c("pH",
        "OmegaAragonite",
        "SIR",
        "H_free")
  )

```


```{r define_labels_and_breaks_buffer_variables_addition_change}


labels_breaks_buffer_variables_addition_change <- function(i_var) {
  if (i_var == "pH") {
    i_breaks <- c(-Inf, seq(0, 8, 2), Inf)
    i_contour_level <- 4
    i_legend_title <- "Δ<sub>1900-2004</sub><br>ΔpH<sub>T</sub>/ΔDIC<br>(%)"
  }
  
  if (i_var == "OmegaAragonite") {
    i_breaks <- c(-Inf, seq(0,5,1), Inf)
    i_contour_level <- 2
    i_legend_title <-
      "Δ<sub>1900-2004</sub><br>ΔΩ<sub>arag</sub>/ΔDIC<br>(%)"
  }
  
  if (i_var == "SIR") {
    i_breaks <- c(-Inf, seq(0,5,1), Inf)
    i_contour_level <- 2
    i_legend_title <- "Δ<sub>1900-2004</sub><br>ΔSIR/ΔDIC<br>(%)"
  }
  
  if (i_var == "H_free") {
    i_breaks <- c(-Inf, seq(0,25,5), Inf)
    i_contour_level <- 10
    i_legend_title <-
      "Δ<sub>1900-2004</sub><br>ΔH<sup>+</sup><sub>free</sub>/ΔDIC<br>(%)"
  }
  
  all_labels_breaks <- lst(i_breaks,
                           i_contour_level,
                           i_legend_title)
  
  return(all_labels_breaks)
  
}

# 
# x_axis_scales_buffer_variables_addition <-
#   list(
#     variable == "pH" ~ scale_x_continuous(breaks = labels_breaks_buffer_variables_addition("pH")$i_breaks[c(TRUE, FALSE)]),
#     variable == "OmegaAragonite" ~ scale_x_continuous(breaks = labels_breaks_buffer_variables_addition("OmegaAragonite")$i_breaks[c(TRUE, FALSE)]),
#     variable == "SIR" ~ scale_x_continuous(breaks = labels_breaks_buffer_variables_addition("SIR")$i_breaks[c(TRUE, FALSE)]),
#     variable == "H_free" ~ scale_x_continuous(breaks = labels_breaks_buffer_variables_addition("H_free")$i_breaks[c(TRUE, FALSE)])
#   )
# 
# x_axis_labels_buffer_variables_addition <-
#   c(
#     "pH" = labels_breaks_buffer_variables_addition("pH")$i_legend_title,
#     "OmegaAragonite" = labels_breaks_buffer_variables_addition("OmegaAragonite")$i_legend_title,
#     "SIR" = labels_breaks_buffer_variables_addition("SIR")$i_legend_title,
#     "H_free" = labels_breaks_buffer_variables_addition("H_free")$i_legend_title
#   )
# 
# 
# contours_buffer_variables_addition <-
#   tibble(
#     contour =
#       c(
#         labels_breaks_buffer_variables_addition("pH")$i_contour_level,
#         labels_breaks_buffer_variables_addition("OmegaAragonite")$i_contour_level,
#         labels_breaks_buffer_variables_addition("SIR")$i_contour_level,
#         labels_breaks_buffer_variables_addition("H_free")$i_contour_level
#       ),
#     variable =
#       c("pH",
#         "OmegaAragonite",
#         "SIR",
#         "H_free")
#   )

```


```{r define_labels_and_breaks_buffer_variables, eval=FALSE}


labels_breaks_buffer_variables <- function(i_var) {
  if (i_var == "gammaDIC") {
    i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    i_contour_level <- 50
    i_legend_title <- "ΔC<sub>ant</sub><br>(µmol kg<sup>-1</sup>)"
  }
  
  if (i_var == "betaDIC") {
    i_breaks <- c(-Inf, seq(-0.12, 0, 0.02), Inf)
    i_contour_level <- -0.08
    i_legend_title <- "ΔpH<sub>T</sub>"
  }
  
  if (i_var == "omegaDIC") {
    i_breaks <- c(-Inf, seq(-0.8, 0, 0.1), Inf)
    i_contour_level <- -0.5
    i_legend_title <- "ΔΩ<sub>arag</sub>"
  }
  
  if (i_var == "R") {
    i_breaks <- c(-Inf, seq(-0.08, 0, 0.01), Inf)
    i_contour_level <- -0.05
    i_legend_title <- "ΔSIR"
  }
  
  if (i_var == "tco2_talk_ratio") {
    i_breaks <- c(-Inf, seq(0, 3, 0.5), Inf)
    i_contour_level <- 2
    i_legend_title <-
      "ΔH<sup>+</sup><sub>free</sub><br>(nmol kg<sup>-1</sup>)"
  }
  
  all_labels_breaks <- lst(i_breaks,
                           i_contour_level,
                           i_legend_title)
  
  return(all_labels_breaks)
  
}



x_axis_scales_buffer_variables <-
  list(
    variable == "tco2" ~ scale_x_continuous(breaks = labels_breaks("tco2")$i_breaks[c(TRUE, FALSE)]),
    variable == "pH" ~ scale_x_continuous(breaks = labels_breaks("pH")$i_breaks[c(TRUE, FALSE)]),
    variable == "OmegaAragonite" ~ scale_x_continuous(breaks = labels_breaks("OmegaAragonite")$i_breaks[c(TRUE, FALSE)]),
    variable == "SIR" ~ scale_x_continuous(breaks = labels_breaks("SIR")$i_breaks[c(TRUE, FALSE)]),
    variable == "H_free" ~ scale_x_continuous(breaks = labels_breaks("H_free")$i_breaks[c(TRUE, FALSE)])
  )

x_axis_labels_buffer_variables <-
  c(
    "tco2" = labels_breaks("tco2")$i_legend_title,
    "pH" = labels_breaks("pH")$i_legend_title,
    "OmegaAragonite" = labels_breaks("OmegaAragonite")$i_legend_title,
    "SIR" = labels_breaks("SIR")$i_legend_title,
    "H_free" = labels_breaks("H_free")$i_legend_title,
    "temp" = "ΔT (°C)"
  )


contours_buffer_variables <-
  tibble(
    contour =
      c(
        labels_breaks("tco2")$i_contour_level,
        labels_breaks("pH")$i_contour_level,
        labels_breaks("OmegaAragonite")$i_contour_level,
        labels_breaks("SIR")$i_contour_level,
        labels_breaks("H_free")$i_contour_level
      ),
    variable =
      c("tco2",
        "pH",
        "OmegaAragonite",
        "SIR",
        "H_free")
  )

```



# Read data

```{r define_paths_to_access_eMLR_files}

# only path_observations needs to be changed to model
path_observations <-
  paste0(path_root, "/observations/")

path_preprocessing    <-
  paste0(path_observations, "preprocessing/")

path_preprocessing_model    <-
  paste0(path_root, "/model/preprocessing/")

path_reccap2 <-
  "/nfs/kryo/work/updata/reccap2/"

path_ungrd_3d_ocn <- "/nfs/kryo/work/datasets/ungridded/interior/ocean"

path_out <-   paste0(path_observations, "output_publication/")
path_OIA <-   "/nfs/kryo/work/jenmueller/ocean_interior_acidification/"


```

## Basinmask

```{r select_basinmask_5}

basinmask <- basinmask %>% 
  filter(MLR_basins == "5") %>% 
  select(lon, lat, basin)

basinmask <- basinmask %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

basinmask_robin_raster <- rast(basinmask %>% 
                                 mutate(dist = 1) %>% 
                                 pivot_wider(names_from = basin,
                                            values_from = dist),
                               crs = "+proj=longlat")


basinmask_robin_raster <- project(basinmask_robin_raster, target_crs, method = "near")

basinmask_robin_tibble <- basinmask_robin_raster %>%
  as.data.frame(xy = TRUE, na.rm = FALSE) %>%
  as_tibble() %>%
  rename(lon = x, lat = y) %>%
  pivot_longer(cols = -c("lon", "lat"),
               names_to = "basin",
               values_to = "dist") %>%
  drop_na() %>% 
  mutate(basin = as.character(basin))

ggplot() +
  geom_raster(
    data = basinmask_robin_tibble,
    aes(
      x = lon,
      y = lat,
      fill = basin
    )
  ) +
  geom_sf(data = worldmap_trans, fill = "grey90", col = "grey90") +
  geom_sf(data = coastline_trans, linewidth = 0.3) +
  geom_sf(data = bbox_graticules_trans, linewidth = 0.5) +
  coord_sf(
    crs = target_crs,
    ylim = lat_lim,
    xlim = lon_lim,
    expand = FALSE
  ) +
  scale_fill_okabeito(reverse = TRUE)  +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_rect(colour = "transparent"),
    strip.background = element_blank()
  )

ggsave(
  here::here(
    paste0(
      "output/publication/map_basinmask.png"
    )
  ),
  width = 10,
  height = 3,
  dpi = 600,
  bg = "white"
)


# compute grid cell surface area

basinmask <- basinmask %>% 
    mutate(area = earth_surf(lat, lon))

```


## Biomemask

```{r read_biomemask}

biomemask <-
  read_ncdf(paste(path_reccap2, "RECCAP2_region_masks_all_v20220620.nc", sep = "")) %>%
  as_tibble()

biomemask <- biomemask %>%
  filter(seamask == 1) %>%
  select(lon, lat, atlantic:southern) %>%
  pivot_longer(atlantic:southern,
               names_to = "region",
               values_to = "value") %>%
  mutate(value = as.factor(value))

biomemask <- biomemask %>%
  filter(value != 0)

# assign biome label and select biomes

biomemask <- biomemask  %>% 
  mutate(biome = case_when(
    region == "atlantic" & value == "1" ~ "NA-SPSS",
    region == "atlantic" & value == "2" ~ "NA-STSS",
    region == "atlantic" & value == "3" ~ "NA-STPS",
    region == "atlantic" & value == "4" ~ "AEQU",
    region == "atlantic" & value == "5" ~ "SA-STPS",
    region == "atlantic" & value == "6" ~ "MED",
    region == "pacific" & value == "1" ~ "NP-SPSS",
    region == "pacific" & value == "2" ~ "NP-STSS",
    region == "pacific" & value == "3" ~ "NP-STPS",
    region == "pacific" & value == "4" ~ "PEQU-W",
    region == "pacific" & value == "5" ~ "PEQU-E",
    region == "pacific" & value == "6" ~ "SP-STSS",
    region == "indian" & value == "1" ~ "Arabian Sea",
    region == "indian" & value == "2" ~ "Bay of Bengal",
    region == "indian" & value == "3" ~ "Equatorial Indian",
    region == "indian" & value == "4" ~ "Southern Indian",
    region == "arctic" & value == "1" ~ "ARCTIC-ICE",
    region == "arctic" & value == "2" ~ "NP-ICE",
    region == "arctic" & value == "3" ~ "NA-ICE",
    region == "arctic" & value == "4" ~ "Barents",
    region == "southern" & value == "1" ~ "SO-STSS",
    region == "southern" & value == "2" ~ "SO-SPSS",
    region == "southern" & value == "3" ~ "SO-ICE",
    TRUE ~ "other"
  ))

biomemask <- biomemask  %>%
  mutate(
    biome_agg = case_when(
      biome %in% c("NA-SPSS", "NA-STSS") ~ "NA",
      biome %in% c("NP-SPSS", "NP-STSS") ~ "NP",
      biome %in% c(
        "NA-STPS",
        "SA-STPS",
        "NP-STPS",
        "SP-STSS",
        "PEQU-W",
        "Equatorial Indian",
        "Southern Indian",
        "SO-STSS"
      ) ~ "ST",
      biome %in% c("AEQU", "PEQU-E", "Arabian Sea", "Bay of Bengal") ~ "EQ",
      biome %in% c("SO-SPSS", "SO-ICE") ~ "SO",
      TRUE ~ "other"
    )
  ) %>% 
  select(-biome) %>% 
  rename(biome = biome_agg)

biomemask <- biomemask %>% 
  filter(biome != "other") %>% 
  select(-c(value, region))

biomemask_robin_raster <- rast(biomemask %>% 
                                 mutate(dist = 1) %>% 
                                 pivot_wider(names_from = biome,
                                            values_from = dist),
                               crs = "+proj=longlat")


biomemask_robin_raster <- project(biomemask_robin_raster, target_crs, method = "near")

biomemask_robin_tibble <- biomemask_robin_raster %>%
  as.data.frame(xy = TRUE, na.rm = FALSE) %>%
  as_tibble() %>%
  rename(lon = x, lat = y) %>%
  pivot_longer(cols = -c("lon", "lat"),
               names_to = "biome",
               values_to = "dist") %>%
  drop_na() %>% 
  mutate(biome = as.character(biome))

ggplot() +
  geom_raster(
    data = biomemask_robin_tibble,
    aes(
      x = lon,
      y = lat,
      fill = biome
    )
  ) +
  geom_sf(data = worldmap_trans, fill = "grey90", col = "grey90") +
  geom_sf(data = coastline_trans, linewidth = 0.3) +
  geom_sf(data = bbox_graticules_trans, linewidth = 0.5) +
  coord_sf(
    crs = target_crs,
    ylim = lat_lim,
    xlim = lon_lim,
    expand = FALSE
  ) +
  scale_fill_okabeito()  +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_rect(colour = "transparent"),
    strip.background = element_blank()
  )

ggsave(
  here::here(
    paste0(
      "output/publication/map_biomemask.png"
    )
  ),
  width = 10,
  height = 3,
  dpi = 600,
  bg = "white"
)

# compute grid cell surface area

biomemask <- biomemask %>% 
    mutate(area = earth_surf(lat, lon))

```



## List of files

```{r read_list_files}

all_files <- list.files(path_OIA) %>% 
  str_subset(".csv")

```

## 2002 climatologies

### OIA variables

```{r climatology_2002_Lauvset, eval=FALSE}

climatology <-
  read_csv(paste0(path_OIA, "OIA_DIC_climatology_none.csv"))

climatology <- climatology %>%
  select(-c(MLR_basins, Version_ID_group))

```


### buffer variables

```{r buffer_climatology_2002_Lauvset, eval=FALSE}

buffer_climatology <-
  read_csv(paste0(path_OIA, "buffer_DIC_climatology_none.csv"))

```

## Acidification estimates

### dCant driver

```{r read_OIA_data}

acidification_trend <-
  read_csv(paste0(path_OIA, "OIA_Standard case_3.csv"))

acidification_trend <- acidification_trend %>% 
  select(-c(MLR_basins, Version_ID_group))

acidification_trend <- acidification_trend %>% 
      mutate(H_free = 1e3 * H_free,
             H_free_delta_total = 1e3 * H_free_delta_total,
             H_free_delta_interval = 1e3 * H_free_delta_interval)

```


```{r OIA_variables}

OIA_variables <- 
  acidification_trend %>%
  select(contains("delta_total")) %>% 
  names() %>% 
  str_remove("_delta_total")

OIA_variables <- OIA_variables[-c(3,4,6,7)]


```

#### Buffer trends


```{r read_buffer_changes_DIC_addition}

# Load OIA estimates with 5 µmol/kg DIC added

buffer_trend <-
  read_csv(paste0(path_OIA, "OIA_Standard case_3_DIC_addition.csv"))

buffer_trend <- buffer_trend %>% 
  select(-c(MLR_basins, Version_ID_group))

buffer_trend <- buffer_trend %>%
  mutate(
    H_free = 1e3 * H_free,
    H_free_delta_total = 1e3 * H_free_delta_total,
    H_free_delta_interval = 1e3 * H_free_delta_interval
  )

# Join with standard OIA estimates
buffer_trend_addition <-
  full_join(
    buffer_trend %>%
      select(lon, lat, depth, tref, basin_AIP, contains(OIA_variables)) %>%
      select(-c(contains("delta"), "tco2", "tco2_talk_ratio", "phosphate")) %>%
      pivot_longer(pH:temp,
                   names_to = "variable",
                   values_to = "added"),
    acidification_trend %>%
      select(lon, lat, depth, tref, basin_AIP, contains(OIA_variables)) %>%
      select(-c(contains("delta"), "tco2", "tco2_talk_ratio", "phosphate")) %>%
      pivot_longer(pH:temp,
                   names_to = "variable",
                   values_to = "raw")
  )

rm(buffer_trend)

# compute OIA variable sensitivity to DIC addition
buffer_trend_addition <-
  buffer_trend_addition %>%
  mutate(sensitivity = (added - raw) / 5)

buffer_trend_addition <-
  buffer_trend_addition %>%
  select(-c(raw, added))

buffer_variables_addition <-
  buffer_trend_addition %>% 
  distinct(variable) %>% 
  pull

```


```{r read_buffer_changes_direct_estimates}

buffer_trend <-
  read_csv(paste0(path_OIA, "buffer_Standard case_3.csv"))

buffer_trend <- buffer_trend %>%
  select(-c(MLR_basins, Version_ID_group))

# merge tco2-talk-ratio into buffer variables

buffer_trend <-
  full_join(
    buffer_trend,
    acidification_trend %>% select(lon, lat, depth, tref, basin_AIP,
                                   contains("tco2_talk"))
  )

buffer_trend <- buffer_trend %>% 
  select(-contains("delta")) %>% 
  pivot_longer(-c(lon:tref, basin_AIP),
               names_to = "variable",
               values_to = "sensitivity")


buffer_variables <-
  buffer_trend %>% 
  distinct(variable) %>% 
  pull


```

### Temperature driver

```{r read_OIA_temperature_driven}

temperature_trend <-
  read_csv(paste0(path_OIA, "OIA_dCant + temp_3.csv"))

temperature_trend <- temperature_trend %>%
  select(-c(MLR_basins, Version_ID_group))

temperature_trend <- temperature_trend %>%
  mutate(
    H_free = 1e3 * H_free,
    H_free_delta_total = 1e3 * H_free_delta_total,
    H_free_delta_interval = 1e3 * H_free_delta_interval
  )

# create joined coordinate grid

dCant_temp_trend_depth_grid <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref),
    temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

# reduce data to joined coordinate grid

dCant_trend <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta")),
    dCant_temp_trend_depth_grid
  )

temperature_trend <-
  inner_join(
    temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta")),
    dCant_temp_trend_depth_grid
  )

# join relevant data sets

dCant_temp_trend <-
  bind_rows(dCant_trend %>%
              mutate(driver = "dCant"),
            temperature_trend %>%
              mutate(driver = "dCant + temp"))

rm(temperature_trend,
   dCant_trend,
   dCant_temp_trend_depth_grid)

```

### DIC driver

#### Interior (MOBO-DIC)

```{r read_OIA_DIC_driven_interior}

DIC_trend <-
  read_csv(paste0(path_OIA, "OIA_DIC_3.csv"))

DIC_trend <- DIC_trend %>%
  select(-c(MLR_basins, Version_ID_group))

DIC_trend <- DIC_trend %>%
  mutate(
    H_free = 1e3 * H_free,
    H_free_delta_total = 1e3 * H_free_delta_total,
    H_free_delta_interval = 1e3 * H_free_delta_interval
  )

DIC_temperature_trend <-
  read_csv(paste0(path_OIA, "OIA_DIC + temp_3.csv"))

DIC_temperature_trend <- DIC_temperature_trend %>%
  select(-c(MLR_basins, Version_ID_group))

DIC_temperature_trend <- DIC_temperature_trend %>%
  mutate(
    H_free = 1e3 * H_free,
    H_free_delta_total = 1e3 * H_free_delta_total,
    H_free_delta_interval = 1e3 * H_free_delta_interval
  )

# create joined coordinate grid

dCant_DIC_temp_trend_depth_grid <-
  inner_join(
    DIC_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref),
    DIC_temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

dCant_DIC_temp_trend_depth_grid <-
  inner_join(
    dCant_DIC_temp_trend_depth_grid,
    dCant_temp_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

# reduce data to joined coordinate grid

DIC_trend <-
  inner_join(
    DIC_trend %>%
      filter(tref %in% c(2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_DIC_temp_trend_depth_grid
  )

DIC_temperature_trend <-
  inner_join(
    DIC_temperature_trend %>%
      filter(tref %in% c(2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_DIC_temp_trend_depth_grid
  )

dCant_temp_trend_temporary <-
  inner_join(
    dCant_temp_trend %>%
      filter(tref %in% c(2014)) %>%
      select(
        lon,
        lat,
        depth,
        tref,
        driver,
        basin_AIP,
        contains("delta_interval")
      ),
    dCant_DIC_temp_trend_depth_grid
  )

# join relevant data sets

dCant_DIC_temp_trend <-
  bind_rows(
    DIC_trend %>%
      mutate(driver = "DIC"),
    DIC_temperature_trend %>%
      mutate(driver = "DIC + temp"),
    dCant_temp_trend_temporary
  )

rm(
  DIC_trend,
  DIC_temperature_trend,
  dCant_temp_trend_temporary,
  dCant_DIC_temp_trend_depth_grid
)


```

#### Surface (OceanSODA)

```{r read_OIA_DIC_driven_surface, eval=FALSE}

DIC_surface_trend <-
  read_csv(paste0(path_OIA, "OIA_OceanSODA DIC_3.csv"))

DIC_surface_trend <- DIC_surface_trend %>%
  select(-c(MLR_basins, Version_ID_group))

# create joined coordinate grid

dCant_DIC_surface_trend_depth_grid <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref),
    DIC_surface_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

# reduce data to joined coordinate grid

dCant_trend <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_DIC_surface_trend_depth_grid
  )

DIC_surface_trend <-
  inner_join(
    DIC_surface_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_DIC_surface_trend_depth_grid
  )

# join relevant data sets

dCant_DIC_surface_trend <-
  bind_rows(dCant_trend %>%
              mutate(driver = "dCant"),
            DIC_surface_trend %>%
              mutate(driver = "DIC surface"))

rm(DIC_surface_trend,
   dCant_trend,
   dCant_DIC_surface_trend_depth_grid)

```

## Time series stations

```{r read_SPOTS}

col_names <-
  names(read_csv(
    paste0(path_ungrd_3d_ocn, "/spots/TS_product_20230619.csv"),
    n_max = 0
  ))

TS_product <-
  read_csv(
    paste0(path_ungrd_3d_ocn, "/spots/TS_product_20230619.csv"),
    col_names = col_names,
    skip = 2
  )

rm(col_names)

var_select <-
  c("CTDSAL",
    "CTDTMP",
    "TCARBN",
    "ALKALI",
    "PH_TOT",
    "PHSPHT",
    "SILCAT")

TS_product <- TS_product %>%
  select(
    station = TimeSeriesStation,
    station_nr = STNNBR,
    date = DATE,
    lat = LATITUDE,
    lon = LONGITUDE,
    depth = CTDPRS,
    all_of(contains(var_select))
  ) %>% 
  select(-contains(c("_P", "_A")))

for (i_var in var_select) {
  # i_var <- "CTDTMP"
  
  i_TS_product <- TS_product %>%
    select(station:depth,
           all_of(contains(i_var)))
  
  i_TS_product <- i_TS_product %>%
    filter(!!sym(i_var) != -999)

  if (i_var != "CTDTMP" & i_var != "CTDSAL") {
    i_TS_product <- i_TS_product %>%
      filter(!!sym(paste0(i_var, "_FLAG_W")) == 2,
             !!sym(paste0(i_var, "_BPf")) == 1)
  }
  
  if (i_var == "CTDSAL") {
    i_TS_product <- i_TS_product %>%
      filter(!!sym(paste0(i_var, "_FLAG_W")) == 2)
  }
  
  i_TS_product <- i_TS_product %>%
    select(station:depth, all_of(i_var)) %>% 
    mutate(name = i_var) %>% 
    rename(value = all_of(i_var))
  
  
  if (exists("TS_product_all")) {
    TS_product_all <-
      bind_rows(TS_product_all,
                i_TS_product)
  }
  
  if (!exists("TS_product_all")) {
    TS_product_all <- i_TS_product
  }
  
}

TS_product <- TS_product_all
rm(i_var, i_TS_product, TS_product_all)

TS_product <- TS_product %>%
  mutate(
    name = case_when(
      name ==  "CTDTMP" ~ "temp",
      name ==  "CTDSAL" ~ "sal",
      name ==  "TCARBN" ~ "tco2",
      name ==  "ALKALI" ~ "talk",
      name ==  "PH_TOT" ~ "pH",
      name ==  "PHSPHT" ~ "PO4",
      name ==  "SILCAT" ~ "Si"
    )
  )

TS_product <- TS_product %>%
  mutate(
    date = as.Date(as.character(date), "%Y%m%d"),
    year = year(date),
    month = month(date)
  )

TS_product <- TS_product %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

TS_product <- TS_product %>% 
  mutate(depth = if_else(depth <= 0, 0.01, depth))


```

```{r subset_ALOHA_from_TS_product}

ALOHA <-
  TS_product %>%
  filter(station == "ALOHA",
         name != "pH")

ALOHA %>%
  filter(between(depth,400,700)) %>% 
  ggplot(aes(value, depth, col = year)) +
  geom_point(alpha = 0.4) +
  scale_color_viridis_c() +
  scale_y_reverse() +
  # scale_y_continuous(trans = trans_reverser("sqrt")) +
  facet_wrap( ~ name, scales = "free_x") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())

depth_limits_shallow <- c(0,10, 20,30, 40,50, 70,80, 90,110, 145,155, 195,205, 240,260, 340,360, 480,520)
depth_labels_shallow <- c(5,NA, 25,NA, 45,NA, 75,NA, 100,NA, 150,NA,  200,NA,  250,NA,  350,NA,  500, NA) 

depth_limits_deep <- c(550,650, 1010,1030, 1990,2010, 2990,3010, 4490,4510)
depth_labels_deep <- c(600,NA,  1020, NA,  2000,NA,   3000,NA,   4500) 

depth_limits <- c(depth_limits_shallow, depth_limits_deep)
depth_labels <- c(depth_labels_shallow, depth_labels_deep)

ALOHA <-
  ALOHA %>%
  mutate(depth_int = cut(depth, depth_limits, depth_labels),
         depth_int = as.numeric(as.character(depth_int)))

rm(depth_limits_shallow, depth_limits_deep,
   depth_labels_shallow, depth_labels_deep)


ALOHA %>%
  ggplot(aes(value, depth, col = year)) +
  geom_point(aes(col = year), size = 1, alpha = 0.5) +
  scale_color_viridis_c() +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = depth_labels) +
  facet_wrap(~ name, scales = "free_x") +
  theme_bw() +
  labs(y = "Depth (m)",
       title = "ALOHA | all observations") +
  coord_cartesian(expand = FALSE) +
  theme(panel.grid.minor = element_blank(),
        axis.title.x = element_blank())


ALOHA %>%
  filter(name == "tco2") %>%
  mutate(selection = if_else(is.na(depth_int), "discarded", "used")) %>%
  ggplot(aes(value, depth)) +
  geom_point(aes(col = year), size = 1, alpha = 0.5) +
  scale_color_viridis_c() +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = depth_labels) +
  facet_grid(~ selection, scales = "free_y") +
  theme_bw() +
  labs(x = expression(DIC~(µmol~kg^{-1})),
       y = "Selected depth levels (m)",
       title = "ALOHA | data selection and binning") +
  coord_cartesian(expand = FALSE) +
  theme(panel.grid.minor = element_blank())


ggsave(
  here::here("output/all_variables/ALOHA_tco2_all_data_profiles.pdf"),
  width = 8,
  height = 8
)

ALOHA <-
  ALOHA %>%
  filter(!is.na(depth_int))


```


```{r read_BATS}

col_names <-
  read_delim(
    paste0(path_ungrd_3d_ocn, "/bats/bats_bottle.txt"),
    delim = ",",
    skip = 58,
    n_max = 0,
    trim_ws = TRUE
  ) %>%
  names()

BATS <- read_delim(
  paste0(path_ungrd_3d_ocn, "/bats/bats_bottle.txt"),
  delim = "\t",
  col_names = col_names,
  skip = 59,
  trim_ws = TRUE)

rm(col_names)

BATS <- BATS %>% 
  select(station_nr = Id,
         date = yyyymmdd,
         lat = latN,
         lon = lonW,
         depth = Depth,
         temp = Temp,
         sal = CTD_S,
         tco2 = CO2,
         talk = Alk,
         PO4 = PO41,
         Si = Si1,
         QF) %>% 
  mutate(station = "BATS")


BATS <- BATS %>% 
  filter(QF == 2) %>% 
  select(-QF)

BATS <- BATS %>% 
  pivot_longer(temp:Si) %>% 
  filter(value != -999)

BATS <-
  BATS %>%
  mutate(
    date = as.Date(as.character(date), "%Y%m%d"),
    year = year(date),
    month = month(date)
  )

BATS <-
  BATS %>%
  mutate(lon = -lon,
         lon = if_else(lon < 20, lon + 360, lon))

BATS %>%
  filter(between(depth,0,750)) %>% 
  ggplot(aes(value, depth, col = year)) +
  geom_point(alpha = 0.4) +
  scale_color_viridis_c() +
  scale_y_reverse() +
  # scale_y_continuous(trans = trans_reverser("sqrt")) +
  facet_wrap( ~ name, scales = "free_x") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())

depth_limits_shallow <- c(0,7.5,12.5, 17.5,22.5, 37.5,42.5, 57.5,62.5, 77.5,82.5, 97.5,102.5)
depth_labels_shallow <- c(3,10,NA,    20,NA,     40,NA,     60,NA,     80,NA,     100,NA) 

depth_limits_mid <- c(115,125, 135,145, 155,165, 190,210, 240,260, 290,310, 390,410)
depth_labels_mid <- c(120,NA,  140,NA,  160,NA,  200,NA,  250,NA,  300,NA,  400,NA) 

depth_limits_deep_1000 <- c(490,510, 590,610, 690,710, 790,810, 890,910, 990,1010)
depth_labels_deep_1000 <- c(500,NA,  600,NA,  700,NA,  800,NA,  800,NA,  1000,NA) 

depth_limits_deep_2000 <- c(1080,1120, 1180,1220, 1280,1320, 1380,1420, 1580,1620, 1780,1820, 1980,2020)
depth_labels_deep_2000 <- c(1100,NA,   1200,NA,   1300,NA,   1400,NA,   1600,NA,   1800,NA,   2000,NA) 

depth_limits_deep_4000 <- c(2180,2220, 2380,2420, 2580,2620, 2980,3020, 3380,3420, 3780,3820, 3980,4020)
depth_labels_deep_4000 <- c(2200,NA,   2400,NA,   2600,NA,   3000,NA,  3400,NA,   3800,NA,   4000,NA) 

depth_limits_deep_5000 <- c(4180,4220, 4490,4570)
depth_labels_deep_5000 <- c(4200,NA,   4520) 

depth_limits <-
  c(
    depth_limits_shallow,
    depth_limits_mid,
    depth_limits_deep_1000,
    depth_limits_deep_2000,
    depth_limits_deep_4000,
    depth_limits_deep_5000
  )

depth_labels <-
  c(
    depth_labels_shallow,
    depth_labels_mid,
    depth_labels_deep_1000,
    depth_labels_deep_2000,
    depth_labels_deep_4000,
    depth_labels_deep_5000
  )

BATS <-
  BATS %>%
  mutate(depth_int = cut(depth, depth_limits, depth_labels),
         depth_int = as.numeric(as.character(depth_int)))


rm(
  depth_limits_shallow,
  depth_limits_mid,
  depth_limits_deep_1000,
  depth_limits_deep_2000,
  depth_limits_deep_4000,
  depth_limits_deep_5000
)

rm(
  depth_labels_shallow,
  depth_labels_mid,
  depth_labels_deep_1000,
  depth_labels_deep_2000,
  depth_labels_deep_4000,
  depth_labels_deep_5000
)


BATS %>%
  ggplot(aes(value, depth, col = year)) +
  geom_point(aes(col = year), size = 1, alpha = 0.5) +
  scale_color_viridis_c() +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = depth_labels) +
  facet_wrap(~ name, scales = "free_x") +
  theme_bw() +
  labs(y = "Depth (m)",
       title = "BATS | all observations") +
  coord_cartesian(expand = FALSE) +
  theme(panel.grid.minor = element_blank(),
        axis.title.x = element_blank())


BATS %>%
  filter(name == "tco2") %>%
  mutate(selection = if_else(is.na(depth_int), "discarded", "used")) %>%
  ggplot(aes(value, depth)) +
  geom_point(aes(col = year), size = 1, alpha = 0.5) +
  scale_color_viridis_c() +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = depth_labels) +
  facet_grid(~ selection, scales = "free_y") +
  theme_bw() +
  labs(x = expression(DIC~(µmol~kg^{-1})),
       y = "Selected depth levels (m)",
       title = "BATS | data selection and binning") +
  coord_cartesian(expand = FALSE) +
  theme(panel.grid.minor = element_blank())

ggsave(
  here::here("output/all_variables/BATS_tco2_all_data_profiles.pdf"),
  width = 8,
  height = 8
)


TS_product <-
  bind_rows(TS_product,
            BATS %>% select(-depth_int))

BATS <-
  BATS %>%
  filter(!is.na(depth_int))

```

```{r TS_product_incl_BATS}

TS_product_gridded <-
  TS_product %>%
  filter(name %in% c("tco2", "talk", "pH"),
         # station %in% c(),
         depth <= 3000) %>%
  mutate(depth_int = cut(
    depth,
    seq(0, 1e4, 500),
    labels = paste(seq(0, 9500, 500),seq(500, 10000, 500), sep = "-"),
    include.lowest = TRUE
  ))

stations_deep <- TS_product_gridded %>% 
  filter(depth_int == "500-1000") %>%
  distinct(station) %>% 
  pull()

TS_product_gridded %>% 
  filter(station %in% stations_deep) %>% 
  count(depth_int, year, name, station) %>% 
  ggplot(aes(year, n, col = name)) +
  geom_path() +
  geom_point(size = 0.5) +
  labs(y = "Nr observations (yr-1)") +
  scale_x_continuous(breaks = c(2000,2020)) +
  facet_grid(depth_int ~ station,
             scales = "free_y")

ggsave(
  here::here("output/all_variables/BATS_ALOHA_other_stations_data_availability.pdf"),
  width = 14,
  height = 8
)

rm(stations_deep, TS_product_gridded)


TS_product_stations <- 
TS_product %>% 
  group_by(station) %>%
  summarise(lat = mean(lat),
            lon = mean(lon),
            n = n()) %>% 
  ungroup()

map +
  geom_point(data = TS_product_stations,
             aes(lon, lat, size = n),
             alpha = 0.5,
             col = "red") +
  geom_label_repel(data = TS_product_stations,
             aes(lon, lat, label = station),
             size = 3,
             label.padding = 0.2,
             min.segment.length = 0) +
  scale_size_area() +
  theme(axis.ticks = element_blank(),
        axis.text = element_blank())

ggsave(
  here::here("output/all_variables/BATS_ALOHA_other_stations_map.pdf"),
  width = 14,
  height = 8
)

rm(TS_product_stations)

```


```{r trend_analysis_observations}

TS_product <-
  bind_rows(ALOHA,
            BATS)

TS_product <- TS_product %>%
  group_by(across(-value)) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  ungroup() %>%
  pivot_wider(names_from = name,
              values_from = value) %>%
  filter(!is.na(tco2),
         !is.na(talk),
         !is.na(sal),
         !is.na(temp)) 


TS_product_cstar <-
  TS_product %>%
  group_by(station, depth_int) %>%
  mutate(talk_mean = mean(talk, na.rm = TRUE),
         PO4_mean = mean(PO4, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(tco2star =
           tco2  -
           (117 * (PO4 - PO4_mean))  -
           0.5 * ((talk - talk_mean) + (16 * (PO4 - PO4_mean)))) %>%
  filter(!is.na(tco2star))

TS_product_cstar <-
  TS_product_cstar %>%
  # head(10) %>%
  mutate(
    sir(
      flag = 15,
      var1 = talk_mean * 1e-6,
      var2 = tco2star * 1e-6,
      S = sal,
      T = temp,
      P = depth / 10,
      # Pt = phosphate * 1e-6,
      # Sit = silicate * 1e-6,
      k1k2 = "s20",
      kf = "dg",
      pHscale = "T"
    )[c(6, 18, 20, 21)]
  )

TS_product_cstar <-
TS_product_cstar %>%
  rename(
    pHstar = pH,
    OmegaAragonitestar = OmegaAragonite,
    SIRstar = SIR,
    H_freestar = H_free
  ) %>%
  select(station:depth_int, contains("star"))


TS_product <-
  TS_product %>%
  # head(10) %>%
  mutate(
    sir(
      flag = 15,
      var1 = talk * 1e-6,
      var2 = tco2 * 1e-6,
      S = sal,
      T = temp,
      P = depth / 10,
      # Pt = phosphate * 1e-6,
      # Sit = silicate * 1e-6,
      k1k2 = "s20",
      kf = "dg",
      pHscale = "T"
    )[c(6, 18, 20, 21)]
  )


TS_product <-
  full_join(TS_product,
            TS_product_cstar)
rm(TS_product_cstar)


TS_product <-
  TS_product %>%
  mutate(H_free = 1e3 * H_free,
         H_freestar = 1e3 * H_freestar)

TS_product <-
  TS_product %>%
  pivot_longer(PO4:H_freestar)

date_range <-
  c(min(TS_product$date),
    max(TS_product$date))



TS_product %>% 
  filter(!is.na(value),
         depth <= 3000) %>% 
  ggplot(aes(value, depth, col = year)) +
  geom_point(size = 1, alpha = 0.5) +
  scale_color_viridis_c() +
  labs(y = "Depth (m)") +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(
    station ~ name,
    scales = "free",
    switch = "x",
    labeller = labeller(name = x_axis_labels_stations_absolute)
  ) +
  scale_x_continuous(guide = guide_axis(n.dodge = 2)) +
  facetted_pos_scales(y = rep(list(
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(0, 100, 500, seq(1500, 5000, 1000)))
  ), 6))

ggsave(
  here::here("output/all_variables/BATS_ALOHA_all_variables_profiles_absolute.png"),
  width = 18,
  height = 8
)

cairo_pdf(
  here::here("output/all_variables/BATS_ALOHA_time_series.pdf"),
  onefile = TRUE,
  width = 18,
  height = 10
)

TS_product %>%
  arrange(date) %>%
  group_by(depth_int, station) %>%
  group_split() %>%
  head(2) %>%
  map(
    ~ ggplot(data = .x,
             aes(date, value)) +
      geom_path() +
      geom_point(aes(fill = depth_int - depth),
                 shape = 21,
                 alpha = 0.5) +
      labs(title = paste(.x$station, "|", .x$depth_int,"m")) +
      scale_fill_continuous_divergingx(
        name = "Vertical distance\nfrom depth centre (m)"
      ) +
      scale_x_date(limits = date_range) +
      geom_smooth(method = "lm", se = FALSE, col = "black") +
      facet_wrap(
        . ~ name,
        labeller = labeller(name = x_axis_labels_stations_absolute),
        scales = "free",
        ncol = 4
      ) +
      theme(
        axis.title = element_blank(),
        legend.position = c(0.9, 0.1),
        legend.direction = "horizontal",
        strip.text.x = element_markdown()
      )
  )

dev.off()

detrended <- TS_product %>%
  nest(data = -c(depth_int, station, name)) %>%
  mutate(
    fit = map(data, ~ lm(value ~ date, data = .x)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance),
    augmented = map(fit, augment)
  )

detrended <-
  detrended %>%
  unnest(augmented) %>% 
  select(station, name, depth_int, date, value, value_detrended = .resid)

detrended <-
  detrended %>%
  mutate(year = year(date),
         month = month(date))

detrended <-
  detrended %>%
  arrange(station, date)

cairo_pdf(
  here::here("output/all_variables/BATS_ALOHA_time_series_detrended.pdf"),
  onefile = TRUE,
  width = 18,
  height = 10
)

detrended %>%
  group_by(depth_int, station) %>%
  group_split() %>%
  head(2) %>%
  map(
    ~ ggplot(data = .x,
             aes(date, value_detrended)) +
      geom_path() +
      geom_point(shape = 21,
                 fill = "black",
                 alpha = 0.2) +
      labs(title = paste(.x$station, "|", .x$depth_int,"m")) +
      # geom_smooth(se = FALSE, col = "grey60") +
      geom_smooth(method = "lm", se = FALSE, col = "black") +
      facet_wrap(
        . ~ name,
        labeller = labeller(name = x_axis_labels_stations_absolute),
        scales = "free",
        ncol = 4
      ) +
      theme(
        axis.title = element_blank(),
        strip.text.x = element_markdown()
      )
  )

dev.off()


detrended <-
  detrended %>%
  group_by(name, month, depth_int) %>%
  mutate(mean = mean(value_detrended),
         median = median(value_detrended)) %>%
  ungroup()
  


cairo_pdf(
  here::here("output/all_variables/BATS_ALOHA_detrended_monthly_climatology.pdf"),
  onefile = TRUE,
  width = 18,
  height = 10
)


detrended %>%
  group_by(depth_int, station) %>%
  group_split() %>%
  head(2) %>%
  map(
    ~ ggplot(data = .x) +
      geom_point(aes(month, value_detrended), alpha = 0.2) +
      geom_point(
        aes(month, mean, fill = "Monthly mean"),
        shape = 21,
        size = 2
      ) +
      geom_point(
        aes(month, median, fill = "Monthly median"),
        shape = 21,
        size = 2
      ) +
      labs(title = paste(.x$station, "|", .x$depth_int, "m"),
           y = "Detrended values") +
      scale_x_continuous(breaks = seq(1, 12, 3)) +
      facet_wrap(
        . ~ name,
        labeller = labeller(name = x_axis_labels_stations_absolute),
        scales = "free",
        ncol = 4
      ) +
      theme(
        legend.title = element_blank(),
        legend.position = c(0.9, 0.1),
        strip.text.x = element_markdown()
      )
  )

dev.off()


detrended <-
  detrended %>%
  mutate(value_deseason = value - mean)



# cairo_pdf(
#   here::here(
#     "output/all_variables/BATS_ALOHA_time_series_deasonalized.pdf"
#   ),
#   onefile = TRUE,
#   width = 18,
#   height = 10
# )
# 
# 
# detrended %>%
#   group_by(depth_int, station) %>%
#   group_split() %>%
#   # head(2) %>%
#   map(
#     ~ ggplot(data = .x) +
#       geom_path(aes(date, value,
#                     col = "measured")) +
#       geom_point(
#         aes(date, value,
#             fill = "measured"),
#         shape = 21,
#         alpha = 0.2
#       ) +
#       geom_path(aes(date, value_deseason,
#                     col = "deseasonalized")) +
#       geom_point(
#         aes(date, value_deseason,
#             fill = "deseasonalized"),
#         shape = 21,
#         alpha = 0.2
#       ) +
#       geom_smooth(
#         aes(date, value, col = "measured"),
#         method = "lm",
#         se = FALSE
#       ) +
#       geom_smooth(
#         aes(date, value_deseason, col = "deseasonalized"),
#         method = "lm",
#         se = FALSE
#       ) +
#       scale_color_manual(values = c("red", "grey"), name = "") +
#       scale_fill_manual(values = c("red", "grey"), name = "") +
#       labs(title = paste(.x$station, "|", .x$depth_int, "m")) +
#       facet_wrap(
#         . ~ name,
#         labeller = labeller(name = x_axis_labels_stations_absolute),
#         scales = "free",
#         ncol = 4
#       ) +
#       theme(
#         axis.title = element_blank(),
#         strip.text.x = element_markdown(),
#         legend.title = element_blank(),
#         legend.position = c(0.9, 0.1)
#       ) +
#       scale_x_date(limits = date_range)
#   )
# 
# dev.off()


detrended %>%
  ggplot(aes(value_deseason, depth_int, col = date)) +
  geom_point() +
  scale_color_viridis_c(trans = "date") +
  scale_y_continuous(trans = trans_reverser("sqrt")) +
  facet_grid(station ~ name, scales = "free_x")

detrended_annual <-
  detrended %>%
  group_by(station, year, depth_int, name) %>%
  summarise(value_deseason = mean(value_deseason)) %>%
  ungroup() %>% 
  mutate(depth_int = as.numeric(as.character(depth_int)))

detrended <-
  detrended %>%
  group_by(station, year, depth_int, name) %>%
  mutate(value_deseason_annual = mean(value_deseason)) %>%
  ungroup() %>% 
  mutate(depth_int = as.numeric(as.character(depth_int)))



cairo_pdf(
  here::here(
    "output/all_variables/BATS_ALOHA_time_series_deasonalized_annual.pdf"
  ),
  onefile = TRUE,
  width = 18,
  height = 10
)


detrended %>%
  group_by(depth_int, station) %>%
  group_split() %>%
  head(2) %>%
  map(
    ~ ggplot(data = .x) +
      geom_path(aes(date, value_deseason,
                    col = "deseasonalized")) +
      geom_point(
        aes(date, value_deseason,
            fill = "deseasonalized"),
        shape = 21,
        alpha = 0.2
      ) +
      geom_path(aes(date, value_deseason_annual,
                    col = "deseasonalized annual mean")) +
      geom_point(
        aes(date, value_deseason_annual,
            fill = "deseasonalized annual mean"),
        shape = 21,
        alpha = 0.2
      ) +
      geom_smooth(aes(date, value_deseason, col = "deseasonalized"),
                  method = "lm",
                  se = FALSE)+
      geom_smooth(
        aes(date, value_deseason_annual, col = "deseasonalized annual mean"),
        method = "lm",
        se = FALSE
      ) +
      scale_color_manual(values = c("grey", "red"), name = "") +
      scale_fill_manual(values = c("grey", "red"), name = "") +
      labs(title = paste(.x$station, "|", .x$depth_int, "m")) +
      facet_wrap(
        . ~ name,
        labeller = labeller(name = x_axis_labels_stations_absolute),
        scales = "free",
        ncol = 3
      ) +
      theme(
        axis.title = element_blank(),
        strip.text.x = element_markdown(),
        legend.title = element_blank(),
        legend.position = c(0.6, 0.1)
      ) +
      scale_x_date(limits = date_range)
  )

dev.off()


detrended_annual %>%
  ggplot(aes(value_deseason, depth_int, col = year, group=year)) +
  geom_path() +
  geom_point() +
  scale_color_viridis_c() +
  scale_y_continuous(trans = trans_reverser("sqrt")) +
  facet_grid(station ~ name, scales = "free_x")
  
detrended_annual %>%
  filter(name == "tco2") %>% 
  ggplot(aes(year, depth_int, z = value_deseason)) +
  geom_contour_filled() +
  scale_fill_viridis_d(name = "tco2") +
  scale_y_continuous(trans = trans_reverser("sqrt")) +
  coord_cartesian(expand = 0) +
  facet_wrap(~ station)
  
detrended_annual %>%
  filter(name == "pH") %>% 
  ggplot(aes(year, depth_int, z = value_deseason)) +
  geom_contour_filled() +
  scale_fill_viridis_d(name = "pH") +
  scale_y_continuous(trans = trans_reverser("sqrt")) +
  coord_cartesian(expand = 0) +
  facet_wrap(~ station)

regressions <- detrended %>%
  nest(data = -c(station, depth_int, name)) %>%
  mutate(
    fit = map(data, ~ lm(value_deseason ~ year, data = .x)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance),
    augmented = map(fit, augment)
  )

TS_trends <- 
regressions %>%
  unnest(tidied) %>%
  arrange(depth_int) %>%
  filter(term == "year",
         depth_int <= 3000)



TS_trends %>%
  ggplot(aes(estimate, depth_int)) +
  geom_vline(xintercept = 0) +
  geom_ribbon(aes(
    xmin = estimate - std.error,
    xmax = estimate + std.error,
    fill = station
  ),
  alpha = 0.5) +
  geom_path(aes(col = station)) +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_brewer(palette = "Dark2") +
  labs(y = "Depth (m)") +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(
    . ~ name,
    scales = "free",
    switch = "x",
    labeller = labeller(name = x_axis_labels_stations)
  ) +
  scale_x_continuous(guide = guide_axis(n.dodge = 2)) +
  facetted_pos_scales(y = rep(list(
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(0, 100, 500, seq(1500, 5000, 1000)))
  ), 6))

ggsave(
  here::here("output/all_variables/BATS_ALOHA_all_variables_profiles_trend.png"),
  width = 14,
  height = 6
)

```



# Ocean volume grids

```{r ocean_volumes}

ocean_depth <- 3000

ocean_volume_mask <- acidification_trend %>%
  filter(depth <= ocean_depth) %>% 
  distinct(lat, lon, depth)

ocean_volume_mask <-
  m_layer_thickness(ocean_volume_mask)

ocean_volume <- inner_join(ocean_volume_mask,
                           basinmask)

ocean_volume <- ocean_volume %>%
  mutate(volume_total = layer_thickness * area) %>%
  group_by(basin) %>%
  summarise(volume_total = sum(volume_total, na.rm = TRUE)) %>%
  ungroup()

ocean_volume_global <- ocean_volume %>%
  summarise(volume_total = sum(volume_total, na.rm = TRUE)) %>%
  mutate(basin = "Global")


ocean_volume <- bind_rows(
  ocean_volume,
  ocean_volume_global
)


ocean_volume_biome <- inner_join(ocean_volume_mask,
                           biomemask)

ocean_volume_biome <- ocean_volume_biome %>%
  mutate(volume_total = layer_thickness * area) %>%
  group_by(biome) %>%
  summarise(volume_total = sum(volume_total, na.rm = TRUE)) %>%
  ungroup()


rm(ocean_volume_global)
rm(ocean_volume_mask)
```



# Color scale settings

```{r set_color_range_quantiles}

quantile_high <- 0.98
quantile_low <- 0.02

break_numbers <- 10

three_year_colors <- c("#f77f00", "#d62828", "#003049")

```
 

# Uncertainty determination

## Reference dCant case

```{r reference_dcant_reconstructions, eval=FALSE}

MLR_basins_reference <- unique(acidification_trend$MLR_basins)[1]

MLR_basins_all <- unique(acidification_trend$MLR_basins)

MLR_basins_uncertainty <-
  MLR_basins_all[!MLR_basins_all %in% MLR_basins_reference]



Version_ID_group_reference <-
  unique(acidification_trend$Version_ID_group)[1]
Version_ID_group_all <-
  unique(acidification_trend$Version_ID_group)

Version_ID_group_uncertainty <-
  Version_ID_group_all[Version_ID_group_all != Version_ID_group_reference]

```

## Additive computation

```{r uncertainty_determination, eval=FALSE}

additive_uncertainty <- function(df){
  
  df_regional_uncertainty <-
    df %>%
    filter(MLR_basins != MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-Version_ID_group) %>% 
    pivot_wider(names_from = MLR_basins,
                values_from = contains("_interval_mean"),
                names_sep = "-") %>%
    pivot_longer(all_of(contains(MLR_basins_uncertainty)),
                 names_to = c("variable","MLR_basins"),
                 names_sep = "-",
                 values_to = "value")
  
  df_regional_reference <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-c(MLR_basins, Version_ID_group)) %>% 
    pivot_longer(contains("_interval_mean"),
                 names_to = c("variable"),
                 values_to = MLR_basins_reference)
  
  df_regional <-
    full_join(df_regional_reference, df_regional_uncertainty)
  
  df_regional <-
    df_regional %>%
    mutate(delta_value = value-!!sym(MLR_basins_reference)) %>%
    select(-c(all_of(MLR_basins_reference), MLR_basins, value))

  df_regional_stat <-
    df_regional %>%
    group_by(across(-delta_value)) %>%
    summarise(sd = mean(abs(delta_value))) %>%
    ungroup()


  df_configuration_uncertainty <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group %in% Version_ID_group_uncertainty) %>% 
    select(-MLR_basins) %>% 
    pivot_wider(names_from = Version_ID_group,
                values_from = contains("_interval_mean"),
                names_sep = "-") %>%
   pivot_longer(all_of(contains(Version_ID_group_uncertainty)),
                 names_to = c("variable","Version_ID_group"),
                 names_sep = "-",
                 values_to = "value")

  
  df <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-c(Version_ID_group, MLR_basins)) %>% 
    pivot_longer(contains("_interval_mean"),
                 names_to = c("variable"),
                 values_to = Version_ID_group_reference)

  df_configuration <-
    full_join(df, df_configuration_uncertainty) 
  
  df_configuration <- df_configuration %>% 
    mutate(delta_value = value-!!sym(Version_ID_group_reference))
  
  
  df_configuration <-
    df_configuration %>%
    rename(sd = delta_value) %>%
    select(-c(value, all_of(Version_ID_group_reference)))
  
  df_factorial <-
    bind_rows(
      df_regional_stat %>%
        mutate(Version_ID_group = "Regional clustering"),
      df_configuration
    )

  df_factorial_stat <-
    df_factorial %>%
    select(-Version_ID_group) %>%
    group_by(across(-sd)) %>%
    summarise(sd = sqrt(sum(sd ^ 2, na.rm = TRUE))) %>%
    ungroup()

  df_stat <-
    full_join(
      df_factorial_stat,
      df %>%
        rename(std_case = all_of(Version_ID_group_reference))
    )

  df_stat <- df_stat %>%
    mutate(
      signif_single = if_else(abs(std_case) >= sd,
                              1,
                              0),
      signif_double = if_else(abs(std_case) >= sd * 2,
                              1,
                              0)
    )

  df_stat_delta <-
    df_stat %>%
    select(-starts_with("signif_")) %>%
    arrange(tref) %>%
    group_by(across(-c(tref, sd, std_case))) %>%
    mutate(
      delta_value = std_case - lag(std_case),
      RSS = sqrt(sd ^ 2 + lag(sd ^ 2)),
      signif_single = if_else(abs(delta_value) >= RSS,
                              1,
                              0),
      signif_double = if_else(abs(delta_value) >= RSS * 2,
                              1,
                              0)
    ) %>%
    ungroup() %>%
    drop_na()
  
  
  df_stat <-
    df_stat %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))
  
  df_factorial <-
    df_factorial %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))
  
  df_stat_delta <-
    df_stat_delta %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))


df_out <- list(df_stat, df_factorial, df_stat_delta)

return(df_out)

}


```



# General consideration

```{r acidification_parameter_sensitivity}

sensitivity <-
  expand_grid(
    pco2 = seq(100, 1000, 100),
    temp = seq(0, 30, 5)
  )

sensitivity <- sensitivity %>%
  mutate(carb(
    flag = 24,
    var1 = pco2,
    var2 = 2300 * 1e-6,
    T = temp,
    pHscale = "F"
  )) %>%
  select(
    temp,
    pco2,
    DIC,
    CO3,
    pH,
    HCO3
  )

sensitivity_DIC <- sensitivity %>%
  select(temp, pco2, tco2_start = DIC) %>% 
  mutate(carb(
    flag = 15,
    var1 = 2300 * 1e-6,
    var2 = tco2_start + 10 * 1e-6,
    T = temp,
    pHscale = "F"
  )) %>%
  select(
    temp,
    pco2,
    CO3,
    pH,
    HCO3
  )

sensitivity_temp <- sensitivity %>%
  select(temp, pco2, tco2_start = DIC) %>% 
  mutate(carb(
    flag = 15,
    var1 = 2300 * 1e-6,
    var2 = tco2_start,
    T = temp + 1,
    pHscale = "F"
  )) %>%
  select(
    temp,
    pco2,
    CO3,
    pH,
    HCO3
  )

sensitivity_all <-
  bind_rows(
    sensitivity %>% mutate(case = "start") %>% select(-DIC),
    sensitivity_DIC %>% mutate(case = "+10DIC"),
    sensitivity_temp %>%  mutate(case = "+1temp")
  )

sensitivity_all <- sensitivity_all %>% 
  arrange(desc(case)) %>% 
  mutate(H = 1e6 * 10^-pH,
         HCO3 = HCO3 * 1e6,
         CO3 = CO3 * 1e6,
         SIR = HCO3 / H
         ) %>% 
  pivot_longer(c(CO3, pH, HCO3, H, SIR),
               names_to = "variable",
               values_to = "value") %>% 
  group_by(temp, pco2, variable) %>% 
  mutate(delta_relative = 100 * (value - first(value)) / first(value)) %>% 
  ungroup() %>% 
  filter(case != "start")


sensitivity_all %>% 
  mutate(pco2 = as.factor(pco2)) %>% 
  ggplot(aes(temp, delta_relative, col = pco2)) +
  geom_point() +
  geom_path() +
  scale_color_viridis_d() +
  facet_nested_wrap(case~variable, scales = "free", ncol = 5)

sensitivity_all %>% 
  mutate(temp = as.factor(temp)) %>% 
  ggplot(aes(pco2, delta_relative, col = temp)) +
  geom_point() +
  geom_path() +
  scale_color_viridis_d() +
  facet_nested_wrap(case~variable, scales = "free", ncol = 5)

sensitivity_all %>% 
  select(-value) %>% 
  pivot_wider(names_from = case,
              values_from = delta_relative) %>% 
  mutate(temp_per_DIC =  `+1temp` / `+10DIC`) %>% 
  mutate(temp = as.factor(temp)) %>% 
  ggplot(aes(pco2, temp_per_DIC, col = temp)) +
  geom_point() +
  geom_path() +
  scale_color_viridis_d() +
  facet_nested_wrap(.~variable, ncol = 5)

sensitivity_all %>% 
  select(-value) %>% 
  pivot_wider(names_from = case,
              values_from = delta_relative) %>% 
  mutate(temp_per_DIC =  `+1temp` / `+10DIC`) %>% 
  mutate(pco2 = as.factor(pco2)) %>% 
  ggplot(aes(temp, temp_per_DIC, col = pco2)) +
  geom_point() +
  geom_path() +
  scale_color_viridis_d() +
  facet_nested_wrap(.~variable, ncol = 5)

rm(sensitivity,
   sensitivity_all,
   sensitivity_DIC,
   sensitivity_temp)


```



# Depth layer maps

## Computation

```{r compute_layered_maps}

m_depth_layer <- function(df) {
  
  # df <- acidification_trend
  
    
  df <- m_layer_thickness(df)
  
  df <- df %>%
    mutate(depth = cut(
      depth,
      c(0, 100, 500, 1500, 3000),
      c("A: 0 - 100 m", "B: 100 - 500 m", "C :500 - 1500 m", "D: 1500 - 3000 m"),
      include.lowest = TRUE
    )) %>%
    drop_na()
  
  df <- df %>%
    select(c(lat, lon, depth, tref, layer_thickness),
           where(is.numeric)) %>%
    fgroup_by(lat, lon, depth, tref) %>% {
      add_vars(fgroup_vars(., "unique"),
               fmean(., 
                     w = layer_thickness,
                     keep.group_vars = FALSE))
    }
  
  return(df)
  
}


acidification_depth_layer <- m_depth_layer(acidification_trend)

acidification_depth_layer_dCant_temp <- dCant_temp_trend %>%
  group_by(driver) %>%
  nest() %>%
  mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
  select(-data) %>%
  unnest(layer) %>% 
  ungroup()

# acidification_depth_layer_DIC_dCant_temp <- dCant_DIC_temp_trend %>%
#   group_by(driver) %>%
#   nest() %>%
#   mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
#   select(-data) %>%
#   unnest(layer) %>% 
#   ungroup()
# 
# acidification_depth_layer_dCant_DIC_surface <- dCant_DIC_surface_trend %>%
#   group_by(driver) %>%
#   nest() %>%
#   mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
#   select(-data) %>%
#   unnest(layer) %>% 
#   ungroup()
# 

buffer_depth_layer <- buffer_trend %>%
  group_by(variable) %>%
  nest() %>%
  mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
  select(-data) %>%
  unnest(layer) %>%
  ungroup()

buffer_addition_depth_layer <- buffer_trend_addition %>%
  group_by(variable) %>%
  nest() %>%
  mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
  select(-data) %>%
  unnest(layer) %>%
  ungroup()

# buffer_climatology_depth_layer <- m_depth_layer(buffer_climatology)
# climatology_depth_layer <- m_depth_layer(climatology)

```

## Incremental changes

### dCant + DIC (interior)

Note: temperature influence was not considered for maps

```{r depth_layer_incremental_change_dCant_DIC_interior, eval=FALSE}

# subset DIC_dCant_temp change sections

acidification_depth_layer_DIC_dCant_temp <-
  acidification_depth_layer_DIC_dCant_temp %>%
  filter(driver %in% c("dCant", "DIC")) %>% 
  select(driver:tref,
         contains("_delta_interval"))

acidification_depth_layer_DIC_dCant_temp <-
  acidification_depth_layer_DIC_dCant_temp %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_dCant_DIC_changes.pdf"),
  width = 14,
  height = 10
)

# loop over OIA variables
# print DIC_dCant_temp sections

for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[4]
  
  # subset OIA variable
  
  i_acidification_depth_layer_DIC_dCant_temp <-
    acidification_depth_layer_DIC_dCant_temp %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, driver, delta_interval)

  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_DIC_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_DIC_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  # create maps with absolute values
  
  p_depth_layer_dCant <-
    i_acidification_depth_layer_DIC_dCant_temp %>%
    filter(driver == "dCant") %>%
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: dCant")
  
  p_depth_layer_DIC <-
  i_acidification_depth_layer_DIC_dCant_temp %>%
    filter(driver == "DIC") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: DIC")
      
  
  i_delta_acidification_depth_layer_driver <-
    i_acidification_depth_layer_DIC_dCant_temp %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant` - `DIC`) %>%
    select(lon, lat, depth, tref, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_driver <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_driver <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_driver <-
    i_delta_acidification_depth_layer_driver %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_driver,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver difference: dCant - DIC")
  
  print(
    wrap_plots(
      p_depth_layer_dCant,
      p_depth_layer_DIC,
      p_depth_layer_driver,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_DIC_dCant_temp,
   i_acidification_depth_layer_DIC_dCant_temp,
   i_delta_acidification_depth_layer_driver,
   high, low,
   breaks_divergent_driver,
   p_depth_layer_dCant,
   p_depth_layer_DIC,
   p_depth_layer_driver)

```

### dCant + DIC (surface)

Note: temperature influence was not considered for maps

```{r depth_layer_incremental_change_dCant_DIC_surface, eval=FALSE}

# subset DIC_dCant_temp change sections

acidification_depth_layer_dCant_DIC_surface <-
  acidification_depth_layer_dCant_DIC_surface %>%
  filter(driver %in% c("dCant", "DIC surface")) %>% 
  select(driver:tref,
         contains("_delta_interval"))

acidification_depth_layer_dCant_DIC_surface <-
  acidification_depth_layer_dCant_DIC_surface %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

depth_layer_low <- acidification_depth_layer_dCant_DIC_surface %>% 
  distinct(depth) %>% 
  arrange(depth) %>% 
  head(1) %>% 
  pull()

acidification_depth_layer_dCant_DIC_surface <-
  acidification_depth_layer_dCant_DIC_surface %>%
  filter(depth == depth_layer_low)

rm(depth_layer_low)


# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_dCant_DIC_surface_changes.pdf"),
  width = 14,
  height = 4
)

# loop over OIA variables
# print DIC_dCant_temp sections

for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[4]
  
  # subset OIA variable
  
  i_acidification_depth_layer_dCant_DIC_surface <-
    acidification_depth_layer_dCant_DIC_surface %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, driver, delta_interval)

  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_dCant_DIC_surface %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_dCant_DIC_surface %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  # create maps with absolute values
  
  p_depth_layer_dCant <-
  i_acidification_depth_layer_dCant_DIC_surface %>%
    filter(driver == "dCant") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: dCant")
  
  p_depth_layer_DIC <-
  i_acidification_depth_layer_dCant_DIC_surface %>%
    filter(driver == "DIC surface") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: DIC surface")
      
  
  i_delta_acidification_depth_layer_driver <-
    i_acidification_depth_layer_dCant_DIC_surface %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant` - `DIC surface`) %>%
    select(lon, lat, depth, tref, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_driver <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_driver <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_driver <-
    i_delta_acidification_depth_layer_driver %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_driver,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver difference: dCant - DIC surface")
  
  print(
    wrap_plots(
      p_depth_layer_dCant,
      p_depth_layer_DIC,
      p_depth_layer_driver,
      ncol = 3
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_dCant_DIC_surface,
   i_acidification_depth_layer_dCant_DIC_surface,
   i_delta_acidification_depth_layer_driver,
   high, low,
   breaks_divergent_driver,
   p_depth_layer_dCant,
   p_depth_layer_DIC,
   p_depth_layer_driver)

```

### dCant + Temperature

```{r depth_layer_incremental_change_dCant_temp, eval=FALSE}

# subset dCant_temp change sections

acidification_depth_layer_dCant_temp <-
  acidification_depth_layer_dCant_temp %>%
  select(driver:tref,
         contains("_delta_interval"))

acidification_depth_layer_dCant_temp <-
  acidification_depth_layer_dCant_temp %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_dCant_temp_changes.pdf"),
  width = 20,
  height = 6
)

# loop over OIA variables
# print dCant_temp sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[4]
  
  # subset OIA variable
  
  i_acidification_depth_layer_dCant_temp <-
    acidification_depth_layer_dCant_temp %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, driver, delta_interval)

  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  # create maps with absolute values
  
  p_depth_layer_dCant <-
  i_acidification_depth_layer_dCant_temp %>%
    filter(driver == "dCant") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: dCant")
  
  p_depth_layer_dCant_temp <-
  i_acidification_depth_layer_dCant_temp %>%
    filter(driver == "dCant + temp") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: dCant + temp")
      
  # create maps wiht decadal differences
  
  i_delta_acidification_depth_layer_decadal <-
    i_acidification_depth_layer_dCant_temp %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    select(lon, lat, depth, driver, delta_delta_interval)
  
  low <- i_delta_acidification_depth_layer_decadal %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_decadal %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_decadal <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_decadal <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_decadal <-
    i_delta_acidification_depth_layer_decadal %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "driver",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_decadal,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Decadal difference")
  
  
  i_delta_acidification_depth_layer_driver <-
    i_acidification_depth_layer_dCant_temp %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant + temp` - `dCant`) %>%
    select(lon, lat, depth, tref, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_driver <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_driver <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_driver <-
    i_delta_acidification_depth_layer_driver %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_driver,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver difference")
  
  print(
    wrap_plots(
      p_depth_layer_dCant,
      p_depth_layer_dCant_temp,
      p_depth_layer_decadal,
      p_depth_layer_driver,
      ncol = 2
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_dCant_temp,
   i_acidification_depth_layer_dCant_temp,
   i_delta_acidification_depth_layer_decadal,
   i_delta_acidification_depth_layer_driver,
   high, low,
   breaks_divergent_decadal,
   breaks_divergent_driver,
   p_depth_layer_dCant,
   p_depth_layer_dCant_temp,
   p_depth_layer_decadal,
   p_depth_layer_driver)

```

### dCant

```{r depth_layer_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_depth_layer_incremental <-
  acidification_depth_layer %>%
  select(lat:Version_ID_group,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_depth_layer_uncertainty <-
  m_grid_horizontal_coarse(acidification_depth_layer_incremental)

acidification_depth_layer_uncertainty <-
  acidification_depth_layer_uncertainty %>% 
  select(-c(lat,lon)) %>% 
  rename(lat = lat_grid, lon = lon_grid) %>% 
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean),
            n = n()) %>%
  ungroup() %>% 
  filter(n == 25) %>% 
  select(-n)

# compute uncertainty

acidification_depth_layer_uncertainty <-
  additive_uncertainty(acidification_depth_layer_uncertainty)

delta_acidification_depth_layer_uncertainty <- acidification_depth_layer_uncertainty[[3]]
acidification_depth_layer_uncertainty <- acidification_depth_layer_uncertainty[[1]]


# subset reference reconstruction

acidification_depth_layer_incremental <-
  acidification_depth_layer_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_incremental_changes.pdf"),
  width = 14,
  height = 7
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_depth_layer_incremental <-
    acidification_depth_layer_incremental %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, delta_interval)

  i_acidification_depth_layer_uncertainty <-
    acidification_depth_layer_uncertainty %>%
    filter(variable == i_var)

  i_acidification_depth_layer_uncertainty <-
    i_acidification_depth_layer_uncertainty %>%
    select(lon, lat, depth, tref, signif_single, signif_double) %>%
    st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat")

  i_delta_acidification_depth_layer_uncertainty <-
    delta_acidification_depth_layer_uncertainty %>%
    filter(variable == i_var)

  i_delta_acidification_depth_layer_uncertainty <-
    i_delta_acidification_depth_layer_uncertainty %>%
    select(lon, lat, depth, tref, signif_single, signif_double) %>%
    st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat")
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_depth_layer_decades <-
  i_acidification_depth_layer_incremental %>%
    p_map_mdim_robinson(
      df_uncertainty = i_acidification_depth_layer_uncertainty,
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    )
      
  i_delta_acidification_depth_layer_incremental <-
    i_acidification_depth_layer_incremental %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    select(lon, lat, depth, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  breaks_divergent <-
    c(-Inf, seq(-high_low, high_low, length.out = break_numbers), Inf)
  
  p_depth_layer_offset <-
    i_delta_acidification_depth_layer_incremental %>% 
    p_map_mdim_robinson(
      df_uncertainty = i_delta_acidification_depth_layer_uncertainty,
      dim_col = "depth",
      # dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    )
  
  print(
    wrap_plots(
      p_depth_layer_decades,
      p_depth_layer_offset,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_incremental,
   acidification_depth_layer_uncertainty,
   delta_acidification_depth_layer_uncertainty
   )

```

## Total changes

```{r depth_layer_total_change}

# subset total change sections

acidification_depth_layer_total <-
  acidification_depth_layer %>%
  select(lat:tref,
         contains("_delta_total")) %>%
  filter(tref != 1800)


acidification_depth_layer_total <-
  acidification_depth_layer_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total"))


for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[2]
  
  # subset OIA variable
  
  i_acidification_depth_layer_total <-
    acidification_depth_layer_total %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, delta_total)
  
  # # determine endpoints and breaks of color scale automatically
  # 
  # low <- i_acidification_depth_layer_total %>%
  #   filter(!is.na(delta_total)) %>%
  #   pull(delta_total) %>%
  #   quantile(c(quantile_low), names = FALSE)
  # 
  # high <- i_acidification_depth_layer_total %>%
  #   filter(!is.na(delta_total)) %>%
  #   pull(delta_total) %>%
  #   quantile(c(quantile_high), names = FALSE)
  # 
  # i_breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)

  all_labels_breaks <- labels_breaks(i_var)
  i_breaks        <- unlist(all_labels_breaks[1])
  i_contour_level <- unlist(all_labels_breaks[2])
  i_legend_title  <- unlist(all_labels_breaks[3])
  
  i_acidification_depth_layer_total %>%
    p_map_mdim_robinson(
      dim_row = "depth",
      dim_col = "tref",
      var = "delta_total",
      contour_level = i_contour_level,
      legend_title = i_legend_title,
      breaks = i_breaks,
      legend_position = "right"
    )
  
  ggsave(
    here::here(
      paste0("output/publication/maps_depth_layer_",i_var,"_total_changes.png")
    ),
    width = 10,
    height = 4.5,
    dpi = 600,
    bg = "white"
  )
  
}


acidification_depth_layer_total_relative <-
  acidification_depth_layer_total %>%
  filter(tref %in% c(1994, 2014),
         variable %in% OIA_variables[-6]) %>%
  pivot_wider(names_from = tref,
              values_from = delta_total) %>%
  mutate(delta_total_relative = 100 * (`2014` - `1994`) / `1994`) %>%
  select(lon, lat, depth, variable, delta_total_relative)

i_breaks        <- c(-Inf, seq(0, 70, 10), Inf)
i_contour_level <- 30
i_legend_title  <- "Δ 1994 - 2014<br>(% of Δ 1800 - 1994)"

acidification_depth_layer_total_relative %>%
  p_map_mdim_robinson(
    dim_row = "depth",
    dim_col = "variable",
    var = "delta_total_relative",
    # contour_level = i_contour_level,
    legend_title = i_legend_title,
    breaks = i_breaks,
    legend_position = "right"
  )

ggsave(
  here::here(
    paste0(
      "output/publication/maps_depth_layer_all_var_total_changes_relative.png"
    )
  ),
  width = 14,
  height = 4.5,
  dpi = 600,
  bg = "white"
)


breaks_contour <- c(-Inf,1,2, Inf)

world <- ne_countries(scale = "small", returnclass = "sf")
coastline <- ne_coastline(scale = "small", returnclass = "sf")

acidification_depth_layer_total %>%
  filter(variable == "H_free") %>% 
  mutate(tref = as.factor(tref),
         lon = if_else(lon > 180, lon - 360, lon)) %>% 
  ggplot() +
  geom_contour_filled(data = . %>% filter(tref == "1994"),
                      aes(lon, lat, z = delta_total),
                      breaks = breaks_contour) +
  geom_contour(breaks = breaks_contour,
               aes(lon, lat, z = delta_total, col = tref)) +
  scale_fill_discrete_sequential(
    palette = "Dark Mint",
    name = expression(atop(
      Delta*H^{"+"}~1994,
      (nmol~kg^{-1})))) +
  scale_color_discrete_sequential(
    palette = "Reds",
    name = expression(atop(
      Delta*H^{"+"}~isoline,
      progression))) +
  scale_linetype_manual(values = c(3,2,1)) +
  geom_sf(data = world, fill = "grey80", col = "grey80") +
  coord_sf(expand = 0, ylim = c(-78,65)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  facet_wrap(~ depth, ncol = 2)

ggsave(
  here::here(
    "output/publication/maps_depth_layer_total_changes_hydrogen_ion_isolines.png"
  ),
  width = 10,
  height = 6,
  dpi = 600,
  bg = "white"
)

acidification_depth_layer_total %>%
  filter(variable == "H_free") %>% 
  mutate(tref = as.factor(tref),
         lon = if_else(lon > 180, lon - 360, lon)) %>%
  ggplot() +
  geom_contour_filled(
    data = . %>% filter(tref == 2014),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 2004),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 1994),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0, Inf)
  ) +
  scale_fill_brewer(palette = "Greens", name = ">0",
                    guide = guide_legend(order = 4)) +
  new_scale_fill() +
  geom_contour_filled(
    data = . %>% filter(tref == 2014),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(1, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 2004),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(1, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 1994),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(1, Inf)
  ) +
  scale_fill_brewer(palette = "Blues", name = ">1",
                    guide = guide_legend(order = 3)) +
  new_scale_fill() +
  geom_contour_filled(
    data = . %>% filter(tref == 2014),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(2, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 2004),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(2, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 1994),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(2, Inf)
  ) +
  scale_fill_brewer(palette = "Purples", name = ">2",
                    guide = guide_legend(order = 2)) +
  new_scale_fill() +
  geom_contour_filled(
    data = . %>% filter(tref == 2014),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(3, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 2004),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(3, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 1994),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(3, Inf)
  ) +
  scale_fill_brewer(palette = "Reds",
                    name = expression(atop(
                      Delta*H^{"+"}~threshold~(nmol~kg^{-1}),
                      ">3")),
                    limits = c("1994","2004","2014"),
                    guide = guide_legend(order = 1)) +
  geom_sf(data = world, fill = "grey80", col = "grey80") +
  coord_sf(expand = 0, ylim = c(-78,65)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  facet_wrap(~ depth, ncol = 2)

ggsave(
  here::here(
    "output/publication/maps_depth_layer_total_changes_hydrogen_ion_filled_isolines.png"
  ),
  width = 10,
  height = 6,
  dpi = 600,
  bg = "white"
)



acidification_depth_layer_absolute <-
  acidification_depth_layer %>%
  select(lat:tref,
         OIA_variables[-6]) %>%
  filter(tref == 2004)


acidification_depth_layer_absolute <-
  acidification_depth_layer_absolute %>%
  pivot_longer(-c(lat:tref),
               names_to = "variable",
               values_to = "absolute")



acidification_depth_layer_total_relative <-
  full_join(
    acidification_depth_layer_total %>%
      filter(variable %in% OIA_variables[-6]),
    acidification_depth_layer_absolute %>% 
      select(-tref)
  )

acidification_depth_layer_total_relative <-
acidification_depth_layer_total_relative %>% 
  mutate(delta_total_relative = 100 * delta_total / absolute)

for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[2]
  
  # subset OIA variable
  
  i_acidification_depth_layer_total_relative <-
    acidification_depth_layer_total_relative %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, delta_total_relative)
  
  # determine endpoints and breaks of color scale automatically

  low <- i_acidification_depth_layer_total_relative %>%
    filter(!is.na(delta_total_relative)) %>%
    pull(delta_total_relative) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_depth_layer_total_relative %>%
    filter(!is.na(delta_total_relative)) %>%
    pull(delta_total_relative) %>%
    quantile(c(quantile_high), names = FALSE)

  i_breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)

  all_labels_breaks <- labels_breaks(i_var)
  # i_breaks        <- unlist(all_labels_breaks[1])
  # i_contour_level <- unlist(all_labels_breaks[2])
  i_legend_title  <- unlist(all_labels_breaks[3])
  
  i_acidification_depth_layer_total_relative %>%
    p_map_mdim_robinson(
      dim_row = "depth",
      dim_col = "tref",
      var = "delta_total_relative",
      # contour_level = i_contour_level,
      legend_title = i_legend_title,
      breaks = i_breaks,
      legend_position = "right"
    )
  
  ggsave(
    here::here(
      paste0("output/publication/maps_depth_layer_",i_var,"_total_changes_relative.png")
    ),
    width = 10,
    height = 4.5,
    dpi = 600,
    bg = "white"
  )
  
}

rm(acidification_depth_layer_total,
   acidification_depth_layer,
   i_acidification_depth_layer_total)

```


```{r depth_layer_total_change_temperature}

# subset total change sections

acidification_depth_layer_total <-
  acidification_depth_layer_dCant_temp %>%
  select(driver:tref,
         contains("_delta_total")) %>%
  filter(tref != 1800,
         driver == "dCant + temp") %>% 
  select(-driver)


acidification_depth_layer_total <-
  acidification_depth_layer_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total"))


for (i_var in OIA_variables[6]) {
  # i_var <- OIA_variables[6]
  
  # subset OIA variable
  
  i_acidification_depth_layer_total <-
    acidification_depth_layer_total %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, delta_total)
  
  all_labels_breaks <- labels_breaks(i_var)
  i_breaks        <- unlist(all_labels_breaks[1])
  i_contour_level <- unlist(all_labels_breaks[2])
  i_legend_title  <- unlist(all_labels_breaks[3])
  
  i_acidification_depth_layer_total %>%
    p_map_mdim_robinson(
      dim_row = "depth",
      dim_col = "tref",
      var = "delta_total",
      contour_level = i_contour_level,
      col = "divergent",
      legend_title = i_legend_title,
      breaks = i_breaks,
      legend_position = "right"
    )
  
  ggsave(
    here::here(
      paste0("output/publication/maps_depth_layer_",i_var,"_total_changes_temp.png")
    ),
    width = 9,
    height = 6,
    dpi = 600,
    bg = "white"
  )
  
}
rm(acidification_depth_layer_total,
   i_acidification_depth_layer_total)

```



## Climatology

### OIA variables

```{r depth_layer_climatology, eval=FALSE}

# subset total change sections

climatology_depth_layer <-
  climatology_depth_layer %>%
  select(-contains("_delta"))


climatology_depth_layer <-
  climatology_depth_layer %>%
  pivot_longer(-c(lat:tref),
               names_to = "variable",
               values_to = "value")

climatology_depth_layer %>% 
  distinct(variable)

# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_climatology.pdf"),
  width = 5,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_climatology_depth_layer <-
    climatology_depth_layer %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, value)
  
  # determine endpoints and breaks of color scale
  
  low <- i_climatology_depth_layer %>%
    filter(!is.na(value)) %>%
    pull(value) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_climatology_depth_layer %>%
    filter(!is.na(value)) %>%
    pull(value) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_climatology <-
  i_climatology_depth_layer %>%
    p_map_mdim_robinson(
      dim_row = "depth",
      dim_col = "tref",
      var = "value",
      legend_title = i_var,
      breaks = breaks,
      legend_position = "right"
    )
  
  print(
  p_climatology
  )
  
}

dev.off()

rm(climatology_depth_layer,
   i_climatology_depth_layer,
   low, high)

```

### buffer variables

```{r depth_layer_buffer_addition_climatology}

# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables_addition[buffer_variables_addition != "temp"]) {
  # i_var <- buffer_variables_addition[4]
  
  # subset OIA variable
  
  i_buffer_addition_depth_layer <-
    buffer_addition_depth_layer %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, sensitivity)
  
  # determine endpoints and breaks of color scale
  
  # low <- i_buffer_addition_depth_layer %>%
  #   filter(!is.na(sensitivity)) %>%
  #   pull(sensitivity) %>%
  #   quantile(c(quantile_low), names = FALSE)
  # 
  # high <- i_buffer_addition_depth_layer %>%
  #   filter(!is.na(sensitivity)) %>%
  #   pull(sensitivity) %>%
  #   quantile(c(quantile_high), names = FALSE)
  # 
  # breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  all_labels_breaks <- labels_breaks_buffer_variables_addition(i_var)
  i_breaks        <- unlist(all_labels_breaks[1])
  i_contour_level <- unlist(all_labels_breaks[2])
  i_legend_title  <- unlist(all_labels_breaks[3])
  
  i_buffer_addition_depth_layer %>%
    p_map_mdim_robinson(
      dim_row = "depth",
      dim_col = "tref",
      var = "sensitivity",
      contour_level = i_contour_level,
      legend_title = i_legend_title,
      breaks = i_breaks,
      legend_position = "right"
    )
  
  ggsave(
    here::here(
      paste0(
        "output/publication/maps_depth_layer_",
        i_var,
        "_total_changes_buffer_additional.png"
      )
    ),
    width = 14,
    height = 5,
    dpi = 600,
    bg = "white"
  )
  
}


buffer_addition_depth_layer_relative <-
  buffer_addition_depth_layer %>%
  filter(variable %in% OIA_variables[-c(1,6)]) %>%
  pivot_wider(names_from = tref,
              values_from = sensitivity) %>%
  mutate(`1900` = (`1800` + `1994`) / 2,
         delta_sensitivity = abs(100 * (`2004` - `1900`) / `1900`)) %>%
  select(lon, lat, depth, variable, delta_sensitivity)

i_breaks        <- c(-Inf, seq(0, 24, 4), Inf)
i_legend_title  <- "Sensitivity 2004<br>(% of ~1900)"

buffer_addition_depth_layer_relative %>%
  p_map_mdim_robinson(
    dim_row = "depth",
    dim_col = "variable",
    var = "delta_sensitivity",
    legend_title = i_legend_title,
    breaks = i_breaks,
    legend_position = "right"
  )

ggsave(
  here::here(
    paste0(
      "output/publication/maps_depth_layer_all_var_total_changes_buffer_additional_relative.png"
    )
  ),
  width = 14,
  height = 4.5,
  dpi = 600,
  bg = "white"
)


for (i_var in buffer_variables_addition[buffer_variables_addition != "temp"]) {
  # i_var <- buffer_variables_addition[4]
  
  # subset OIA variable
  
  i_buffer_addition_depth_layer_relative <-
    buffer_addition_depth_layer_relative %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, delta_sensitivity)
  
  # determine endpoints and breaks of color scale
  
  low <- i_buffer_addition_depth_layer_relative %>%
    filter(!is.na(delta_sensitivity)) %>%
    pull(delta_sensitivity) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_buffer_addition_depth_layer_relative %>%
    filter(!is.na(delta_sensitivity)) %>%
    pull(delta_sensitivity) %>%
    quantile(c(quantile_high), names = FALSE)

  i_breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  all_labels_breaks <- labels_breaks_buffer_variables_addition_change(i_var)
  i_breaks        <- unlist(all_labels_breaks[1])
  i_contour_level <- unlist(all_labels_breaks[2])
  i_legend_title  <- unlist(all_labels_breaks[3])
  
  i_buffer_addition_depth_layer_relative %>%
  p_map_mdim_robinson(
    dim_row = "depth",
    # dim_col = "variable",
    var = "delta_sensitivity",
    legend_title = i_legend_title,
    # contour_level = i_contour_level,
    breaks = i_breaks,
    legend_position = "right"
  )
  
  ggsave(
    here::here(
      paste0(
        "output/publication/maps_depth_layer_",
        i_var,
        "_total_changes_buffer_additional_relative.png"
      )
    ),
    width = 6,
    height = 5,
    dpi = 600,
    bg = "white"
  )
  
}

rm(buffer_addition_depth_layer,
   i_buffer_addition_depth_layer,
   p_climatology,
   low, high)

```


```{r depth_layer_buffer_climatology, eval=FALSE}

# subset total change sections

buffer_climatology_depth_layer <-
  buffer_climatology_depth_layer %>%
  select(-contains("_delta"))


buffer_climatology_depth_layer <-
  buffer_climatology_depth_layer %>%
  pivot_longer(-c(lat:tref),
               names_to = "variable",
               values_to = "value")

buffer_variables <- buffer_climatology_depth_layer %>% 
  distinct(variable) %>% 
  pull

# create pdf document


pdf(
  here::here(
    "output/all_variables/maps_depth_layer_buffer_climatology.pdf"
  ),
  width = 5,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_buffer_climatology_depth_layer <-
    buffer_climatology_depth_layer %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, value)
  
  # determine endpoints and breaks of color scale
  
  low <- i_buffer_climatology_depth_layer %>%
    filter(!is.na(value)) %>%
    pull(value) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_buffer_climatology_depth_layer %>%
    filter(!is.na(value)) %>%
    pull(value) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_climatology <-
    i_buffer_climatology_depth_layer %>%
    p_map_mdim_robinson(
      dim_row = "depth",
      dim_col = "tref",
      var = "value",
      legend_title = i_var,
      breaks = breaks,
      legend_position = "right"
    )
  
  print(p_climatology)
  
}

dev.off()

rm(buffer_climatology_depth_layer,
   i_buffer_climatology_depth_layer)

```


# Acidifcation volumes

```{r acidification_volumes}

acidification_volume_raw <-
  acidification_trend %>%
  filter(tref != 1800,
         depth <= ocean_depth) %>%
  select(lon, lat, depth, tref, contains("delta_total"))

acidification_volume_raw <-
  m_layer_thickness(acidification_volume_raw)

acidification_volume_raw <-
  acidification_volume_raw %>%
  pivot_longer(contains("delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total"))

for (i_var in OIA_variables[-6]) {
  
  # i_var <- OIA_variables[2]
  
  i_contours <- labels_breaks(i_var)$i_breaks
  i_contours <- i_contours[-c(1, length(i_contours))]
  
  i_acidification_volume_raw <- acidification_volume_raw %>% 
    filter(variable == i_var)
  
  for (i_contour in i_contours) {
    # i_contour <- i_contours[2]
    
    acidification_horizon <-
      i_acidification_volume_raw %>%
      filter(abs(delta_total) > abs(i_contour)) %>%

      mutate(contour = i_contour)
    
    acidification_volume_global <-
      left_join(acidification_horizon,
                basinmask) %>%
      mutate(volume = layer_thickness * area,
             basin = "Global") %>%
      group_by(tref, variable, contour, basin) %>%
      summarise(volume = sum(volume)) %>%
      ungroup()
    
    acidification_volume_regional <-
      left_join(acidification_horizon,
                basinmask) %>%
      mutate(volume = layer_thickness * area) %>%
      group_by(tref, variable, contour, basin) %>%
      summarise(volume = sum(volume)) %>%
      ungroup()
    
    acidification_volume <- bind_rows(
      acidification_volume_global,
      acidification_volume_regional
    )
    
    rm(
      acidification_volume_global,
      acidification_volume_regional
    )
    
    acidification_volume_biome <- left_join(acidification_horizon,
                                             biomemask) %>%
      mutate(volume = layer_thickness * area) %>%
      group_by(tref, variable, contour, biome) %>%
      summarise(volume = sum(volume)) %>%
      ungroup()

    
    if (exists("acidification_volume_all")) {
      acidification_volume_all <-
        bind_rows(acidification_volume_all,
                  acidification_volume)
    }
    
    if (!exists("acidification_volume_all")) {
      acidification_volume_all <- acidification_volume
    }

    if (exists("acidification_volume_biome_all")) {
      acidification_volume_biome_all <-
        bind_rows(acidification_volume_biome_all,
                  acidification_volume_biome)
    }
    
    if (!exists("acidification_volume_biome_all")) {
      acidification_volume_biome_all <- acidification_volume_biome
    }
    

  }

}


full_join(ocean_volume,
          acidification_volume_all) %>%
  filter(contour != 0) %>%
  mutate(contour = as.factor(contour)) %>%
  ggplot(aes(
    tref,
    100 * volume / volume_total,
    group = contour,
    label = contour
  )) +
  geom_path() +
  geom_path(data = . %>% filter(contour %in% (contours %>% pull(contour))),
            col = "blue") +
  geom_point(shape = 21, fill = "white") +
  geom_text(
    data = . %>%
      filter(tref == 2014,
             basin == "N. Atlantic") %>%
      mutate(tref = tref + 1),
    hjust = 0,
    check_overlap = TRUE,
    size = 2,
    col = "#CC3311"
  ) +
  scale_x_continuous(breaks = c(1994, 2004, 2014),
                     limits = c(1994, 2019)) +
  labs(y = "Acidified volume ratio of top 3000m (%)") +
  theme(
    axis.title.x = element_blank(),
    strip.text.y = element_markdown()
  ) +
  facet_grid(variable ~ basin,
             labeller = labeller(variable = x_axis_labels))

ggsave(
  here::here(
    "output/publication/acidification_volumes.png"
  ),
  width = 10,
  height = 8,
  dpi = 600,
  bg = "white"
)

full_join(ocean_volume,
          acidification_volume_all) %>%
  filter(contour != 0) %>%
  mutate(volume = 100 * volume / volume_total) %>%
  pivot_wider(names_from = tref,
              values_from = volume) %>% 
  mutate(delta_volume = `2014` - `1994`) %>% 
  filter(!is.na(delta_volume)) %>% 
  # filter(basin == "Global",
  #        variable == "pH") %>% 
  ggplot(aes(
    contour,
    delta_volume,
    col = basin
  )) +
  geom_path() +
  geom_point(shape = 21, fill = "white") +
  scale_color_okabeito() +
  labs(y = "Acidified volume change 1994 - 2014 \n(% of top 3000m volume)",
       x = "acidification threshold") +
  theme(
    strip.text.x = element_markdown(),
    legend.position = c(0.8,0.25)
  ) +
  facet_wrap(~ variable,
             scales = "free_x",
             labeller = labeller(variable = x_axis_labels)) +
  facetted_pos_scales(x = x_axis_scales)

ggsave(
  here::here(
    "output/publication/acidification_volume_changes.png"
  ),
  width = 8,
  height = 6,
  dpi = 600,
  bg = "white"
)


full_join(ocean_volume_biome,
          acidification_volume_biome_all) %>%
  filter(contour != 0,
         !is.na(biome)) %>%
  ggplot(aes(
    tref,
    100 * volume / volume_total,
    group = contour,
    label = contour
  )) +
  geom_path() +
  geom_path(data = . %>% filter(contour %in% (contours %>% pull(contour))),
            col = "blue")+
  geom_point(shape = 21, fill = "white") +
  geom_text(
    data = . %>%
      filter(tref == 2014,
             biome == "NA-SPSS") %>%
      mutate(tref = tref + 1),
    hjust = 0,
    check_overlap = TRUE,
    size = 2,
    col = "#CC3311"
  ) +
  scale_x_continuous(breaks = c(1994, 2004, 2014),
                     limits = c(1994, 2019)) +
  labs(y = "Acidified volume ratio of top 3000m (%)") +
  theme(
    axis.title.x = element_blank(),
    strip.text.y = element_markdown()
  ) +
  facet_grid(variable ~ biome,
             labeller = labeller(variable = x_axis_labels))

ggsave(
  here::here(
    "output/publication/acidification_volumes_biome.png"
  ),
  width = 10,
  height = 8,
  dpi = 600,
  bg = "white"
)

full_join(ocean_volume_biome,
          acidification_volume_biome_all) %>%
  filter(contour != 0,
         !is.na(biome)) %>%
  mutate(volume = 100 * volume / volume_total) %>%
  pivot_wider(names_from = tref,
              values_from = volume) %>% 
  mutate(delta_volume = `2014` - `1994`) %>% 
  filter(!is.na(delta_volume)) %>% 
  ggplot(aes(
    contour,
    delta_volume,
    col = biome
  )) +
  geom_path() +
  geom_point(shape = 21, fill = "white") +
  scale_color_okabeito() +
  labs(y = "Acidified volume change 1994 - 2014 \n(% of top 3000m volume)",
       x = "acidification threshold") +
  theme(
    strip.text.x = element_markdown(),
    legend.position = c(0.8,0.25)
  ) +
  facet_wrap(~ variable,
             scales = "free_x",
             labeller = labeller(variable = x_axis_labels)) +
  facetted_pos_scales(x = x_axis_scales)

ggsave(
  here::here(
    "output/publication/acidification_volume_changes_biomes.png"
  ),
  width = 8,
  height = 6,
  dpi = 600,
  bg = "white"
)


rm(acidification_volume_all,
   acidification_volume,
   acidification_volume_biome_all,
   acidification_volume_biome,
   acidification_volume_raw,
   acidification_horizon)



acidification_trend_long <-
  acidification_trend %>%
  filter(depth <= ocean_depth) %>%
  select(depth, tref, all_of(OIA_variables)) %>%
  pivot_longer(tco2:temp) %>%
  mutate(tref = as.factor(tref)) %>%
  filter(name %in% OIA_variables[c(1:3, 5)])


acidification_trend_long %>%
  ggplot(aes(value, col = tref, fill = tref)) +
  geom_density(alpha = 0.3) +
  scale_fill_manual(values = c("grey50", three_year_colors)) +
  scale_color_manual(values = c("grey50", three_year_colors)) +
  facet_wrap( ~ name,
              scales = "free",
              labeller = labeller(name = x_axis_labels_stations_absolute)) +
  theme(axis.title = element_blank(),
        legend.title = element_blank(),
        strip.text.x = element_markdown())

ggsave(
  here::here(
    "output/publication/acidification_volume_distribution_absolute.png"
  ),
  width = 8,
  height = 6,
  dpi = 600,
  bg = "white"
)

acidification_trend_long <-
  acidification_trend %>%
  filter(depth <= ocean_depth,
         tref != 1800) %>%
  select(depth, tref, contains("delta_total")) %>%
  pivot_longer(contains("delta_total")) %>% 
  mutate(name = str_remove(name, "_delta_total"),
         tref = as.factor(tref)) %>% 
  filter(name %in% OIA_variables[c(1:3,5)])


acidification_trend_long %>%
  ggplot(aes(value, col = tref, fill = tref)) +
  geom_density(alpha = 0.3) +
  scale_fill_manual(values = three_year_colors) +
  scale_color_manual(values = three_year_colors) +
  facet_wrap( ~ name,
              scales = "free",
              labeller = labeller(name = x_axis_labels)) +
  theme(axis.title = element_blank(),
        legend.title = element_blank(),
        strip.text.x = element_markdown())

ggsave(
  here::here(
    "output/publication/acidification_volume_distribution_delta_total.png"
  ),
  width = 8,
  height = 6,
  dpi = 600,
  bg = "white"
)

# acidification_trend_long %>%
#   ggplot(aes(value, depth, col = tref)) +
#   geom_density_2d(bins = 2) +
#   scale_y_reverse() +
#   scale_color_manual(values = three_year_colors) +
#   facet_wrap( ~ name,
#               scales = "free_x",
#               labeller = labeller(name = x_axis_labels)) +
#   theme(axis.title = element_blank(),
#         legend.title = element_blank(),
#         strip.text.x = element_markdown())
# 
# ggsave(
#   here::here(
#     "output/publication/acidification_volume_depth_distribution_delta_total.png"
#   ),
#   width = 8,
#   height = 6,
#   dpi = 600,
#   bg = "white"
# )

```


# Saturation horizon maps

```{r compute_saturation_horizon_maps}

acidification_saturation_horizon <- acidification_trend %>%
  select(lat, lon, depth, tref,
         contains("Omega"),
         -contains("delta"))

acidification_saturation_horizon <-
  acidification_saturation_horizon %>%
  pivot_longer(
    contains("Omega"),
    names_to = "mineral",
    names_prefix = "Omega",
    values_to = "Omega"
  )

acidification_saturation_horizon %>%
  group_by(tref, mineral) %>%
  summarise(n()) %>%
  ungroup()

bathymetry <-
  acidification_saturation_horizon %>%
  group_by(lat, lon, tref, mineral) %>%
  summarise(depth = max(depth)) %>%
  ungroup()

bathymetry %>% 
  ggplot(aes(lon, lat, fill = depth)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  coord_quickmap() +
  facet_grid(mineral ~ tref)

for(i_sat_level in c(5, 4, 3, 2, 1.5, 1)) {
  
  # i_sat_level <- 2
  
  saturation_horizon_deep <-
    acidification_saturation_horizon %>%
    filter(Omega < i_sat_level) %>%
    group_by(lat, lon, tref, mineral) %>%
    mutate(saturation_horizon_deep = min(depth)) %>%
    ungroup() %>% 
    filter(depth == saturation_horizon_deep)
  
  saturation_horizon_shallow <-
    inner_join(
      acidification_saturation_horizon,
      saturation_horizon_deep %>%
        select(lat, lon, tref, mineral,
               saturation_horizon_deep)
    )
  
  saturation_horizon_shallow <-
    saturation_horizon_shallow %>%
    filter(depth < saturation_horizon_deep) %>%
    group_by(lat, lon, tref, mineral) %>%
    mutate(saturation_horizon_shallow = max(depth)) %>%
    ungroup() %>% 
    filter(depth == saturation_horizon_shallow)
  
  saturation_horizon <-
    bind_rows(saturation_horizon_deep,
              saturation_horizon_shallow) %>%
    select(-contains("saturation_horizon"))
  
  surface_grid <- saturation_horizon %>% 
    distinct(lat, lon, tref, mineral)
  
  surface_grid <-
    expand_grid(
      surface_grid,
      Omega = i_sat_level
    )
  
  saturation_horizon <-
    full_join(saturation_horizon,
              surface_grid)
  
  rm(surface_grid)
  
  saturation_horizon <-
    saturation_horizon %>%
    group_by(lon, lat, tref, mineral) %>%
    mutate(n = n()) %>%
    ungroup()
  
  saturation_horizon <-
    saturation_horizon %>%
    filter(n == 3) %>%
    select(-n)
  
  saturation_horizon <-
    saturation_horizon %>%
    arrange(lat, lon, tref, mineral, Omega) %>% 
    group_by(lon, lat, tref, mineral) %>%
    mutate(depth = approxfun(Omega, depth, rule = 1)(Omega)) %>%
    ungroup()
  
  saturation_horizon <-
    saturation_horizon %>%
    filter(Omega == i_sat_level) %>%
    select(lon, lat, tref, mineral, depth)
  
  print(
    nrow(saturation_horizon) == nrow(saturation_horizon_shallow))
  
  # fill regions with saturation horizon at surface
  
  saturation_horizon <-
    bind_rows(
      saturation_horizon,
      saturation_horizon_deep %>%
        filter(saturation_horizon_deep == 0) %>%
        select(lon, lat, tref, depth, mineral, depth)
    )
  
  # fill other regions with bathymetry
  
  bathymetry_fill <-
    anti_join(bathymetry,
              saturation_horizon %>%
                select(lat, lon, tref, mineral))
  
  saturation_horizon <-
    bind_rows(
      saturation_horizon,
      bathymetry_fill
    )
  
  saturation_horizon <- saturation_horizon %>%
    mutate(sat_level = i_sat_level)
  
  
  rm(saturation_horizon_deep,
     saturation_horizon_shallow,
     bathymetry_fill)
  
  if (exists("acidification_saturation_horizon_levels")) {
    acidification_saturation_horizon_levels <-
      bind_rows(acidification_saturation_horizon_levels,
                saturation_horizon)
  }
  
  if (!exists("acidification_saturation_horizon_levels")) {
    acidification_saturation_horizon_levels <- saturation_horizon
  }
  
  
  # calculate volume of supersaturated waters
  
  saturation_volume <- inner_join(saturation_horizon,
                                  basinmask)
  
  saturation_volume <- saturation_volume %>% 
    mutate(volume = depth * area) %>% 
    group_by(tref, mineral, basin) %>% 
    summarise(volume = sum(volume, na.rm = TRUE)) %>% 
    ungroup()
  
  saturation_volume_global <- saturation_volume %>% 
    group_by(tref, mineral) %>% 
    summarise(volume = sum(volume, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(basin = "Global")
  
  
  saturation_volume <- bind_rows(saturation_volume,
                                 saturation_volume_global) %>%
    mutate(sat_level = i_sat_level)
  

  if (exists("acidification_volume")) {
    acidification_volume <-
      bind_rows(acidification_volume, saturation_volume)
  }
  
  if (!exists("acidification_volume")) {
    acidification_volume <- saturation_volume
  }
  
  
  # calculate volume of supersaturated waters
  
  saturation_volume_biome <- inner_join(saturation_horizon,
                                  biomemask)
  
  saturation_volume_biome <- saturation_volume_biome %>% 
    mutate(volume = depth * area) %>% 
    group_by(tref, mineral, biome) %>% 
    summarise(volume = sum(volume, na.rm = TRUE)) %>% 
    ungroup()
  
  saturation_volume_biome <- saturation_volume_biome %>% 
    mutate(sat_level = i_sat_level)
  

  if (exists("acidification_volume_biome")) {
    acidification_volume_biome <-
      bind_rows(acidification_volume_biome, saturation_volume_biome)
  }
  
  if (!exists("acidification_volume_biome")) {
    acidification_volume_biome <- saturation_volume_biome
  }
  
  # calculate profiles of saturated area fraction
  
  saturation_profile <-
    inner_join(acidification_saturation_horizon,
               basinmask) %>%
    mutate(saturated = if_else(Omega >= i_sat_level,
                               "super",
                               "under")) %>%
    group_by(tref, basin, depth, mineral, saturated) %>%
    summarise(area = sum(area)) %>%
    ungroup() %>%
    group_by(tref, basin, depth, mineral) %>%
    mutate(area_fraction = 100 * area / sum(area)) %>%
    ungroup()
  
  saturation_profile_global <-
    inner_join(acidification_saturation_horizon,
               basinmask) %>%
    mutate(saturated = if_else(Omega >= i_sat_level,
                               "super",
                               "under")) %>%
    group_by(tref, depth, mineral, saturated) %>%
    summarise(area = sum(area)) %>%
    ungroup() %>%
    group_by(tref, depth, mineral) %>%
    mutate(area_fraction = 100 * area / sum(area)) %>%
    ungroup() %>%
    mutate(basin = "Global")
  
  saturation_profile <- bind_rows(saturation_profile,
                                  saturation_profile_global) %>%
    mutate(sat_level = i_sat_level)
  
  if (exists("acidification_area_profile")) {
    acidification_area_profile <-
      bind_rows(acidification_area_profile, saturation_profile)
  }
  
  if (!exists("acidification_area_profile")) {
    acidification_area_profile <- saturation_profile
  }
  
  rm(saturation_profile, saturation_profile_global)
 
  
  # calculate profiles of saturated area fraction
  
  saturation_profile_biome <-
    inner_join(acidification_saturation_horizon,
               biomemask) %>%
    mutate(saturated = if_else(Omega >= i_sat_level,
                               "super",
                               "under")) %>%
    group_by(tref, biome, depth, mineral, saturated) %>%
    summarise(area = sum(area)) %>%
    ungroup() %>%
    group_by(tref, biome, depth, mineral) %>%
    mutate(area_fraction = 100 * area / sum(area)) %>%
    ungroup()
  
 saturation_profile_biome <- saturation_profile_biome %>% 
    mutate(sat_level = i_sat_level)
  
  if (exists("acidification_area_profile_biome")) {
    acidification_area_profile_biome <-
      bind_rows(acidification_area_profile_biome, saturation_profile_biome)
  }
  
  if (!exists("acidification_area_profile_biome")) {
    acidification_area_profile_biome <- saturation_profile_biome
  }
  
  rm(saturation_profile_biome)
 
  
}

for (i_sat_level in unique(acidification_saturation_horizon_levels$sat_level)) {
  
  # i_sat_level <- unique(acidification_saturation_horizon_levels$sat_level)[1]
  
  print(
  acidification_saturation_horizon_levels %>%
    relocate(lon) %>%
    filter(sat_level == i_sat_level) %>% 
    select(-sat_level) %>% 
    p_map_mdim_robinson(
      dim_row = "tref",
      dim_col = "mineral",
      var = "depth",
      legend_title = paste0("Ω=",i_sat_level,"<br>horizon<br>(m)"),
      legend_position = "right",
      breaks = seq(6000, 0, -500)
    )
  )
  
  ggsave(
  here::here(
    paste0("output/publication/maps_saturation_horizon_absolute_state_sat_level_",i_sat_level,".png")
  ),
  width = 6,
  height = 6,
  dpi = 600,
  bg = "white"
)
  
}

for (i_sat_level in unique(acidification_saturation_horizon_levels$sat_level)) {
  
  print(
    acidification_saturation_horizon_levels %>%
      filter(sat_level == i_sat_level) %>%
      select(-sat_level) %>%
      arrange(tref) %>%
      group_by(lat, lon, mineral) %>%
      mutate(n = n()) %>%
      filter(n == 4) %>%
      mutate(
        delta_depth = depth - first(depth),
        period = paste(first(tref), "-", tref)
      ) %>%
      ungroup() %>%
      filter(tref != 1800) %>%
      drop_na() %>%
      select(lon, lat, period, mineral, delta_depth) %>%
      p_map_mdim_robinson(
        dim_row = "period",
        dim_col = "mineral",
        col = "div",
        var = "delta_depth",
        legend_title = paste0("ΔΩ=", i_sat_level, "<br>horizon<br>(m)"),
        legend_position = "right",
        breaks = c(-Inf, seq(-300, 300, 50), Inf)
      )
  )
  
  ggsave(
    here::here(
      paste0(
        "output/publication/maps_saturation_horizon_total_change_sat_level_",
        i_sat_level,
        ".png"
      )
    ),
    width = 6,
    height = 4,
    dpi = 600,
    bg = "white"
  )
  
  
}


for (i_sat_level in unique(acidification_saturation_horizon_levels$sat_level)) {
  print(
    acidification_saturation_horizon_levels %>%
      filter(sat_level == i_sat_level) %>%
      select(-sat_level) %>%
      arrange(tref) %>%
      group_by(lat, lon, mineral) %>%
      mutate(n = n()) %>% 
      filter(n == 4) %>% 
      mutate(
        delta_depth = depth - lag(depth),
        period = paste(lag(tref), "-", tref)
      ) %>%
      ungroup() %>%
      filter(tref != 1800) %>% 
      drop_na() %>%
      select(lon, lat, period, mineral, delta_depth) %>%
      p_map_mdim_robinson(
        dim_row = "period",
        dim_col = "mineral",
        col = "div",
        var = "delta_depth",
        legend_title = paste0("ΔΩ=", i_sat_level, "<br>horizon<br>(m)"),
        legend_position = "right",
        breaks = c(-Inf, seq(-300, 300, 50), Inf)
      ) +
      labs(title = paste("Saturation threshold:", i_sat_level))
  )
  
    
  ggsave(
    here::here(
      paste0(
        "output/publication/maps_saturation_horizon_incremental_change_sat_level_",
        i_sat_level,
        ".png"
      )
    ),
    width = 6,
    height = 4,
    dpi = 600,
    bg = "white"
  )
}



acidification_volume <-
  full_join(acidification_volume,
            ocean_volume)

acidification_volume <-
  acidification_volume %>%
  arrange(tref) %>%
  group_by(mineral, basin, sat_level) %>%
  mutate(
    volume_loss =
      volume - lag(volume, default = first(volume)),
    volume_loss_relative_to_preind_volume =
      100 * volume_loss / first(volume),
    volume_loss_cumulative =
      volume - first(volume),
    volume_loss_cumulative_relative_to_preind_volume =
      100 * volume_loss_cumulative / first(volume),
    volume_relative_to_3000m_volume = 100 * volume / volume_total,
    volume_loss_relative_to_3000m_volume = 100 * volume_loss / volume_total,
    volume_loss_cumulative_relative_to_3000m_volume = 100 * volume_loss_cumulative / volume_total,
  ) %>%
  ungroup()

acidification_volume <-
  acidification_volume %>%
  select(-volume_total) %>% 
  pivot_longer(contains("volume"),
               names_to = "estimate",
               values_to = "value")


pdf(
  here::here("output/all_variables/saturation_volumes.pdf"),
  width = 10,
  height = 8
)

print(
  acidification_volume %>%
    mutate(sat_level = as.factor(sat_level),
           tref = as.factor(tref),
           estimate = str_replace_all(estimate, "_", " ")) %>%
    group_by(estimate) %>%
    group_split() %>%
    # head(1) %>%
    map(
      ~ ggplot(data = .x,
               aes(sat_level, value, fill = tref)) +
        labs(y = .x$estimate,
             x = "Saturation threshold") +
        geom_col(position = "dodge") +
        scale_fill_viridis_d() +
        theme(legend.title = element_blank()) +
        facet_nested_wrap(vars(basin, mineral))
    )
)

dev.off()

# volume_relative_to_3000m_volume
# volume_loss_cumulative_relative_to_preind_volume
# volume_loss_cumulative_relative_to_3000m_volume


acidification_volume_biome <-
  full_join(acidification_volume_biome,
            ocean_volume_biome)

acidification_volume_biome <-
  acidification_volume_biome %>%
  arrange(tref) %>%
  group_by(mineral, biome, sat_level) %>%
  mutate(
    volume_loss =
      volume - lag(volume, default = first(volume)),
    volume_loss_relative_to_preind_volume =
      100 * volume_loss / first(volume),
    volume_loss_cumulative =
      volume - first(volume),
    volume_loss_cumulative_relative_to_preind_volume =
      100 * volume_loss_cumulative / first(volume),
    volume_relative_to_3000m_volume = 100 * volume / volume_total,
    volume_loss_relative_to_3000m_volume = 100 * volume_loss / volume_total,
    volume_loss_cumulative_relative_to_3000m_volume = 100 * volume_loss_cumulative / volume_total,
  ) %>%
  ungroup()

acidification_volume_biome <-
  acidification_volume_biome %>%
  select(-volume_total) %>% 
  pivot_longer(contains("volume"),
               names_to = "estimate",
               values_to = "value")

pdf(
  here::here("output/all_variables/saturation_volumes_biomes.pdf"),
  width = 10,
  height = 8
)

print(
  acidification_volume_biome %>%
    mutate(sat_level = as.factor(sat_level),
           tref = as.factor(tref),
           estimate = str_replace_all(estimate, "_", " ")) %>%
    group_by(estimate) %>%
    group_split() %>%
    # head(1) %>%
    map(
      ~ ggplot(data = .x,
               aes(sat_level, value, fill = tref)) +
        labs(y = .x$estimate,
             x = "Saturation threshold") +
        geom_col(position = "dodge") +
        scale_fill_viridis_d() +
        theme(legend.title = element_blank()) +
        facet_nested_wrap(vars(biome, mineral))
    )
)

dev.off()



rm(acidification_saturation_horizon,
   acidification_saturation_horizon_levels,
   acidification_volume,
   acidification_area_profile)

```


# Zonal sections

## Computation

```{r compute_zonal_mean_sections, eval=FALSE}

acidification_zonal <- acidification_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()



```


```{r compute_zonal_mean_sections_dCant_temp, eval=FALSE}

acidification_zonal_dCant_temp <- dCant_temp_trend %>%
  group_by(tref, driver) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()



```


```{r compute_zonal_mean_sections_buffer, eval=FALSE}

acidification_zonal_buffer <- buffer_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()

```


## Incremental changes

### dCant + Temperature

```{r zonal_dcant_temp_change, eval=FALSE}

acidification_zonal_dCant_temp <-
  acidification_zonal_dCant_temp %>%
  select(-contains("_sd")) %>% 
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))

# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_dCant_temp_changes.pdf"),
  width = 20,
  height = 6
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[10]
  
  # subset OIA variable
  
  i_acidification_zonal_dCant_temp <-
    acidification_zonal_dCant_temp %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_zonal_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_zonal_dcant_temp <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_dCant_temp %>% 
        filter(driver == "dCant + temp"),
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = "Driver: dCant + temp",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)
  
  p_zonal_dcant <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_dCant_temp %>% 
        filter(driver == "dCant"),
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = "Driver: dCant",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)

  p_decadal_offset <-
    i_acidification_zonal_dCant_temp %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, driver, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = "Decadal difference",
      subtitle_text = NULL
    ) +
    facet_grid(driver ~ basin_AIP)

  p_temperature_offset <-
    i_acidification_zonal_dCant_temp %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, driver, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant + temp` - `dCant`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = "Driver difference",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)
  
  print(
    wrap_plots(
      p_zonal_dcant &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_zonal_dcant_temp &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_decadal_offset,
      p_temperature_offset,
      ncol = 2
    )
  )
  
}

dev.off()

rm(acidification_zonal_dCant_temp)

```

### dCant

```{r zonal_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_zonal_incremental <-
  acidification_zonal %>%
  select(MLR_basins:basin_AIP,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_zonal_uncertainty <-
  acidification_zonal_incremental %>%
  mutate(lat = as.numeric(as.character(cut(
    lat, seq(-90, 90, 10), seq(-85, 85, 10)
  ))),
  depth = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  )))
  ) %>%
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean)) %>%
  ungroup()

# compute uncertainty

acidification_zonal_uncertainty <-
  additive_uncertainty(acidification_zonal_uncertainty)

delta_acidification_zonal_uncertainty <- acidification_zonal_uncertainty[[3]]
acidification_zonal_uncertainty <- acidification_zonal_uncertainty[[1]]


# subset reference reconstruction

acidification_zonal_incremental <-
  acidification_zonal_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_incremental_changes.pdf"),
  width = 12,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_incremental <-
    acidification_zonal_incremental %>%
    filter(variable == i_var,
           depth <= 3000)
  
  i_acidification_zonal_uncertainty = acidification_zonal_uncertainty %>%
    filter(variable == i_var,
           depth <= 3000)

  i_delta_acidification_zonal_uncertainty = delta_acidification_zonal_uncertainty %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_zonal_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_zonal_dec <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_incremental,
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_single == 0),
      aes(lat, depth),
      shape = 20,
      size = 1,
      col = "grey"
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_double == 0),
      aes(lat, depth),
      shape = 20,
      size = 0.1,
      col = "grey"
    ) +
    facet_grid(tref ~ basin_AIP)

  
  
  
  p_zonal_offset <-
    i_acidification_zonal_incremental %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = NULL,
      subtitle_text = NULL
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_single == 0),
      aes(lat, depth),
      shape = 20,
      size = 1
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_double == 0),
      aes(lat, depth),
      shape = 20,
      size = 0.1
    ) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_zonal_dec &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_zonal_offset,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_incremental,
   acidification_zonal_uncertainty,
   delta_acidification_zonal_uncertainty
   )

```

## Total changes


```{r zonal_total_change, eval=FALSE}

# subset total change sections

acidification_zonal_total <-
  acidification_zonal %>%
  select(tref:basin_AIP,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_zonal_total <-
  acidification_zonal_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_total_changes.pdf"),
  width = 10,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_total <-
    acidification_zonal_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_total,
      var = "delta_total",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_total,
      aes(lat, depth, z = delta_total),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_total %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = delta_total,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_total,
   i_acidification_zonal_total)

```



```{r zonal_total_change_buffer, eval=FALSE}

# subset total change sections

acidification_zonal_buffer_total <-
  acidification_zonal_buffer %>%
  select(tref:basin_AIP,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_zonal_buffer_total <-
  acidification_zonal_buffer_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_total_changes_buffer.pdf"),
  width = 10,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables) {
  # i_var <- buffer_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_buffer_total <-
    acidification_zonal_buffer_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_buffer_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_buffer_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_buffer_total,
      var = "delta_total",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_buffer_total,
      aes(lat, depth, z = delta_total),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_buffer_total %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = delta_total,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_buffer_total,
   i_acidification_zonal_buffer_total)

```


## Absolute state

```{r zonal_absolute_state, eval=FALSE}

# subset absolute value sections

acidification_zonal_absolute <-
  acidification_zonal %>%
  select(tref:basin_AIP,
         contains("_mean"),
         -contains(c("_sd", "_delta")))

acidification_zonal_absolute <-
  acidification_zonal_absolute %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))

# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_absolute_state.pdf"),
  width = 8,
  height = 8
)
# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_absolute <-
    acidification_zonal_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_absolute,
      var = "mean",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_absolute,
      aes(lat, depth, z = mean),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_absolute %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = mean,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()


rm(acidification_zonal_absolute,
   acidification_zonal,
   i_acidification_zonal_absolute)

```


```{r zonal_absolute_state_buffer, eval=FALSE}

# subset absolute value sections

acidification_zonal_buffer_absolute <-
  acidification_zonal_buffer %>%
  select(tref:basin_AIP,
         contains("_mean"),
         -contains(c("_sd", "_delta")))

acidification_zonal_buffer_absolute <-
  acidification_zonal_buffer_absolute %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))

# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_absolute_state_buffer.pdf"),
  width = 8,
  height = 8
)
# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables) {
  # i_var <- buffer_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_buffer_absolute <-
    acidification_zonal_buffer_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_buffer_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_buffer_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_buffer_absolute,
      var = "mean",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_buffer_absolute,
      aes(lat, depth, z = mean),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_buffer_absolute %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = mean,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()


rm(acidification_zonal_buffer_absolute,
   acidification_zonal_buffer,
   i_acidification_zonal_buffer_absolute)

```



# Global sections

## Computation

```{r compute_global_sections}

acidification_global_section <- acidification_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_section_global_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()

```

## Incremental changes

```{r global_section_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_global_section_incremental <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_global_section_uncertainty <-
  acidification_global_section_incremental %>%
  mutate(dist = as.numeric(as.character(cut(
    dist, seq(0, 50, 1), seq(0.5, 49.5, 1)
  ))),
  depth = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  )))) %>%
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean)) %>%
  ungroup()

# compute uncertainty

acidification_global_section_uncertainty <-
  additive_uncertainty(acidification_global_section_uncertainty)

delta_acidification_global_section_uncertainty <- acidification_global_section_uncertainty[[3]]
acidification_global_section_uncertainty <- acidification_global_section_uncertainty[[1]]


# subset reference reconstruction

acidification_global_section_incremental <-
  acidification_global_section_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/global_sections_incremental_changes.pdf"),
  width = 10,
  height = 12
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_global_section_incremental <-
    acidification_global_section_incremental %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_global_section_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_global_section_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_global_section_dec1 <-
    i_acidification_global_section_incremental %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "delta_interval",
      legend_title = i_var,
      title_text = "A   1994 - 2004",
      df_uncertainty = acidification_global_section_uncertainty %>%
        filter(tref == 2004,
               variable == i_var),
      breaks = breaks,
      col_uncertainty = "grey",
      subtitle_text = NULL,
      plot_slabs = "n"
    ) &
    theme(axis.title.x = element_blank(),
          axis.text.x.bottom = element_blank())
  
  p_global_section_dec2 <-
    i_acidification_global_section_incremental %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "delta_interval",
      title_text = "B   2004 - 2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      df_uncertainty = acidification_global_section_uncertainty %>%
        filter(tref == 2014,
               variable == i_var),
      col_uncertainty = "grey",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  p_global_section_offset <-
    i_acidification_global_section_incremental %>%
    arrange(depth, dist) %>%
    select(depth, dist, tref, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_global(
      var = "delta_delta_interval",
      legend_title = paste("delta\n", i_var),
      df_uncertainty = delta_acidification_global_section_uncertainty %>%
        filter(variable == i_var),
      plot_slabs = "n",
      col = "div",
      title_text = "C   Decadal difference",
      subtitle_text = NULL
    )
  
  print(
    wrap_plots(
      p_global_section_dec1,
      p_global_section_dec2 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_offset &
        theme(axis.text.x.top = element_blank()),
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_global_section_incremental,
   acidification_global_section_uncertainty,
   delta_acidification_global_section_uncertainty
   )

```

## Total changes

```{r global_section_total_change}

# subset total change sections

acidification_global_section_total <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_global_section_total <-
  acidification_global_section_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[2]
  
  # subset OIA variable
  
  i_acidification_global_section_total <-
    acidification_global_section_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  all_labels_breaks <- labels_breaks(i_var)
  i_breaks        <- unlist(all_labels_breaks[1])
  i_contour_level <- unlist(all_labels_breaks[2])
  i_legend_title  <- unlist(all_labels_breaks[3])
  
  p_global_section_period1 <-
    i_acidification_global_section_total %>%
    filter(tref == 1994) %>%
    p_section_global(
      var = "delta_total",
      title_text = "A   1800 - 1994",
      legend_title = i_legend_title,
      contour_level = i_contour_level,
      breaks = i_breaks,
      subtitle_text = NULL,
      plot_slabs = "n"
    )
  
  p_global_section_period2 <-
    i_acidification_global_section_total %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "delta_total",
      legend_title = i_legend_title,
      contour_level = i_contour_level,
      title_text = "B   1800 - 2004",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = i_breaks
    )
  
  p_global_section_period3 <-
    i_acidification_global_section_total %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "delta_total",
      legend_title = i_legend_title,
      contour_level = i_contour_level,
      title_text = "C   1800 - 2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = i_breaks
    )
  
  
  print(
    wrap_plots(
      p_global_section_period1 &
        theme(axis.title.x = element_blank(),
              axis.text.x.bottom = element_blank()),
      p_global_section_period2 &
        theme(
          axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          legend.position = "none"
        ),
      p_global_section_period3 &
        theme(axis.text.x.top = element_blank(),
              legend.position = "none"),
      ncol = 1
    )
  )
  
  ggsave(
    here::here(
      paste0(
        "output/publication/global_sections_",
        i_var,
        "_total_changes.png"
      )
    ),
    width = 6,
    height = 8,
    dpi = 600,
    bg = "white"
  )
  
}

rm(acidification_global_section_total,
   i_acidification_global_section_total)

```

## Absolute state

```{r global_section_absolute_state, eval=FALSE}

# subset absolute value sections

acidification_global_section_absolute <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_mean"),
         -contains(c("_sd", "_delta")))


# subset reference reconstruction

acidification_global_section_absolute <-
  acidification_global_section_absolute %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/global_sections_absolute_state.pdf"),
  width = 10,
  height = 16
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_global_section_absolute <-
    acidification_global_section_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_global_section_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(.02), names = FALSE)
  
  high <- i_acidification_global_section_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(.98), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = 10), Inf)
  
  p_global_section_period1 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 1800) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "A   1800",
      breaks = breaks,
      subtitle_text = NULL,
      plot_slabs = "n"
    ) &
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          axis.text.x.bottom = element_blank())
  
  p_global_section_period2 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 1994) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "B   1994",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    )
  
  p_global_section_period3 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "C   2004",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  p_global_section_period4<-
    i_acidification_global_section_absolute %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "D   2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  
  print(
    wrap_plots(
      p_global_section_period1,
      p_global_section_period2 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_period3 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_period4 &
        theme(axis.text.x.top = element_blank()),
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_global_section_absolute,
   acidification_global_section,
   i_acidification_global_section_absolute)

```




# Profiles

## Computation


```{r compute_mean_profiles_total_acidification}

# join with 3D acidification fields

acidification_profiles <-
  full_join(basinmask,
            acidification_trend %>%
              select(-c(basin_AIP, contains("temp")))) %>%
  drop_na() %>%
  relocate(tref)

# scale values to surface area

acidification_profiles <- acidification_profiles %>% 
  mutate(across(gamma:H_free_delta_interval,
                ~ . * area))

# calculate regional means

acidification_profiles_regional <- acidification_profiles %>%
  group_by(tref, basin, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

acidification_profiles_global <- acidification_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
acidification_profiles <-
  bind_rows(acidification_profiles_global,
            acidification_profiles_regional)
  
rm(acidification_profiles_regional,
   acidification_profiles_global)


acidification_profiles <- acidification_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_total_acidification_biomes}

# join with 3D acidification fields

acidification_profiles_biomes <-
  full_join(biomemask,
            acidification_trend %>%
              select(-c(basin_AIP, contains("temp")))) %>%
  drop_na() %>%
  relocate(tref)

# scale values to surface area

acidification_profiles_biomes <- acidification_profiles_biomes %>% 
  mutate(across(gamma:H_free_delta_interval,
                ~ . * area))

# calculate regional means

acidification_profiles_biomes_regional <- acidification_profiles_biomes %>%
  group_by(tref, biome, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

acidification_profiles_biomes_global <- acidification_profiles_biomes %>%
  mutate(region = "Global",
         biome = "Global") %>% 
  group_by(tref, biome, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
acidification_profiles_biomes <-
  bind_rows(#acidification_profiles_biomes_global,
            acidification_profiles_biomes_regional)
  
rm(acidification_profiles_biomes_regional,
   acidification_profiles_biomes_global)


acidification_profiles_biomes <- acidification_profiles_biomes %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_total_acidification_stations}

lat_lon_radius <- 3

TS_product_stations <-
  TS_product %>%
  group_by(station) %>%
  summarise(lat_centre = mean(lat),
            lon_centre = mean(lon)) %>%
  ungroup() %>%
  mutate(
    lat_south = case_when(station == "BATS" ~ lat_centre - lat_lon_radius,
                          station == "ALOHA" ~ lat_centre),
    lat_north = case_when(station == "BATS" ~ lat_centre,
                          station == "ALOHA" ~ lat_centre + lat_lon_radius),
    lon_east = case_when(station == "BATS" ~ lon_centre - lat_lon_radius / 2,
                         station == "ALOHA" ~ lon_centre),
    lon_west = case_when(station == "BATS" ~ lon_centre + lat_lon_radius / 2,
                         station == "ALOHA" ~ lon_centre + lat_lon_radius)
    )



for (i_station in unique(TS_product_stations$station)) {
  # i_station <- unique(TS_product_stations$station)[1]
  
  i_TS_product_stations <- TS_product_stations %>%
    filter(station == i_station)
  
  acidification_profiles_station <-
    cross_join(i_TS_product_stations,
               acidification_trend %>%
                 select(-c(basin_AIP)))
  
  
  acidification_profiles_station <-
    acidification_profiles_station %>%
    filter(
      between(lat, lat_south, lat_north),
      between(lon, lon_east, lon_west)
    ) %>%
    select(-contains("centre"))
  
  if (exists("acidification_profiles_station_all")) {
    acidification_profiles_station_all <-
      bind_rows(
        acidification_profiles_station_all,
        acidification_profiles_station
      )
  }
  
  if (!exists("acidification_profiles_station_all")) {
    acidification_profiles_station_all <-
      acidification_profiles_station
  }
  
}

acidification_profiles_station <-
  acidification_profiles_station_all
rm(acidification_profiles_station_all)

map +
  geom_tile(data = acidification_profiles_station %>%
              group_by(station, lat, lon) %>% 
              summarise(depth = max(depth)) %>% 
              ungroup(),
            aes(lon, lat, fill = depth)) +
  scale_fill_viridis_c(direction = -1) +
  geom_tile(data = TS_product_stations,
            aes(lon_centre, lat_centre, width = 1, height = 1),
            fill = "red")


# scale values to surface area

acidification_profiles_station <-
  acidification_profiles_station %>%
    filter(tref %in% c(1994,2014)) %>% 
    select(station, tref, lon, lat, depth,
           all_of(OIA_variables)) %>% 
    arrange(tref) %>% 
    group_by(station, lat, lon, depth) %>% 
    mutate(across(where(is.numeric), ~ .x - first(.x))) %>% 
    ungroup() %>% 
    filter(tref == 20) %>% 
    mutate(tref = "reconstruction\n1994-2014")

  
acidification_profiles_station <-
  acidification_profiles_station %>%
  mutate(area = earth_surf(lat, lon),
         across(tco2:temp,
                ~ . * area))
  
# acidification_profiles_station <-
#   acidification_profiles_station %>%
#   mutate(area = earth_surf(lat, lon),
#          across(contains("_delta_interval"),
#                 ~ . * area))

# calculate regional means

acidification_profiles_station <- acidification_profiles_station %>%
  group_by(tref, station, depth) %>%
  summarise(across(tco2:temp,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

acidification_profiles_station <- acidification_profiles_station %>%
  mutate(tref = as.factor(tref))



```

```{r compute_mean_profiles_temperature_trend}

dCant_temp_trend_temp_contribution <- dCant_temp_trend %>% 
  select(lon, lat, depth, tref, driver, contains("delta_interval")) %>% 
  pivot_longer(contains("delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>% 
  pivot_wider(values_from = delta_interval,
              names_from = driver) %>% 
  mutate(delta_interval_temp = `dCant + temp` - dCant) %>% 
  select(-contains("dcant")) %>%
  pivot_wider(names_from = tref,
              values_from = delta_interval_temp) %>% 
  mutate(`2014` = `2014` + `2004`) %>% 
  pivot_longer(c(`2014`, `2004`),
               names_to = "tref",
               values_to = "delta_total_temp") %>% 
  pivot_wider(names_from = variable,
              values_from = delta_total_temp)
  

# join with 3D acidification fields

dCant_temp_profiles_temp_contribution <-
  full_join(basinmask,
            dCant_temp_trend_temp_contribution)

# scale values to surface area

dCant_temp_profiles_temp_contribution <- dCant_temp_profiles_temp_contribution %>% 
  mutate(across(contains("_delta"),
                ~ . * area))

# calculate regional means

dCant_temp_profiles_temp_contribution_regional <- dCant_temp_profiles_temp_contribution %>%
  group_by(tref, basin, depth) %>%
  summarise(across(contains("_delta"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

dCant_temp_profiles_temp_contribution_global <- dCant_temp_profiles_temp_contribution %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth) %>%
  summarise(across(contains("_delta"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
dCant_temp_profiles_temp_contribution <-
  bind_rows(dCant_temp_profiles_temp_contribution_global,
            dCant_temp_profiles_temp_contribution_regional)
  
rm(dCant_temp_profiles_temp_contribution_regional,
   dCant_temp_profiles_temp_contribution_global)

dCant_temp_profiles_temp_contribution <- dCant_temp_profiles_temp_contribution %>%
  mutate(tref = as.factor(tref))



dCant_temp_profiles_temp_contribution %>%
  select(tref,
         basin,
         depth,
         contains("_delta_interval")) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval")) %>%
  filter(tref != 1800,
         depth <= 3000,
         variable %in% OIA_variables[]) %>%
  ggplot(aes(delta_interval,
             depth,
             col = tref)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(linewidth = 1) +
  scale_color_manual(values = three_year_colors) +
  labs(y = "Depth (m)") +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(basin ~ variable, scales = "free", 
             switch = "x",
             labeller = labeller(variable = x_axis_labels)) +
  facetted_pos_scales(#x = x_axis_scales,
                      y = rep(list(
                        scale_y_continuous(trans = trans_reverser("sqrt"),
                                           breaks = c(0, 100, 500, seq(1500, 5000, 1000)))
                      ), 6))

```

```{r compute_mean_profiles_temperature_trend_biomes}


# join with 3D acidification fields

dCant_temp_profiles_temp_contribution_biome <-
  full_join(biomemask,
            dCant_temp_trend_temp_contribution)

# scale values to surface area

dCant_temp_profiles_temp_contribution_biome <- dCant_temp_profiles_temp_contribution_biome %>% 
  mutate(across(contains("_delta"),
                ~ . * area))

# calculate regional means

dCant_temp_profiles_temp_contribution_biome_regional <- dCant_temp_profiles_temp_contribution_biome %>%
  group_by(tref, biome, depth) %>%
  summarise(across(contains("_delta"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

dCant_temp_profiles_temp_contribution_biome_global <- dCant_temp_profiles_temp_contribution_biome %>%
  mutate(biome = "Global") %>% 
  group_by(tref, biome, depth) %>%
  summarise(across(contains("_delta"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
dCant_temp_profiles_temp_contribution_biome <-
  bind_rows(#dCant_temp_profiles_temp_contribution_biome_global,
            dCant_temp_profiles_temp_contribution_biome_regional)
  
rm(dCant_temp_profiles_temp_contribution_biome_regional,
   dCant_temp_profiles_temp_contribution_biome_global)


dCant_temp_profiles_temp_contribution_biome <- dCant_temp_profiles_temp_contribution_biome %>%
  mutate(tref = as.factor(tref))

dCant_temp_profiles_temp_contribution_biome %>%
  select(tref,
         biome,
         depth,
         contains("_delta_interval")) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval")) %>%
  filter(tref != 1800,
         depth <= 3000,
         variable %in% OIA_variables[]) %>%
  ggplot(aes(delta_interval,
             depth,
             col = tref)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(linewidth = 1) +
  scale_color_manual(values = three_year_colors) +
  labs(y = "Depth (m)") +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(biome ~ variable, scales = "free", 
             switch = "x",
             labeller = labeller(variable = x_axis_labels)) +
  facetted_pos_scales(#x = x_axis_scales,
                      y = rep(list(
                        scale_y_continuous(trans = trans_reverser("sqrt"),
                                           breaks = c(0, 100, 500, seq(1500, 5000, 1000)))
                      ), 6))

```

```{r compute_mean_profiles_DIC_dCant_temperature_trend}


# join with 3D acidification fields

DIC_dCant_temp_profiles <-
  full_join(basinmask,
            dCant_DIC_temp_trend)

# scale values to surface area

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>% 
  mutate(across(contains("_delta_interval"),
                ~ . * area))

# calculate regional means

DIC_dCant_temp_profiles_regional <- DIC_dCant_temp_profiles %>%
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

DIC_dCant_temp_profiles_global <- DIC_dCant_temp_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
DIC_dCant_temp_profiles <-
  bind_rows(DIC_dCant_temp_profiles_global,
            DIC_dCant_temp_profiles_regional)
  
rm(DIC_dCant_temp_profiles_regional,
   DIC_dCant_temp_profiles_global)

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_DIC_dCant_temperature_trend_biome}


# join with 3D acidification fields

DIC_dCant_temp_profiles_biome <-
  full_join(biomemask,
            dCant_DIC_temp_trend)

# scale values to surface area

DIC_dCant_temp_profiles_biome <- DIC_dCant_temp_profiles_biome %>% 
  mutate(across(contains("_delta_interval"),
                ~ . * area))

# calculate regional means

DIC_dCant_temp_profiles_biome <- DIC_dCant_temp_profiles_biome %>%
  group_by(tref, biome, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

DIC_dCant_temp_profiles_biome <- DIC_dCant_temp_profiles_biome %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_buffer, eval=FALSE}


# join with 3D acidification fields

buffer_profiles <-
  full_join(basinmask,
            buffer_trend %>% select(-basin_AIP))

# scale values to surface area

buffer_profiles <- buffer_profiles %>% 
  mutate(across(gammaDIC:tco2_talk_ratio_delta_interval,
                ~ . * area))

# calculate regional means

buffer_profiles_regional <- buffer_profiles %>%
  group_by(tref, basin, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

buffer_profiles_global <- buffer_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
buffer_profiles <-
  bind_rows(buffer_profiles_global,
            buffer_profiles_regional)
  
rm(buffer_profiles_regional,
   buffer_profiles_global)


# rename basins

buffer_profiles <- buffer_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

buffer_profiles <- buffer_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_buffer_biome, eval=FALSE}


# join with 3D acidification fields

buffer_profiles_biome <-
  full_join(biomemask,
            buffer_trend %>% select(-basin_AIP))

# scale values to surface area

buffer_profiles_biome <- buffer_profiles_biome %>% 
  mutate(across(gammaDIC:tco2_talk_ratio_delta_interval,
                ~ . * area))

# calculate regional means

buffer_profiles_biome_regional <- buffer_profiles_biome %>%
  group_by(tref, region, biome, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

buffer_profiles_biome_global <- buffer_profiles_biome %>%
  mutate(region = "Global",
         biome = "Global") %>% 
  group_by(tref, region, biome, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
buffer_profiles_biome <-
  bind_rows(buffer_profiles_biome_global,
            buffer_profiles_biome_regional)
  
rm(buffer_profiles_biome_regional,
   buffer_profiles_biome_global)


buffer_profiles_biome <- buffer_profiles_biome %>%
  mutate(tref = as.factor(tref))

```

## Incremental changes

### DIC + dCant + Temperature

```{r profiles_DIC_dCant_temp_change}


DIC_dCant_temp_profiles <-
  DIC_dCant_temp_profiles %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  filter(variable %in% OIA_variables)


DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  mutate(
    temperature = if_else(str_detect(driver, "temp"), "variable", "climatology"),
    driver = if_else(str_detect(driver, "dCant"), "dCant", "DIC")
  )


DIC_dCant_temp_profiles %>% 
 ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(
    data = . %>% filter(variable == "temp"),
    aes(delta_interval,
        depth,
        linetype = temperature)
  ) +
  geom_path(
    data = . %>% filter(variable != "temp"),
    aes(delta_interval,
        depth,
        col = driver, 
        linetype = temperature)
  ) +
  scale_color_brewer(palette = "Dark2",
                     direction = -1,
                     labels = c(expression(Delta * C[ant]),
                                      expression(Delta * C[total]))) +
  labs(y = "Depth (m)") +
  theme(
    # legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(
    basin ~ variable,
    scales = "free",
    switch = "x",
    labeller = labeller(variable = x_axis_labels)
  ) +
  facetted_pos_scales(y = rep(list(
                        scale_y_continuous(trans = trans_reverser("sqrt"),
                                           breaks = c(0, 100, 500, seq(1500, 5000, 1000)))
                      ), 6))


ggsave(
  here::here(
    paste0(
      "output/publication/profiles_incremental_changes_Cnat_basin.png"
    )
  ),
  width = 10,
  height = 10,
  dpi = 600,
  bg = "white"
)


```

```{r MOBO-DIC_vs_Cant_profiles}


DIC_dCant_temp_profiles %>%
  filter(variable == "tco2",
         basin == "Global",
         temperature == "climatology") %>%
  pivot_wider(names_from = driver,
              values_from = delta_interval) %>% 
  ggplot(aes(y = depth)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(aes(x = dCant, col = "dCant"), linewidth = 2) +
  geom_path(aes(x = DIC, col = "DIC"), linewidth = 2) +
  annotate(
    "text", label = "Anthropogenic\nDIC",
    x = 11.5, y = 200, colour = "#555555"
  ) +
  annotate(
    "text", label = "Total\nDIC",
    x = 4.5, y = 1000, colour = "#4477AA"
  ) +
  scale_color_manual(values = c("#555555", "#4477AA")) +
  scale_fill_manual(values = c("#228833", "#EE6677")) +
  labs(y = "Depth (m)",
       x = expression(Delta*DIC~(µmol~kg^{-1}~decade^{-1}))) +
  coord_cartesian(expand = 0) +
  scale_y_reverse(breaks = seq(0, 5000, 250)) +
  scale_x_continuous(limits = c(0,13),
                     breaks = seq(0,20,2),
                     position = "top") +
  theme_classic() +
  theme(legend.position = "none")

# ggsave(  here::here("output/all_variables/profiles_MOBO-DIC_vs_eMLR_no_fill.jpg"),
#   width = 5,
#   height = 5,
#   dpi = 600)


DIC_dCant_temp_profiles %>%
  filter(variable == "tco2",
         basin == "Global",
         temperature == "climatology") %>%
  pivot_wider(names_from = driver,
              values_from = delta_interval) %>% 
  ggplot(aes(y = depth)) +
  geom_vline(xintercept = 0, col = "grey") +
  stat_difference(aes(xmin = dCant, xmax = DIC), alpha = 0.3,
                  levels = c("Cnat gain", "Cnat loss")) +
  geom_path(aes(x = dCant, col = "dCant"), linewidth = 2) +
  geom_path(aes(x = DIC, col = "DIC"), linewidth = 2) +
  annotate(
    "text", label = "Anthropogenic\nDIC",
    x = 11.5, y = 200, colour = "#555555"
  ) +
  annotate(
    "text", label = "Total\nDIC",
    x = 4.5, y = 1000, colour = "#4477AA"
  ) +
  annotate(
    "text", label = "Natural\nDIC loss",
    x = 4, y = 100, colour = "#EE6677"
  ) +
  annotate(
    "segment", x = 5, xend = 9, y = 100, yend = 100, colour = "#EE6677"
  ) +
  annotate(
    "text", label = "Natural\nDIC gain",
    x = 2, y = 500, colour = "#228833"
  ) +
  annotate(
    "segment", x = 3, xend = 5, y = 500, yend = 500, colour = "#228833"
  ) +
  scale_color_manual(values = c("#555555", "#4477AA")) +
  scale_fill_manual(values = c("#228833", "#EE6677")) +
  labs(y = "Depth (m)",
       x = expression(Delta*DIC~(µmol~kg^{-1}~decade^{-1}))) +
  coord_cartesian(expand = 0) +
  scale_y_reverse(breaks = seq(0, 5000, 250)) +
  scale_x_continuous(limits = c(0,13),
                     breaks = seq(0,20,2),
                     position = "top") +
  theme_classic() +
  theme(legend.position = "none")

ggsave(  here::here("output/all_variables/profiles_MOBO-DIC_vs_eMLR.jpg"),
  width = 5,
  height = 5,
  dpi = 600)

#>      blue       red     green    yellow      cyan    purple      grey 
#> "#4477AA" "#EE6677" "#228833" "#CCBB44" "#66CCEE" "#AA3377" "#BBBBBB" 

rm(DIC_dCant_temp_profiles)

```


### dCant + Temperature

```{r profiles_dCant_temp_change, eval=FALSE}


dCant_temp_profiles <-
  dCant_temp_profiles %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

dCant_temp_profiles_min_max <-
dCant_temp_profiles %>%
  pivot_wider(values_from = delta_interval,
              names_from = driver)
  
  
  
  
# create pdf document

pdf(
  here::here("output/all_variables/profiles_dCant_temp_changes.pdf"),
  width = 14,
  height = 8
)

ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(data = dCant_temp_profiles, aes(delta_interval,
                                            depth,
                                            col = tref,
                                            linetype = driver)) +
  geom_ribbon(data = dCant_temp_profiles_min_max,
              aes(y = depth, xmin = dCant, xmax = `dCant + temp`,
                  fill = tref),
              alpha = 0.3) +
  scale_color_manual(values = c("#EE7733", "#009988")) +
  scale_fill_manual(values = c("#EE7733", "#009988")) +
  labs(y = "Depth (m)",
       title = "Incremental change from previous estimate") +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


DIC_dCant_temp_profiles %>% 
  filter(driver == "dCant") %>% 
  rename(parameter = variable) %>% 
  pivot_wider(names_from = temperature,
              values_from = delta_interval) %>% 
  mutate(temp_driver = 100 * (variable - climatology) / climatology) %>% 
  ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(
    data = . %>% filter(variable != "temp"),
    aes(temp_driver,
        depth,
        col = driver)
  ) +
  # scale_color_brewer(palette = "Dark2",
  #                    direction = -1,
  #                    labels = c(expression(Delta * C[ant]),
  #                                     expression(Delta * C[total]))) +
  labs(y = "Depth (m)") +
  theme(
    # legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(
    basin ~ parameter,
    labeller = labeller(parameter = x_axis_labels)
  ) +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                                           breaks = c(0, 100, 500, seq(1500, 5000, 1000)))


ggsave(
  here::here(
    paste0(
      "output/publication/profiles_incremental_changes_Cnat_basin.png"
    )
  ),
  width = 10,
  height = 10,
  dpi = 600,
  bg = "white"
)




rm(dCant_temp_profiles, dCant_temp_profiles_min_max)


```


### dCant


```{r profiles_incremental_change, eval=FALSE}

# create pdf document

pdf(
  here::here("output/all_variables/profiles_incremental_changes.pdf"),
  width = 14,
  height = 8
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         MLR_basins,
         Version_ID_group,
         contains("_delta_interval")) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(tref %in% c(2004,2014),
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval")) %>% 
  ggplot(aes(
    delta_interval,
    depth,
    col = tref,
    group = interaction(tref, MLR_basins, Version_ID_group)
  )) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_manual(values = c("#EE7733", "#009988")) +
  labs(y = "Depth (m)",
       title = "Incremental change from previous estimate")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```


```{r profiles_incremental_change_station}


acidification_profiles_station <-
  acidification_profiles_station %>%
  pivot_longer(tco2:temp,
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(depth <= 3000)

acidification_profiles_station <- acidification_profiles_station %>%
  filter(variable %in% OIA_variables)

acidification_profiles_station_obs_reconstructed <-
bind_rows(
  TS_trends %>%
    filter(term == "year") %>%
    select(station, variable = name, depth = depth_int, estimate, std.error) %>%
    mutate(
      driver = "observed",
      tref = "\ntrend over\nobserved\nperiod",
      delta_interval = estimate * 20,
      std.error = std.error * 20
    ),
  acidification_profiles_station %>%
    mutate(driver = "reconstructed"),
  acidification_profiles_station %>%
    mutate(driver = "reconstructed") %>%
    filter(variable != "temp") %>% 
    mutate(variable = paste0(variable, "star"))
) 


acidification_profiles_station_obs_reconstructed %>%
  filter(station == "ALOHA" & depth <= 250 |
           station == "BATS" & depth <= 500) %>% 
  group_by(station, variable, driver) %>% 
  summarise(delta_interval = mean(delta_interval)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = driver,
              values_from = delta_interval) %>% 
  mutate(relative = 100 * reconstructed / observed)


acidification_profiles_station_obs_reconstructed %>%
  ggplot(aes(delta_interval,
             depth)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_ribbon(
    data = . %>% filter(!is.na(std.error)),
    aes(
    xmin = delta_interval - std.error,
    xmax = delta_interval + std.error,
    fill = "Std error of trend"
  ),
  alpha = 0.5)+
  geom_path(aes(col = tref)) +
  geom_point(aes(col = tref), size = 0.5) +
  scale_fill_muted() +
  scale_color_muted() +
  labs(y = "Depth (m)",
       title = "20 year changes") +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(
    station ~ variable,
    scales = "free",
    switch = "x",
    labeller = labeller(variable = x_axis_labels_stations)
  ) +
  scale_x_continuous(guide = guide_axis(n.dodge = 2)) +
  facetted_pos_scales(y = rep(list(
    scale_y_continuous(trans = trans_reverser("sqrt"),
                       breaks = c(0, 100, 500, seq(1500, 5000, 1000)))
  ), 6))




ggsave(
  here::here(
    paste0(
      "output/publication/BATS_ALOHA_20_yr_changes.png"
    )
  ),
  width = 18,
  height = 8,
  dpi = 600,
  bg = "white"
)


```


## Total changes

### Basins

```{r profiles_total_change}

dCant_temp_profiles_temp_contribution_long <-
dCant_temp_profiles_temp_contribution %>%
  select(tref,
         basin,
         depth,
         contains("_delta_interval")) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval_temp") %>%
  mutate(variable = str_remove(variable, "_delta_interval")) %>%
  filter(tref != 1800,
         depth <= 3000,
         variable %in% OIA_variables)

acidification_profiles_long <-
acidification_profiles %>%
  select(tref,
         basin,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>%
  filter(tref != 1800,
         depth <= 3000,
         variable %in% OIA_variables)

acidification_profiles_long_relative <-
  acidification_profiles_long %>%
  arrange(tref) %>%
  group_by(basin, depth, variable) %>%
  mutate(delta_total_relative = 100 * (delta_total - first(delta_total)) / first(delta_total)) %>%
  ungroup()


acidification_profiles_long <-
full_join(acidification_profiles_long,
          dCant_temp_profiles_temp_contribution_long) %>% 
  replace_na(list(delta_total = 0, delta_interval_temp = 0))

acidification_profiles_long <- acidification_profiles_long %>% 
  mutate(delta_total_temp = delta_total + delta_interval_temp)


acidification_profiles_long %>%
  ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(aes(delta_total_temp,
                depth,
                col = tref, linetype = "dcant_temp")) +
  geom_path(
    data = . %>% filter(variable != "temp"),
    aes(delta_total,
        depth,
        col = tref, linetype = "dcant_only")
  ) +
  scale_color_manual(values = three_year_colors) +
  scale_linetype_manual(values = c(1, 2),
                           labels = c(expression(Delta * C[ant]),
                                      expression(atop(Delta * C[ant] ~ "+", Temp)))) +
  # scale_linewidth_discrete(range = c(1, 0.5),
  #                          labels = c(expression(Delta * C[ant]),
  #                                     expression(atop(Delta * C[ant] ~ "+", Temp)))) +
  labs(y = "Depth (m)") +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(
    basin ~ variable,
    scales = "free",
    switch = "x",
    labeller = labeller(variable = x_axis_labels)
  ) +
  facetted_pos_scales(x = x_axis_scales,
                      y = rep(list(
                        scale_y_continuous(trans = trans_reverser("sqrt"),
                                           breaks = c(0, 100, 500, seq(1500, 5000, 1000)))
                      ), 6))


ggsave(
  here::here(
    paste0(
      "output/publication/profiles_total_changes_basin.png"
    )
  ),
  width = 10,
  height = 10,
  dpi = 600,
  bg = "white"
)
  
  
acidification_profiles_long_relative %>%
  ggplot() +
  geom_path(aes(
    delta_total_relative,
    depth,
    col = tref,
    linetype = "dcant_only"
  )) +
  scale_color_manual(values = three_year_colors) +
  scale_linetype_manual(values = c(1, 2),
                        labels = c(expression(Delta * C[ant]),
                                   expression(atop(Delta * C[ant] ~ "+", Temp)))) +
  scale_y_reverse(breaks = seq(0, 10000, 500)) +
  # scale_y_continuous(trans = trans_reverser("sqrt"),
  #                    breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  coord_cartesian(xlim = c(0,100)) +
  labs(y = "Depth (m)") +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(basin ~ variable,
             labeller = labeller(variable = x_axis_labels))


ggsave(
  here::here(
    paste0("output/publication/profiles_total_changes_basin_relative.png")
  ),
  width = 10,
  height = 10,
  dpi = 600,
  bg = "white"
)

acidification_profiles_long_relative %>%
  filter(depth <= 500) %>%
  group_by(basin, variable, tref) %>%
  summarise(delta_total_relative = mean(delta_total_relative)) %>%
  ungroup() %>%
  mutate(tref = as.numeric(as.character(tref))) %>%
  arrange(tref) %>%
  ggplot(aes(tref, delta_total_relative, col = basin)) +
  geom_path() +
  geom_point(shape = 21, fill = "white") +
  scale_color_okabeito() +
  scale_x_continuous(breaks = seq(1994, 2014, 10)) +
  labs(y = "ΔOIA top 500m (% relative to 1994 OIA)") +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.text.x = element_markdown(),
        legend.position = c(0.8,0.25)
  ) +
  facet_wrap( ~ variable,
              labeller = labeller(variable = x_axis_labels))

ggsave(
  here::here(
    "output/publication/acidification_rates_500m_relative.png"
  ),
  width = 8,
  height = 6,
  dpi = 600,
  bg = "white"
)

# acidification_profiles_interval <-
#   acidification_profiles %>%
#   select(tref,
#          basin,
#          depth,
#          contains("_delta_interval")) %>%
#   pivot_longer(contains("_delta_interval"),
#                names_to = "variable",
#                values_to = "delta_interval") %>%
#   filter(tref != 1800,
#          depth <= 3000) %>%
#   mutate(variable = str_remove(variable, "_delta_interval"))
# # filter(basin == "Global",
# #        variable == "pCO2insitu")
# 
# acidification_profiles_total <-
#   acidification_profiles %>%
#   select(tref,
#          basin,
#          depth,
#          contains("_delta_total")) %>%
#   pivot_longer(contains("_delta_total"),
#                names_to = "variable",
#                values_to = "delta_total") %>%
#   filter(tref != 1800,
#          depth <= 3000) %>%
#   mutate(variable = str_remove(variable, "_delta_total"))
# # filter(basin == "Global",
# #        variable == "pCO2insitu")
# 
# 
# ggplot() +
#   geom_area(
#     data = acidification_profiles_interval,
#     aes(delta_interval,
#         depth,
#         fill = tref),
#     alpha = 0.5,
#     orientation = "y",
#     position = position_stack(reverse = TRUE)
#   ) +
#   geom_path(data = acidification_profiles_total,
#             aes(delta_total,
#                 depth,
#                 group = tref),
#             col = "grey20") +
#   scale_fill_viridis_d(option = "viridis") +
#   labs(y = "Depth (m)",
#        title = "Total change since 1800") +
#   scale_y_continuous(trans = trans_reverser("sqrt"),
#                      breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
#   coord_cartesian(expand = 0) +
#   theme(legend.title = element_blank(),
#         axis.title.x = element_blank()) +
#   facet_grid(basin ~ variable, scales = "free_x")


```

### Biomes


```{r profiles_total_change_biome}

dCant_temp_profiles_temp_contribution_biome_long <-
dCant_temp_profiles_temp_contribution_biome %>%
  select(tref,
         biome,
         depth,
         contains("_delta_interval")) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval_temp") %>%
  mutate(variable = str_remove(variable, "_delta_interval")) %>%
  filter(tref != 1800,
         depth <= 3000,
         variable %in% OIA_variables)

acidification_profiles_biome_long <-
acidification_profiles_biomes %>%
  select(tref,
         biome,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>%
  filter(tref != 1800,
         depth <= 3000,
         variable %in% OIA_variables)

acidification_profiles_biome_long <-
full_join(acidification_profiles_biome_long,
          dCant_temp_profiles_temp_contribution_biome_long) %>% 
  replace_na(list(delta_total = 0, delta_interval_temp = 0))

acidification_profiles_biome_long <- acidification_profiles_biome_long %>% 
  mutate(delta_total_temp = delta_total + delta_interval_temp)



acidification_profiles_biome_long %>%
  filter(!is.na(biome)) %>% 
  ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(aes(delta_total_temp,
                depth,
                col = tref, linetype = "dcant_temp")) +
  geom_path(
    data = . %>% filter(variable != "temp"),
    aes(delta_total,
        depth,
        col = tref, linetype = "dcant_only")
  ) +
  scale_color_manual(values = three_year_colors) +
  scale_linetype_manual(values = c(1, 2),
                           labels = c(expression(Delta * C[ant]),
                                      expression(atop(Delta * C[ant] ~ "+", Temp)))) +
  labs(y = "Depth (m)") +
  theme(
    legend.title = element_blank(),
    axis.title.x = element_blank(),
    strip.background.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_markdown()
  ) +
  facet_grid(
    biome ~ variable,
    scales = "free",
    switch = "x",
    labeller = labeller(variable = x_axis_labels)
  ) +
  facetted_pos_scales(x = x_axis_scales,
                      y = rep(list(
                        scale_y_continuous(trans = trans_reverser("sqrt"),
                                           breaks = c(0, 100, 500, seq(1500, 5000, 1000)))
                      ), 6))



ggsave(
  here::here(
    paste0(
      "output/publication/profiles_total_changes_biome.png"
    )
  ),
  width = 10,
  height = 10,
  dpi = 600,
  bg = "white"
)

```


```{r profiles_total_change_buffer, eval=FALSE}

# create pdf document

pdf(
  here::here("output/all_variables/profiles_total_changes_buffer.pdf"),
  width = 10,
  height = 8
)

buffer_profiles %>%
  select(tref,
         basin,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  filter(tref != 1800,
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>% 
  ggplot(aes(
    delta_total,
    depth,
    col = tref)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Total change since 1800")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")



dev.off()

```

## Absolute state

```{r profiles_absolute_state, eval=FALSE}


# create pdf document

pdf(
  here::here("output/all_variables/profiles_absolute_state.pdf"),
  width = 14,
  height = 8
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         # MLR_basins,
         # Version_ID_group,
         all_of(OIA_variables[-6])) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = tref
  )) +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```

## Buffer

### Basins

```{r profiles_absolute_state_buffer, eval=FALSE}


# create pdf document

pdf(
  here::here("output/all_variables/profiles_absolute_state_buffer.pdf"),
  width = 10,
  height = 8
)

buffer_profiles %>%
  select(tref,
         basin,
         depth,
         gammaDIC:R,
         tco2_talk_ratio) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = tref
  )) +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```

### Biomes


```{r profiles_absolute_state_buffer_biome, eval=FALSE}


# create pdf document

pdf(
  here::here("output/all_variables/profiles_absolute_state_buffer_biome.pdf"),
  width = 10,
  height = 20
)

buffer_profiles_biome %>%
  select(tref,
         region,
         biome,
         depth,
         gammaDIC:R,
         tco2_talk_ratio) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = tref
  )) +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_reverse() +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(biome ~ variable, scales = "free_x")

dev.off()

pdf(
  here::here("output/all_variables/profiles_absolute_state_buffer_biome_color.pdf"),
  width = 10,
  height = 8
)

buffer_profiles_biome %>%
  select(tref,
         region,
         biome,
         depth,
         gammaDIC:R,
         tco2_talk_ratio) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = biome
  )) +
  geom_path() +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_reverse() +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(tref ~ variable, scales = "free_x")

dev.off()


```



Write ouput

```{r write_output_files, eval=FALSE}

acidification_trend %>% 
  write_csv(paste0(path_OIA, "OIA.csv"))


acidification_layer %>% 
  write_csv(paste0(path_OIA, "OIA_layer.csv"))

acidification_zonal %>% 
  write_csv(paste0(path_OIA, "OIA_zonal.csv"))


acidification_global_section %>% 
  write_csv(paste0(path_OIA, "OIA_global_section.csv"))

acidification_profiles %>% 
  write_csv(paste0(path_OIA, "OIA_profiles.csv"))




```



