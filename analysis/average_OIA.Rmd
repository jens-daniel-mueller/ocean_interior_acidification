---
title: "OIA Averaging"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

# Libraries

```{r load_libraries_specific, include = FALSE}
library(patchwork)
library(khroma)
library(ggh4x)
library(colorspace)
library(stars)
library(seacarb)
library(ggtext)
```


# Read data

```{r define_paths_to_access_eMLR_files}

# only path_observations needs to be changed to model
path_observations <-
  paste0(path_root, "/observations/")

path_preprocessing    <-
  paste0(path_observations, "preprocessing/")

path_preprocessing_model    <-
  paste0(path_root, "/model/preprocessing/")

path_reccap2 <-
  "/nfs/kryo/work/updata/reccap2/"

path_out <-   paste0(path_observations, "output_publication/")
path_OIA <-   "/nfs/kryo/work/jenmueller/ocean_interior_acidification/"


```

## Basin mask

```{r select_basinmask_5}

basinmask <- basinmask %>% 
  filter(MLR_basins == "5") %>% 
  select(lon, lat, basin)

```

## Biome mask

```{r read_biome_mask}

biome_mask <-
  read_ncdf(paste(path_reccap2, "RECCAP2_region_masks_all_v20220620.nc", sep = "")) %>%
  as_tibble()

biome_mask <- biome_mask %>%
  filter(seamask == 1) %>% 
  select(lon, lat, atlantic:southern) %>% 
  pivot_longer(atlantic:southern,
               names_to = "region",
               values_to = "value") %>%
  mutate(value = as.factor(value))

biome_mask <- biome_mask %>%
  filter(value != 0)

# assign biome label and select biomes

biome_mask <- biome_mask  %>% 
  mutate(biome = case_when(
    region == "atlantic" & value == "1" ~ "NA-SPSS",
    region == "atlantic" & value == "2" ~ "NA-STSS",
    region == "atlantic" & value == "3" ~ "NA-STPS",
    region == "atlantic" & value == "4" ~ "AEQU",
    region == "atlantic" & value == "5" ~ "SA-STPS",
    # region == "atlantic" & value == "6" ~ "MED",
    region == "pacific" & value == "1" ~ "NP-SPSS",
    # region == "pacific" & value == "2" ~ "NP-STSS",
    region == "pacific" & value == "3" ~ "NP-STPS",
    # region == "pacific" & value == "4" ~ "PEQU-W",
    region == "pacific" & value == "5" ~ "PEQU-E",
    region == "pacific" & value == "6" ~ "SP-STSS",
    region == "indian" & value == "1" ~ "Arabian Sea",
    region == "indian" & value == "2" ~ "Bay of Bengal",
    region == "indian" & value == "3" ~ "Equatorial Indian",
    region == "indian" & value == "4" ~ "Southern Indian",
    # region == "arctic" & value == "1" ~ "ARCTIC-ICE",
    # region == "arctic" & value == "2" ~ "NP-ICE",
    # region == "arctic" & value == "3" ~ "NA-ICE",
    # region == "arctic" & value == "4" ~ "Barents",
    region == "southern" & value == "1" ~ "STSS",
    region == "southern" & value == "2" ~ "SPSS",
    # region == "southern" & value == "3" ~ "ICE",
    TRUE ~ "other"
  ))

biome_mask <- biome_mask %>% 
  filter(biome != "other") %>% 
  select(-value)

biome_mask %>%
  ggplot(aes(lon, lat, fill = biome)) +
  geom_raster() +
  coord_quickmap(expand = 0)


biome_mask %>%
  group_split(region) %>%
  # head(4) %>%
  map(
    ~ ggplot() +
      geom_raster(data = biome_mask %>% distinct(lon, lat),
                  aes(lon, lat),
                  fill = "grey80") +
      geom_raster(data = .x,
                  aes(lon, lat, fill = biome)) +
      scale_fill_vibrant() +
      coord_quickmap(expand = 0, ylim = c(-78,65)) +
      facet_wrap( ~ region)
  )


```



## List of files

```{r read_list_files}

all_files <- list.files(path_OIA) %>% 
  str_subset(".csv")

```

## 2002 climatology

### OIA variables

```{r climatology_2002_Lauvset}


climatology <-
  read_csv(paste0(path_OIA, "OIA_DIC_climatology_none.csv"))

climatology <- climatology %>%
  select(-c(MLR_basins, Version_ID_group))

```


### buffer variables

```{r buffer_climatology_2002_Lauvset}

buffer_climatology <-
  read_csv(paste0(path_OIA, "buffer_DIC_climatology_none.csv"))

```

## Acidification estimates

### dCant driver

```{r read_OIA_data}

acidification_trend <-
  read_csv(paste0(path_OIA, "OIA_Standard case_3.csv"))

acidification_trend <- acidification_trend %>% 
  select(-c(MLR_basins, Version_ID_group))

```


```{r OIA_variables}

OIA_variables <- 
  acidification_trend %>%
  select(contains("delta_total")) %>% 
  names() %>% 
  str_remove("_delta_total")

OIA_variables <- OIA_variables[-c(3,4,6,7)]


```

#### Buffer trends


```{r read_buffer_changes_DIC_addition}

buffer_trend <-
  read_csv(paste0(path_OIA, "OIA_Standard case_3_DIC_addition.csv"))

buffer_trend <- buffer_trend %>% 
  select(-c(MLR_basins, Version_ID_group))

buffer_trend_addition <-
  full_join(
    buffer_trend %>%
      select(lon, lat, depth, tref, basin_AIP, contains(OIA_variables)) %>%
      select(-c(contains("delta"), "tco2", "tco2_talk_ratio", "phosphate")) %>%
      pivot_longer(pH:temp,
                   names_to = "variable",
                   values_to = "added"),
    acidification_trend %>%
      select(lon, lat, depth, tref, basin_AIP, contains(OIA_variables)) %>%
      select(-c(contains("delta"), "tco2", "tco2_talk_ratio", "phosphate")) %>%
      pivot_longer(pH:temp,
                   names_to = "variable",
                   values_to = "raw")
  )

rm(buffer_trend)


buffer_trend_addition <-
  buffer_trend_addition %>%
  mutate(sensitivity = (added - raw) / 5)


buffer_trend_addition <-
  buffer_trend_addition %>%
  select(-c(raw, added))

buffer_variables_addition <-
  buffer_trend_addition %>% 
  distinct(variable) %>% 
  pull

```



```{r read_buffer_changes_direct_estimates}

buffer_trend <-
  read_csv(paste0(path_OIA, "buffer_Standard case_3.csv"))

buffer_trend <- buffer_trend %>%
  select(-c(MLR_basins, Version_ID_group))

# merge tco2-talk-ratio into buffer variables

buffer_trend <-
  full_join(
    buffer_trend,
    acidification_trend %>% select(lon, lat, depth, tref, basin_AIP,
                                   contains("tco2_talk"))
  )

```


### Temperature driver

```{r read_OIA_temperature_driven}

temperature_trend <-
  read_csv(paste0(path_OIA, "OIA_dCant + temp_3.csv"))

temperature_trend <- temperature_trend %>%
  select(-c(MLR_basins, Version_ID_group))

# create joined coordinate grid

dCant_temp_trend_depth_grid <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref),
    temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

# reduce data to joined coordinate grid

dCant_trend <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_temp_trend_depth_grid
  )

temperature_trend <-
  inner_join(
    temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_temp_trend_depth_grid
  )

# join relevant data sets

dCant_temp_trend <-
  bind_rows(dCant_trend %>%
              mutate(driver = "dCant"),
            temperature_trend %>%
              mutate(driver = "dCant + temp"))

rm(temperature_trend,
   dCant_trend,
   dCant_temp_trend_depth_grid)

```

### DIC driver

#### Interior (MOBO-DIC)

```{r read_OIA_DIC_driven_interior}

DIC_trend <-
  read_csv(paste0(path_OIA, "OIA_DIC_3.csv"))

DIC_trend <- DIC_trend %>%
  select(-c(MLR_basins, Version_ID_group))

DIC_temperature_trend <-
  read_csv(paste0(path_OIA, "OIA_DIC + temp_3.csv"))

DIC_temperature_trend <- DIC_temperature_trend %>%
  select(-c(MLR_basins, Version_ID_group))

# create joined coordinate grid

dCant_DIC_temp_trend_depth_grid <-
  inner_join(
    DIC_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref),
    DIC_temperature_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

dCant_DIC_temp_trend_depth_grid <-
  inner_join(
    dCant_DIC_temp_trend_depth_grid,
    dCant_temp_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

# reduce data to joined coordinate grid

DIC_trend <-
  inner_join(
    DIC_trend %>%
      filter(tref %in% c(2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_DIC_temp_trend_depth_grid
  )

DIC_temperature_trend <-
  inner_join(
    DIC_temperature_trend %>%
      filter(tref %in% c(2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_DIC_temp_trend_depth_grid
  )

dCant_temp_trend_temporary <-
  inner_join(
    dCant_temp_trend %>%
      filter(tref %in% c(2014)) %>%
      select(
        lon,
        lat,
        depth,
        tref,
        driver,
        basin_AIP,
        contains("delta_interval")
      ),
    dCant_DIC_temp_trend_depth_grid
  )

# join relevant data sets

dCant_DIC_temp_trend <-
  bind_rows(
    DIC_trend %>%
      mutate(driver = "DIC"),
    DIC_temperature_trend %>%
      mutate(driver = "DIC + temp"),
    dCant_temp_trend_temporary
  )

rm(
  DIC_trend,
  DIC_temperature_trend,
  dCant_temp_trend_temporary,
  dCant_DIC_temp_trend_depth_grid
)


```

#### Surface (OceanSODA)

```{r read_OIA_DIC_driven_surface}

DIC_surface_trend <-
  read_csv(paste0(path_OIA, "OIA_OceanSODA DIC_3.csv"))

DIC_surface_trend <- DIC_surface_trend %>%
  select(-c(MLR_basins, Version_ID_group))

# create joined coordinate grid

dCant_DIC_surface_trend_depth_grid <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref),
    DIC_surface_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      distinct(lon, lat, depth, tref)
  )

# reduce data to joined coordinate grid

dCant_trend <-
  inner_join(
    acidification_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_DIC_surface_trend_depth_grid
  )

DIC_surface_trend <-
  inner_join(
    DIC_surface_trend %>%
      filter(tref %in% c(2004, 2014)) %>%
      select(lon, lat, depth, tref, basin_AIP, contains("delta_interval")),
    dCant_DIC_surface_trend_depth_grid
  )

# join relevant data sets

dCant_DIC_surface_trend <-
  bind_rows(dCant_trend %>%
              mutate(driver = "dCant"),
            DIC_surface_trend %>%
              mutate(driver = "DIC surface"))

rm(DIC_surface_trend,
   dCant_trend,
   dCant_DIC_surface_trend_depth_grid)

```

## Time series stations

```{r read_time_series_stations, eval=FALSE}


col_names <-
  names(read_csv(
    paste0(path_OIA, "input_data/TS_product_consistent.csv"),
    n_max = 0
  ))

TS_product_consistent <-
  read_csv(
    paste0(path_OIA, "input_data/TS_product_consistent.csv"),
    col_names = col_names,
    skip = 2
  )

rm(col_names)

TS_product_consistent <- TS_product_consistent %>% 
  select(station = TimeSeriesStation,
         station_nr = STNNBR,
         date = DATE,
         lat = LATITUDE,
         lon = LONGITUDE,
         depth = CTDPRS,
         tco2 = TCARBN)

TS_product_consistent <- TS_product_consistent %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

TS_product_consistent <- TS_product_consistent %>% 
  filter(tco2 != -999)

TS_product_consistent %>% 
  count(station) %>% 
  arrange(-n)


TS_product_consistent %>% 
  distinct(station, lon, lat) %>% 
  ggplot(aes(lon, lat, col = station)) +
  geom_point() +
  coord_quickmap()

library(lubridate)

TS_product_consistent <-
TS_product_consistent %>% 
  mutate(date = as.Date(as.character(date), "%Y%m%d"),
         year = year(date))

TS_product_consistent %>% 
  filter(station == "ALOHA",
         depth < 10) %>% 
  ggplot(aes(date, tco2)) +
  geom_point() +
  geom_path()

TS_product_consistent %>% 
  filter(station == "ALOHA",
         depth < 2000) %>% 
  ggplot(aes(tco2, depth, col = date)) +
  geom_point() +
  scale_color_viridis_c(trans = "date") +
  scale_y_reverse()

rm(TS_product_consistent)

```

# Define key variables

## buffer

```{r buffer_variables}

buffer_variables <-
  buffer_trend %>%
  select(contains("delta_total")) %>%
  names() %>%
  str_remove("_delta_total")

```


# Uncertainty determination

## Reference dCant case

```{r reference_dcant_reconstructions, eval=FALSE}

MLR_basins_reference <- unique(acidification_trend$MLR_basins)[1]

MLR_basins_all <- unique(acidification_trend$MLR_basins)

MLR_basins_uncertainty <-
  MLR_basins_all[!MLR_basins_all %in% MLR_basins_reference]



Version_ID_group_reference <-
  unique(acidification_trend$Version_ID_group)[1]
Version_ID_group_all <-
  unique(acidification_trend$Version_ID_group)

Version_ID_group_uncertainty <-
  Version_ID_group_all[Version_ID_group_all != Version_ID_group_reference]

```

## Additive computation

```{r uncertainty_determination, eval=FALSE}

additive_uncertainty <- function(df){
  
  df_regional_uncertainty <-
    df %>%
    filter(MLR_basins != MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-Version_ID_group) %>% 
    pivot_wider(names_from = MLR_basins,
                values_from = contains("_interval_mean"),
                names_sep = "-") %>%
    pivot_longer(all_of(contains(MLR_basins_uncertainty)),
                 names_to = c("variable","MLR_basins"),
                 names_sep = "-",
                 values_to = "value")
  
  df_regional_reference <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-c(MLR_basins, Version_ID_group)) %>% 
    pivot_longer(contains("_interval_mean"),
                 names_to = c("variable"),
                 values_to = MLR_basins_reference)
  
  df_regional <-
    full_join(df_regional_reference, df_regional_uncertainty)
  
  df_regional <-
    df_regional %>%
    mutate(delta_value = value-!!sym(MLR_basins_reference)) %>%
    select(-c(all_of(MLR_basins_reference), MLR_basins, value))

  df_regional_stat <-
    df_regional %>%
    group_by(across(-delta_value)) %>%
    summarise(sd = mean(abs(delta_value))) %>%
    ungroup()


  df_configuration_uncertainty <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group %in% Version_ID_group_uncertainty) %>% 
    select(-MLR_basins) %>% 
    pivot_wider(names_from = Version_ID_group,
                values_from = contains("_interval_mean"),
                names_sep = "-") %>%
   pivot_longer(all_of(contains(Version_ID_group_uncertainty)),
                 names_to = c("variable","Version_ID_group"),
                 names_sep = "-",
                 values_to = "value")

  
  df <-
    df %>%
    filter(MLR_basins == MLR_basins_reference,
           Version_ID_group == Version_ID_group_reference) %>% 
    select(-c(Version_ID_group, MLR_basins)) %>% 
    pivot_longer(contains("_interval_mean"),
                 names_to = c("variable"),
                 values_to = Version_ID_group_reference)

  df_configuration <-
    full_join(df, df_configuration_uncertainty) 
  
  df_configuration <- df_configuration %>% 
    mutate(delta_value = value-!!sym(Version_ID_group_reference))
  
  
  df_configuration <-
    df_configuration %>%
    rename(sd = delta_value) %>%
    select(-c(value, all_of(Version_ID_group_reference)))
  
  df_factorial <-
    bind_rows(
      df_regional_stat %>%
        mutate(Version_ID_group = "Regional clustering"),
      df_configuration
    )

  df_factorial_stat <-
    df_factorial %>%
    select(-Version_ID_group) %>%
    group_by(across(-sd)) %>%
    summarise(sd = sqrt(sum(sd ^ 2, na.rm = TRUE))) %>%
    ungroup()

  df_stat <-
    full_join(
      df_factorial_stat,
      df %>%
        rename(std_case = all_of(Version_ID_group_reference))
    )

  df_stat <- df_stat %>%
    mutate(
      signif_single = if_else(abs(std_case) >= sd,
                              1,
                              0),
      signif_double = if_else(abs(std_case) >= sd * 2,
                              1,
                              0)
    )

  df_stat_delta <-
    df_stat %>%
    select(-starts_with("signif_")) %>%
    arrange(tref) %>%
    group_by(across(-c(tref, sd, std_case))) %>%
    mutate(
      delta_value = std_case - lag(std_case),
      RSS = sqrt(sd ^ 2 + lag(sd ^ 2)),
      signif_single = if_else(abs(delta_value) >= RSS,
                              1,
                              0),
      signif_double = if_else(abs(delta_value) >= RSS * 2,
                              1,
                              0)
    ) %>%
    ungroup() %>%
    drop_na()
  
  
  df_stat <-
    df_stat %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))
  
  df_factorial <-
    df_factorial %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))
  
  df_stat_delta <-
    df_stat_delta %>%
    mutate(variable = str_remove(variable, "_delta_interval_mean"))


df_out <- list(df_stat, df_factorial, df_stat_delta)

return(df_out)

}


```



# Color scale settings

```{r set_color_range_quantiles}

quantile_high <- 0.98
quantile_low <- 0.02

break_numbers <- 10

```
 
# Surface area mask

```{r surface_area_mask}
# compute grid cell surface area

basinmask <- basinmask %>% 
    mutate(area = earth_surf(lat, lon))

biome_mask <- biome_mask %>% 
    mutate(area = earth_surf(lat, lon))

```


# General consideration

```{r acidification_parameter_sensitivity}

sensitivity <-
  expand_grid(
    pco2 = seq(100, 1000, 100),
    temp = seq(0, 30, 5)
  )

sensitivity <- sensitivity %>%
  mutate(carb(
    flag = 24,
    var1 = pco2,
    var2 = 2300 * 1e-6,
    T = temp,
    pHscale = "F"
  )) %>%
  select(
    temp,
    pco2,
    DIC,
    CO3,
    pH,
    HCO3
  )

sensitivity_DIC <- sensitivity %>%
  select(temp, pco2, tco2_start = DIC) %>% 
  mutate(carb(
    flag = 15,
    var1 = 2300 * 1e-6,
    var2 = tco2_start + 10 * 1e-6,
    T = temp,
    pHscale = "F"
  )) %>%
  select(
    temp,
    pco2,
    CO3,
    pH,
    HCO3
  )

sensitivity_temp <- sensitivity %>%
  select(temp, pco2, tco2_start = DIC) %>% 
  mutate(carb(
    flag = 15,
    var1 = 2300 * 1e-6,
    var2 = tco2_start,
    T = temp + 1,
    pHscale = "F"
  )) %>%
  select(
    temp,
    pco2,
    CO3,
    pH,
    HCO3
  )

sensitivity_all <-
  bind_rows(
    sensitivity %>% mutate(case = "start") %>% select(-DIC),
    sensitivity_DIC %>% mutate(case = "+10DIC"),
    sensitivity_temp %>%  mutate(case = "+1temp")
  )

sensitivity_all <- sensitivity_all %>% 
  arrange(desc(case)) %>% 
  mutate(H = 1e6 * 10^-pH,
         HCO3 = HCO3 * 1e6,
         CO3 = CO3 * 1e6,
         SIR = HCO3 / H
         ) %>% 
  pivot_longer(c(CO3, pH, HCO3, H, SIR),
               names_to = "variable",
               values_to = "value") %>% 
  group_by(temp, pco2, variable) %>% 
  mutate(delta_relative = 100 * (value - first(value)) / first(value)) %>% 
  ungroup() %>% 
  filter(case != "start")


sensitivity_all %>% 
  mutate(pco2 = as.factor(pco2)) %>% 
  ggplot(aes(temp, delta_relative, col = pco2)) +
  geom_point() +
  geom_path() +
  scale_color_viridis_d() +
  facet_nested_wrap(case~variable, scales = "free", ncol = 5)

sensitivity_all %>% 
  mutate(temp = as.factor(temp)) %>% 
  ggplot(aes(pco2, delta_relative, col = temp)) +
  geom_point() +
  geom_path() +
  scale_color_viridis_d() +
  facet_nested_wrap(case~variable, scales = "free", ncol = 5)

sensitivity_all %>% 
  select(-value) %>% 
  pivot_wider(names_from = case,
              values_from = delta_relative) %>% 
  mutate(temp_per_DIC =  `+1temp` / `+10DIC`) %>% 
  mutate(temp = as.factor(temp)) %>% 
  ggplot(aes(pco2, temp_per_DIC, col = temp)) +
  geom_point() +
  geom_path() +
  scale_color_viridis_d() +
  facet_nested_wrap(.~variable, ncol = 5)

sensitivity_all %>% 
  select(-value) %>% 
  pivot_wider(names_from = case,
              values_from = delta_relative) %>% 
  mutate(temp_per_DIC =  `+1temp` / `+10DIC`) %>% 
  mutate(pco2 = as.factor(pco2)) %>% 
  ggplot(aes(temp, temp_per_DIC, col = pco2)) +
  geom_point() +
  geom_path() +
  scale_color_viridis_d() +
  facet_nested_wrap(.~variable, ncol = 5)

rm(sensitivity,
   sensitivity_all,
   sensitivity_DIC,
   sensitivity_temp)


```



# Depth layer maps

## Computation

```{r compute_layered_maps}

m_depth_layer <- function(df) {
  
  df <- df %>%
    mutate(depth = cut(
      depth,
      c(0, 100, 500, 1500, 3000),
      c("A: 0 - 100 m", "B: 100 - 500 m", "C :500 - 1500 m", "D: 1500 - 3000 m"),
      include.lowest = TRUE
    )) %>%
    drop_na() %>%
    select(c(lat, lon, depth, tref),
           where(is.numeric)) %>%
    fgroup_by(lat, lon, depth, tref) %>% {
      add_vars(fgroup_vars(., "unique"),
               fmean(., keep.group_vars = FALSE))
    }
  
  return(df)
  
}




acidification_depth_layer <- m_depth_layer(acidification_trend)

acidification_depth_layer_dCant_temp <- dCant_temp_trend %>%
  group_by(driver) %>%
  nest() %>%
  mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
  select(-data) %>%
  unnest(layer) %>% 
  ungroup()

acidification_depth_layer_DIC_dCant_temp <- dCant_DIC_temp_trend %>%
  group_by(driver) %>%
  nest() %>%
  mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
  select(-data) %>%
  unnest(layer) %>% 
  ungroup()

acidification_depth_layer_dCant_DIC_surface <- dCant_DIC_surface_trend %>%
  group_by(driver) %>%
  nest() %>%
  mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
  select(-data) %>%
  unnest(layer) %>% 
  ungroup()

buffer_addition_depth_layer <- buffer_trend_addition %>%
  group_by(variable) %>%
  nest() %>%
  mutate(layer = map(.x = data, ~m_depth_layer(.x))) %>%
  select(-data) %>%
  unnest(layer) %>% 
  ungroup()

buffer_climatology_depth_layer <- m_depth_layer(buffer_climatology)

climatology_depth_layer <- m_depth_layer(climatology)

```

## Incremental changes

### dCant + DIC (interior)

Note: temperature influence was not considered for maps

```{r depth_layer_incremental_change_dCant_DIC_interior}

# subset DIC_dCant_temp change sections

acidification_depth_layer_DIC_dCant_temp <-
  acidification_depth_layer_DIC_dCant_temp %>%
  filter(driver %in% c("dCant", "DIC")) %>% 
  select(driver:tref,
         contains("_delta_interval"))

acidification_depth_layer_DIC_dCant_temp <-
  acidification_depth_layer_DIC_dCant_temp %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_dCant_DIC_changes.pdf"),
  width = 14,
  height = 10
)

# loop over OIA variables
# print DIC_dCant_temp sections

for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[4]
  
  # subset OIA variable
  
  i_acidification_depth_layer_DIC_dCant_temp <-
    acidification_depth_layer_DIC_dCant_temp %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, driver, delta_interval)

  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_DIC_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_DIC_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  # create maps with absolute values
  
  p_depth_layer_dCant <-
    i_acidification_depth_layer_DIC_dCant_temp %>%
    filter(driver == "dCant") %>%
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: dCant")
  
  p_depth_layer_DIC <-
  i_acidification_depth_layer_DIC_dCant_temp %>%
    filter(driver == "DIC") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: DIC")
      
  
  i_delta_acidification_depth_layer_driver <-
    i_acidification_depth_layer_DIC_dCant_temp %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant` - `DIC`) %>%
    select(lon, lat, depth, tref, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_driver <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_driver <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_driver <-
    i_delta_acidification_depth_layer_driver %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_driver,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver difference: dCant - DIC")
  
  print(
    wrap_plots(
      p_depth_layer_dCant,
      p_depth_layer_DIC,
      p_depth_layer_driver,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_DIC_dCant_temp,
   i_acidification_depth_layer_DIC_dCant_temp,
   i_delta_acidification_depth_layer_driver,
   high, low,
   breaks_divergent_driver,
   p_depth_layer_dCant,
   p_depth_layer_DIC,
   p_depth_layer_driver)

```

### dCant + DIC (surface)

Note: temperature influence was not considered for maps

```{r depth_layer_incremental_change_dCant_DIC_surface}

# subset DIC_dCant_temp change sections

acidification_depth_layer_dCant_DIC_surface <-
  acidification_depth_layer_dCant_DIC_surface %>%
  filter(driver %in% c("dCant", "DIC surface")) %>% 
  select(driver:tref,
         contains("_delta_interval"))

acidification_depth_layer_dCant_DIC_surface <-
  acidification_depth_layer_dCant_DIC_surface %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

depth_layer_low <- acidification_depth_layer_dCant_DIC_surface %>% 
  distinct(depth) %>% 
  arrange(depth) %>% 
  head(1) %>% 
  pull()

acidification_depth_layer_dCant_DIC_surface <-
  acidification_depth_layer_dCant_DIC_surface %>%
  filter(depth == depth_layer_low)

rm(depth_layer_low)


# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_dCant_DIC_surface_changes.pdf"),
  width = 14,
  height = 4
)

# loop over OIA variables
# print DIC_dCant_temp sections

for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[4]
  
  # subset OIA variable
  
  i_acidification_depth_layer_dCant_DIC_surface <-
    acidification_depth_layer_dCant_DIC_surface %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, driver, delta_interval)

  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_dCant_DIC_surface %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_dCant_DIC_surface %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  # create maps with absolute values
  
  p_depth_layer_dCant <-
  i_acidification_depth_layer_dCant_DIC_surface %>%
    filter(driver == "dCant") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: dCant")
  
  p_depth_layer_DIC <-
  i_acidification_depth_layer_dCant_DIC_surface %>%
    filter(driver == "DIC surface") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: DIC surface")
      
  
  i_delta_acidification_depth_layer_driver <-
    i_acidification_depth_layer_dCant_DIC_surface %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant` - `DIC surface`) %>%
    select(lon, lat, depth, tref, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_driver <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_driver <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_driver <-
    i_delta_acidification_depth_layer_driver %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_driver,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver difference: dCant - DIC surface")
  
  print(
    wrap_plots(
      p_depth_layer_dCant,
      p_depth_layer_DIC,
      p_depth_layer_driver,
      ncol = 3
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_dCant_DIC_surface,
   i_acidification_depth_layer_dCant_DIC_surface,
   i_delta_acidification_depth_layer_driver,
   high, low,
   breaks_divergent_driver,
   p_depth_layer_dCant,
   p_depth_layer_DIC,
   p_depth_layer_driver)

```

### dCant + Temperature

```{r depth_layer_incremental_change_dCant_temp}

# subset dCant_temp change sections

acidification_depth_layer_dCant_temp <-
  acidification_depth_layer_dCant_temp %>%
  select(driver:tref,
         contains("_delta_interval"))

acidification_depth_layer_dCant_temp <-
  acidification_depth_layer_dCant_temp %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_dCant_temp_changes.pdf"),
  width = 20,
  height = 6
)

# loop over OIA variables
# print dCant_temp sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[4]
  
  # subset OIA variable
  
  i_acidification_depth_layer_dCant_temp <-
    acidification_depth_layer_dCant_temp %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, driver, delta_interval)

  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  # create maps with absolute values
  
  p_depth_layer_dCant <-
  i_acidification_depth_layer_dCant_temp %>%
    filter(driver == "dCant") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: dCant")
  
  p_depth_layer_dCant_temp <-
  i_acidification_depth_layer_dCant_temp %>%
    filter(driver == "dCant + temp") %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver: dCant + temp")
      
  # create maps wiht decadal differences
  
  i_delta_acidification_depth_layer_decadal <-
    i_acidification_depth_layer_dCant_temp %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    select(lon, lat, depth, driver, delta_delta_interval)
  
  low <- i_delta_acidification_depth_layer_decadal %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_decadal %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_decadal <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_decadal <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_decadal <-
    i_delta_acidification_depth_layer_decadal %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "driver",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_decadal,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Decadal difference")
  
  
  i_delta_acidification_depth_layer_driver <-
    i_acidification_depth_layer_dCant_temp %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant + temp` - `dCant`) %>%
    select(lon, lat, depth, tref, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_driver %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  if (high_low != 0) {
    breaks_divergent_driver <-
      c(-Inf,
        seq(-high_low, high_low, length.out = break_numbers),
        Inf)
  } else {
    breaks_divergent_driver <-
      c(-Inf, 0, Inf)
  }
  
  p_depth_layer_driver <-
    i_delta_acidification_depth_layer_driver %>% 
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent_driver,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    ) &
    labs(title = "Driver difference")
  
  print(
    wrap_plots(
      p_depth_layer_dCant,
      p_depth_layer_dCant_temp,
      p_depth_layer_decadal,
      p_depth_layer_driver,
      ncol = 2
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_dCant_temp,
   i_acidification_depth_layer_dCant_temp,
   i_delta_acidification_depth_layer_decadal,
   i_delta_acidification_depth_layer_driver,
   high, low,
   breaks_divergent_decadal,
   breaks_divergent_driver,
   p_depth_layer_dCant,
   p_depth_layer_dCant_temp,
   p_depth_layer_decadal,
   p_depth_layer_driver)

```

### dCant

```{r depth_layer_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_depth_layer_incremental <-
  acidification_depth_layer %>%
  select(lat:Version_ID_group,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_depth_layer_uncertainty <-
  m_grid_horizontal_coarse(acidification_depth_layer_incremental)

acidification_depth_layer_uncertainty <-
  acidification_depth_layer_uncertainty %>% 
  select(-c(lat,lon)) %>% 
  rename(lat = lat_grid, lon = lon_grid) %>% 
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean),
            n = n()) %>%
  ungroup() %>% 
  filter(n == 25) %>% 
  select(-n)

# compute uncertainty

acidification_depth_layer_uncertainty <-
  additive_uncertainty(acidification_depth_layer_uncertainty)

delta_acidification_depth_layer_uncertainty <- acidification_depth_layer_uncertainty[[3]]
acidification_depth_layer_uncertainty <- acidification_depth_layer_uncertainty[[1]]


# subset reference reconstruction

acidification_depth_layer_incremental <-
  acidification_depth_layer_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_incremental_changes.pdf"),
  width = 14,
  height = 7
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_depth_layer_incremental <-
    acidification_depth_layer_incremental %>%
    filter(variable == i_var) %>% 
    select(lon, lat, depth, tref, delta_interval)

  i_acidification_depth_layer_uncertainty <-
    acidification_depth_layer_uncertainty %>%
    filter(variable == i_var)

  i_acidification_depth_layer_uncertainty <-
    i_acidification_depth_layer_uncertainty %>%
    select(lon, lat, depth, tref, signif_single, signif_double) %>%
    st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat")

  i_delta_acidification_depth_layer_uncertainty <-
    delta_acidification_depth_layer_uncertainty %>%
    filter(variable == i_var)

  i_delta_acidification_depth_layer_uncertainty <-
    i_delta_acidification_depth_layer_uncertainty %>%
    select(lon, lat, depth, tref, signif_single, signif_double) %>%
    st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat")
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_depth_layer_decades <-
  i_acidification_depth_layer_incremental %>%
    p_map_mdim_robinson(
      df_uncertainty = i_acidification_depth_layer_uncertainty,
      dim_col = "depth",
      dim_row = "tref",
      var = "delta_interval",
      legend_title = i_var,
      breaks = breaks,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    )
      
  i_delta_acidification_depth_layer_incremental <-
    i_acidification_depth_layer_incremental %>%
    arrange(lon, lat, depth) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    select(lon, lat, depth, delta_delta_interval)
  
  
  low <- i_delta_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_delta_acidification_depth_layer_incremental %>%
    filter(!is.na(delta_delta_interval)) %>%
    pull(delta_delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  high_low <- max(abs(c(low,high)))
  
  breaks_divergent <-
    c(-Inf, seq(-high_low, high_low, length.out = break_numbers), Inf)
  
  p_depth_layer_offset <-
    i_delta_acidification_depth_layer_incremental %>% 
    p_map_mdim_robinson(
      df_uncertainty = i_delta_acidification_depth_layer_uncertainty,
      dim_col = "depth",
      # dim_row = "tref",
      col = "divergent",
      var = "delta_delta_interval",
      legend_title = i_var,
      breaks = breaks_divergent,
      dot_size_single = 0.2,
      dot_size_double = 0.005,
      legend_position = "right"
    )
  
  print(
    wrap_plots(
      p_depth_layer_decades,
      p_depth_layer_offset,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_depth_layer_incremental,
   acidification_depth_layer_uncertainty,
   delta_acidification_depth_layer_uncertainty
   )

```

## Total changes

```{r depth_layer_total_change}

# subset total change sections

acidification_depth_layer_total <-
  acidification_depth_layer %>%
  select(lat:tref,
         contains("_delta_total")) %>%
  filter(tref != 1800)


acidification_depth_layer_total <-
  acidification_depth_layer_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total"))


for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[2]
  
  # subset OIA variable
  
  i_acidification_depth_layer_total <-
    acidification_depth_layer_total %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, delta_total)
  
  # # determine endpoints and breaks of color scale automatically
  # 
  # low <- i_acidification_depth_layer_total %>%
  #   filter(!is.na(delta_total)) %>%
  #   pull(delta_total) %>%
  #   quantile(c(quantile_low), names = FALSE)
  # 
  # high <- i_acidification_depth_layer_total %>%
  #   filter(!is.na(delta_total)) %>%
  #   pull(delta_total) %>%
  #   quantile(c(quantile_high), names = FALSE)
  # 
  # i_breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)

  if(i_var == "tco2"){
    i_breaks <- c(-Inf, seq(0, 80, 10), Inf)
    i_contour_level <- 50
    i_legend_title <- "ΔC<sub>ant</sub><br>(µmol kg<sup>-1</sup>)"
  }

  if (i_var == "pH") {
    i_breaks <- c(-Inf, seq(-0.12, 0, 0.02), Inf)
    i_contour_level <- -0.08
    i_legend_title <- "ΔpH<sub>T</sub>"
  }

  if (i_var == "OmegaAragonite") {
    i_breaks <- c(-Inf, seq(-0.8, 0, 0.1), Inf)
    i_contour_level <- -0.5
    i_legend_title <- "ΔΩ<sub>arag</sub>"
  }

  if (i_var == "SIR") {
    i_breaks <- c(-Inf, seq(-0.08, 0, 0.01), Inf)
    i_contour_level <- -0.05
    i_legend_title <- "ΔSIR"
  }

  if (i_var == "H_free") {
    i_breaks <- c(-Inf, seq(0, 3, 0.5), Inf)
    i_contour_level <- 2
    i_legend_title <-
      "ΔH<sup>+</sup><sub>free</sub><br>(nmol kg<sup>-1</sup>)"
    i_acidification_depth_layer_total <-
      acidification_depth_layer_total %>%
      mutate(delta_total = delta_total * 1e3)
  }
  
  
  
  p_total_fill <-
  i_acidification_depth_layer_total %>%
    p_map_mdim_robinson(
      # df_uncertainty = i_acidification_depth_layer_uncertainty,
      dim_row = "depth",
      dim_col = "tref",
      var = "delta_total",
      contour_level = i_contour_level,
      legend_title = i_legend_title,
      breaks = i_breaks,
      legend_position = "right"
    )
  
  ggsave(
    here::here(
      paste0("output/publication/maps_depth_layer_",i_var,"_total_changes.png")
    ),
    width = 12,
    height = 6,
    dpi = 600,
    bg = "white"
  )
  
}


breaks_contour <- seq(0,0.006,0.001)

i_acidification_depth_layer_total %>%
  filter(depth == "B: 100 - 500 m") %>% 
  mutate(tref = as.factor(tref)) %>% 
  ggplot(aes(lon, lat, z = delta_total)) +
  geom_contour_filled(breaks = breaks_contour) +
  geom_contour(breaks = breaks_contour, col = "white") +
  scale_fill_viridis_d() +
  coord_quickmap() +
  facet_grid(tref ~ .)

breaks_contour <- c(-Inf,0.001,0.002, Inf)

i_acidification_depth_layer_total %>%
  filter(depth == "B: 100 - 500 m") %>% 
  mutate(tref = as.factor(tref)) %>% 
  ggplot(aes(lon, lat, z = delta_total)) +
  geom_contour_filled(data = . %>% filter(tref == "1994"),
                      breaks = breaks_contour) +
  scale_fill_discrete_sequential() +
  coord_quickmap()

i_acidification_depth_layer_total %>%
  filter(depth == "B: 100 - 500 m") %>% 
  mutate(tref = as.factor(tref)) %>% 
  ggplot(aes(lon, lat, z = delta_total, linetype = tref)) +
  geom_contour(breaks = breaks_contour) +
  coord_quickmap()

world <- ne_countries(scale = "small", returnclass = "sf")
coastline <- ne_coastline(scale = "small", returnclass = "sf")

i_acidification_depth_layer_total %>%
  # filter(depth == "B: 100 - 500 m") %>% 
  mutate(tref = as.factor(tref),
         lon = if_else(lon > 180, lon - 360, lon)) %>% 
  ggplot() +
  geom_contour_filled(data = . %>% filter(tref == "1994"),
                      aes(lon, lat, z = delta_total),
                      breaks = breaks_contour) +
  geom_contour(breaks = breaks_contour,
               aes(lon, lat, z = delta_total, col = tref)) +
  scale_fill_discrete_sequential(
    # palette = "Light Gray",
    palette = "Dark Mint",
    name = expression(atop(
      Delta*H^{"+"}~1994,
      (µmol~kg^{-1})))) +
  scale_color_discrete_sequential(
    palette = "Reds",
    name = expression(atop(
      Delta*H^{"+"}~isoline,
      progression))) +
  scale_linetype_manual(values = c(3,2,1)) +
  geom_sf(data = world, fill = "grey80", col = "grey80") +
  coord_sf(expand = 0, ylim = c(-78,65)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  facet_wrap(~ depth, ncol = 2)

ggsave(
  here::here(
    "output/publication/maps_depth_layer_total_changes_hydrogen_ion_isolines.png"
  ),
  width = 10,
  height = 6,
  dpi = 600,
  bg = "white"
)


library(ggnewscale)

i_acidification_depth_layer_total %>%
  # filter(depth == "B: 100 - 500 m") %>%
  mutate(tref = as.factor(tref),
         lon = if_else(lon > 180, lon - 360, lon)) %>%
  ggplot() +
  geom_contour_filled(
    data = . %>% filter(tref == 2014),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.000, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 2004),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.000, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 1994),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.000, Inf)
  ) +
  scale_fill_brewer(palette = "Greens", name = ">0",
                    guide = guide_legend(order = 4)) +
  new_scale_fill() +
  geom_contour_filled(
    data = . %>% filter(tref == 2014),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.001, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 2004),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.001, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 1994),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.001, Inf)
  ) +
  scale_fill_brewer(palette = "Blues", name = ">0.001",
                    guide = guide_legend(order = 3)) +
  new_scale_fill() +
  geom_contour_filled(
    data = . %>% filter(tref == 2014),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.002, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 2004),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.002, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 1994),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.002, Inf)
  ) +
  scale_fill_brewer(palette = "Purples", name = ">0.002",
                    guide = guide_legend(order = 2)) +
  new_scale_fill() +
  geom_contour_filled(
    data = . %>% filter(tref == 2014),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.003, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 2004),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.003, Inf)
  ) +
  geom_contour_filled(
    data = . %>% filter(tref == 1994),
    aes(lon, lat,
        z = delta_total, fill = tref),
    breaks = c(0.003, Inf)
  ) +
  scale_fill_brewer(palette = "Reds", name = ">0.003",
                                 limits = c("1994","2004","2014"),
                    guide = guide_legend(order = 1)) +
  geom_sf(data = world, fill = "grey80", col = "grey80") +
  coord_sf(expand = 0, ylim = c(-78,65)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  facet_wrap(~ depth, ncol = 2)

ggsave(
  here::here(
    "output/publication/maps_depth_layer_total_changes_hydrogen_ion_filled.png"
  ),
  width = 10,
  height = 6,
  dpi = 600,
  bg = "white"
)

rm(acidification_depth_layer_total,
   acidification_depth_layer,
   i_acidification_depth_layer_total,
   low, high)

```



## Climatology

### OIA variables

```{r depth_layer_climatology}

# subset total change sections

climatology_depth_layer <-
  climatology_depth_layer %>%
  select(-contains("_delta"))


climatology_depth_layer <-
  climatology_depth_layer %>%
  pivot_longer(-c(lat:tref),
               names_to = "variable",
               values_to = "value")

climatology_depth_layer %>% 
  distinct(variable)

# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_climatology.pdf"),
  width = 14,
  height = 4
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_climatology_depth_layer <-
    climatology_depth_layer %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, value)
  
  # determine endpoints and breaks of color scale
  
  low <- i_climatology_depth_layer %>%
    filter(!is.na(value)) %>%
    pull(value) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_climatology_depth_layer %>%
    filter(!is.na(value)) %>%
    pull(value) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_climatology <-
  i_climatology_depth_layer %>%
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "value",
      legend_title = i_var,
      breaks = breaks
    )
  
  print(
  p_climatology
  )
  
}

dev.off()

rm(climatology_depth_layer,
   i_climatology_depth_layer,
   low, high)

```

### buffer variables

```{r depth_layer_buffer_climatology}

# subset total change sections

buffer_climatology_depth_layer <-
  buffer_climatology_depth_layer %>%
  select(-contains("_delta"))


buffer_climatology_depth_layer <-
  buffer_climatology_depth_layer %>%
  pivot_longer(-c(lat:tref),
               names_to = "variable",
               values_to = "value")

buffer_variables <- buffer_climatology_depth_layer %>% 
  distinct(variable) %>% 
  pull

# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_buffer_climatology.pdf"),
  width = 14,
  height = 4
)

# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_buffer_climatology_depth_layer <-
    buffer_climatology_depth_layer %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, value)
  
  # determine endpoints and breaks of color scale
  
  low <- i_buffer_climatology_depth_layer %>%
    filter(!is.na(value)) %>%
    pull(value) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_buffer_climatology_depth_layer %>%
    filter(!is.na(value)) %>%
    pull(value) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_climatology <-
  i_buffer_climatology_depth_layer %>%
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "value",
      legend_title = i_var,
      breaks = breaks
    )
  
  print(
  p_climatology
  )
  
}

dev.off()

rm(buffer_climatology_depth_layer,
   i_buffer_climatology_depth_layer,
   p_climatology,
   low, high)

```

```{r depth_layer_buffer_addtion_climatology}

# create pdf document

pdf(
  here::here("output/all_variables/maps_depth_layer_buffer_addition_climatology.pdf"),
  width = 10,
  height = 4
)

# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables_addition[buffer_variables_addition != "temp"]) {
  # i_var <- buffer_variables_addition[2]
  
  # subset OIA variable
  
  i_buffer_addition_depth_layer <-
    buffer_addition_depth_layer %>%
    filter(variable == i_var) %>%
    select(lon, lat, depth, tref, sensitivity)
  
  # determine endpoints and breaks of color scale
  
  low <- i_buffer_addition_depth_layer %>%
    filter(!is.na(sensitivity)) %>%
    pull(sensitivity) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_buffer_addition_depth_layer %>%
    filter(!is.na(sensitivity)) %>%
    pull(sensitivity) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_climatology <-
  i_buffer_addition_depth_layer %>%
    p_map_mdim_robinson(
      dim_col = "depth",
      dim_row = "tref",
      var = "sensitivity",
      legend_title = i_var,
      breaks = breaks
    )
  
  print(
  p_climatology
  )
  
}

dev.off()

rm(buffer_addition_depth_layer,
   i_buffer_addition_depth_layer,
   p_climatology,
   low, high)

```


# Saturation horizon maps

```{r compute_saturation_horizon_maps}

acidification_saturation_horizon <- acidification_trend %>%
  select(lat, lon, depth, tref,
         contains("Omega"),
         -contains("delta"))

acidification_saturation_horizon <-
  acidification_saturation_horizon %>%
  pivot_longer(
    contains("Omega"),
    names_to = "mineral",
    names_prefix = "Omega",
    values_to = "Omega"
  )

# downscaling for computation

# acidification_saturation_horizon <-
#   m_grid_horizontal_coarse(acidification_saturation_horizon)
# 
# acidification_saturation_horizon <-
#   acidification_saturation_horizon %>% 
#   select(-c(lat,lon)) %>% 
#   rename(lat = lat_grid, lon = lon_grid) %>% 
#   group_by(lat,lon,tref,depth,mineral) %>%
#   summarise(Omega = mean(Omega, na_rm = TRUE),
#             n = n()) %>%
#   ungroup() 
# 
# acidification_saturation_horizon <-
#   acidification_saturation_horizon %>%
#   filter(n == 25) %>%
#   select(-n)


acidification_saturation_horizon %>%
  # distinct(lat, lon, tref, mineral) %>%
  group_by(tref, mineral) %>%
  summarise(n()) %>%
  ungroup()

bathymetry <-
  acidification_saturation_horizon %>%
  group_by(lat, lon, tref, mineral) %>%
  summarise(depth = max(depth)) %>%
  ungroup()

bathymetry %>% 
  ggplot(aes(lon, lat, fill = depth)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  coord_quickmap() +
  facet_grid(mineral ~ tref)

for(i_sat_level in c(5, 4, 3, 2, 1.5, 1)) {
  
  # i_sat_level <- 2
  
  saturation_horizon_deep <-
    acidification_saturation_horizon %>%
    filter(Omega < i_sat_level) %>%
    group_by(lat, lon, tref, mineral) %>%
    mutate(saturation_horizon_deep = min(depth)) %>%
    ungroup() %>% 
    filter(depth == saturation_horizon_deep)
  
  saturation_horizon_shallow <-
    inner_join(
      acidification_saturation_horizon,
      saturation_horizon_deep %>%
        select(lat, lon, tref, mineral,
               saturation_horizon_deep)
    )
  
  saturation_horizon_shallow <-
    saturation_horizon_shallow %>%
    filter(depth < saturation_horizon_deep) %>%
    group_by(lat, lon, tref, mineral) %>%
    mutate(saturation_horizon_shallow = max(depth)) %>%
    ungroup() %>% 
    filter(depth == saturation_horizon_shallow)
  
  saturation_horizon <-
    bind_rows(saturation_horizon_deep,
              saturation_horizon_shallow) %>%
    select(-contains("saturation_horizon"))
  
  surface_grid <- saturation_horizon %>% 
    distinct(lat, lon, tref, mineral)
  
  surface_grid <-
    expand_grid(
      surface_grid,
      Omega = i_sat_level
    )
  
  saturation_horizon <-
    full_join(saturation_horizon,
              surface_grid)
  
  rm(surface_grid)
  
  saturation_horizon <-
    saturation_horizon %>%
    group_by(lon, lat, tref, mineral) %>%
    mutate(n = n()) %>%
    ungroup()
  
  saturation_horizon <-
    saturation_horizon %>%
    filter(n == 3) %>%
    select(-n)
  
  saturation_horizon <-
    saturation_horizon %>%
    arrange(lat, lon, tref, mineral, Omega) %>% 
    group_by(lon, lat, tref, mineral) %>%
    mutate(depth = approxfun(Omega, depth, rule = 1)(Omega)) %>%
    ungroup()
  
  saturation_horizon <-
    saturation_horizon %>%
    filter(Omega == i_sat_level) %>%
    select(lon, lat, tref, mineral, depth)
  
  print(
    nrow(saturation_horizon) == nrow(saturation_horizon_shallow))
  
  # fill regions with saturation horizon at surface
  
  saturation_horizon <-
    bind_rows(
      saturation_horizon,
      saturation_horizon_deep %>%
        filter(saturation_horizon_deep == 0) %>%
        select(lon, lat, tref, depth, mineral, depth)
    )
  
  # fill other regions with bathymetry
  
  bathymetry_fill <-
    anti_join(bathymetry,
              saturation_horizon %>%
                select(lat, lon, tref, mineral))
  
  saturation_horizon <-
    bind_rows(
      saturation_horizon,
      bathymetry_fill
    )
  
  saturation_horizon <- saturation_horizon %>%
    mutate(sat_level = i_sat_level)
  
  
  rm(saturation_horizon_deep,
     saturation_horizon_shallow,
     bathymetry_fill)
  
  if (exists("acidification_saturation_horizon_levels")) {
    acidification_saturation_horizon_levels <-
      bind_rows(acidification_saturation_horizon_levels,
                saturation_horizon)
  }
  
  if (!exists("acidification_saturation_horizon_levels")) {
    acidification_saturation_horizon_levels <- saturation_horizon
  }
  
  
  # calculate volume of supersaturated waters
  
  saturation_volume <- inner_join(saturation_horizon,
                                  basinmask)
  
  saturation_volume <- saturation_volume %>% 
    mutate(volume = depth * area) %>% 
    group_by(tref, mineral, basin) %>% 
    summarise(volume = sum(volume, na.rm = TRUE)) %>% 
    ungroup()
  
  saturation_volume_global <- saturation_volume %>% 
    group_by(tref, mineral) %>% 
    summarise(volume = sum(volume, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(basin = "Global")
  
  
  saturation_volume <- bind_rows(saturation_volume,
                                 saturation_volume_global) %>%
    mutate(sat_level = i_sat_level)
  

  if (exists("acidification_volume")) {
    acidification_volume <-
      bind_rows(acidification_volume, saturation_volume)
  }
  
  if (!exists("acidification_volume")) {
    acidification_volume <- saturation_volume
  }
  
  # calculate profiles of saturated area fraction
  
  saturation_profile <-
    inner_join(acidification_saturation_horizon,
               basinmask) %>%
    mutate(saturated = if_else(Omega >= i_sat_level,
                               "super",
                               "under")) %>%
    group_by(tref, basin, depth, mineral, saturated) %>%
    summarise(area = sum(area)) %>%
    ungroup() %>%
    group_by(tref, basin, depth, mineral) %>%
    mutate(area_fraction = 100 * area / sum(area)) %>%
    ungroup()
  
  saturation_profile_global <-
    inner_join(acidification_saturation_horizon,
               basinmask) %>%
    mutate(saturated = if_else(Omega >= i_sat_level,
                               "super",
                               "under")) %>%
    group_by(tref, depth, mineral, saturated) %>%
    summarise(area = sum(area)) %>%
    ungroup() %>%
    group_by(tref, depth, mineral) %>%
    mutate(area_fraction = 100 * area / sum(area)) %>%
    ungroup() %>%
    mutate(basin = "Global")
  
  saturation_profile <- bind_rows(saturation_profile,
                                  saturation_profile_global) %>%
    mutate(sat_level = i_sat_level)
  
  if (exists("acidification_area_profile")) {
    acidification_area_profile <-
      bind_rows(acidification_area_profile, saturation_profile)
  }
  
  if (!exists("acidification_area_profile")) {
    acidification_area_profile <- saturation_profile
  }
  
  rm(saturation_profile, saturation_profile_global)
 
  
}


pdf(
  here::here("output/all_variables/maps_saturation_horizon_absolute_state.pdf"),
  width = 10,
  height = 8
)

for (i_sat_level in unique(acidification_saturation_horizon_levels$sat_level)) {
  
  print(
  acidification_saturation_horizon_levels %>%
    relocate(lon) %>%
    filter(sat_level == i_sat_level) %>% 
    select(-sat_level) %>% 
    p_map_mdim_robinson(
      dim_row = "tref",
      dim_col = "mineral",
      var = "depth",
      legend_title = "Saturation\nhorizon\n(m)",
      breaks = seq(0, 6000, 500)
    ) +
    labs(title = paste("Saturation threshold:",i_sat_level))
  )
}

dev.off()

pdf(
  here::here("output/all_variables/maps_saturation_horizon_total_changes.pdf"),
  width = 10,
  height = 6
)


for (i_sat_level in unique(acidification_saturation_horizon_levels$sat_level)) {
  print(
    acidification_saturation_horizon_levels %>%
      filter(sat_level == i_sat_level) %>%
      select(-sat_level) %>%
      arrange(tref) %>%
      group_by(lat, lon, mineral) %>%
      mutate(n = n()) %>% 
      filter(n == 4) %>% 
      mutate(
        delta_depth = depth - first(depth),
        period = paste(first(tref), "-", tref)
      ) %>%
      ungroup() %>%
      filter(tref != 1800) %>% 
      drop_na() %>%
      select(lon, lat, period, mineral, delta_depth) %>%
      p_map_mdim_robinson(
        dim_row = "period",
        dim_col = "mineral",
        col = "div",
        var = "delta_depth",
        legend_title = "Change\nsaturation\nhorizon\n(m)",
        breaks = c(-Inf, -500, -200, -100, -50, -20, 0, 20, 50, 100, 200, 500, Inf)
      ) +
      labs(title = paste("Saturation threshold:", i_sat_level))
  )
}

dev.off()


pdf(
  here::here("output/all_variables/maps_saturation_horizon_changes.pdf"),
  width = 10,
  height = 6
)


for (i_sat_level in unique(acidification_saturation_horizon_levels$sat_level)) {
  print(
    acidification_saturation_horizon_levels %>%
      filter(sat_level == i_sat_level) %>%
      select(-sat_level) %>%
      arrange(tref) %>%
      group_by(lat, lon, mineral) %>%
      mutate(n = n()) %>% 
      filter(n == 4) %>% 
      mutate(
        delta_depth = depth - lag(depth),
        period = paste(lag(tref), "-", tref)
      ) %>%
      ungroup() %>%
      filter(tref != 1800) %>% 
      drop_na() %>%
      select(lon, lat, period, mineral, delta_depth) %>%
      p_map_mdim_robinson(
        dim_row = "period",
        dim_col = "mineral",
        col = "div",
        var = "delta_depth",
        legend_title = "Change\nsaturation\nhorizon\n(m)",
        breaks = c(-Inf, -500, -200, -100, -50, -20, 0, 20, 50, 100, 200, 500, Inf)
      ) +
      labs(title = paste("Saturation threshold:", i_sat_level))
  )
}

dev.off()


ocean_bathymetry <- acidification_trend %>%
  group_by(lat, lon) %>%
  summarise(depth = max(depth)) %>%
  ungroup()

ocean_volume <- inner_join(ocean_bathymetry,
                           basinmask)

rm(ocean_bathymetry)

ocean_volume <- ocean_volume %>%
  mutate(volume_total = depth * area) %>%
  group_by(basin) %>%
  summarise(volume_total = sum(volume_total, na.rm = TRUE)) %>%
  ungroup()

ocean_volume_global <- ocean_volume %>%
  summarise(volume_total = sum(volume_total, na.rm = TRUE)) %>%
  mutate(basin = "Global")


ocean_volume <- bind_rows(
  ocean_volume,
  ocean_volume_global
)

rm(ocean_volume_global)

acidification_volume <-
full_join(acidification_volume,
          ocean_volume)

acidification_volume_back <-
  acidification_volume

acidification_volume <-
  acidification_volume %>%
  arrange(tref) %>%
  group_by(mineral, basin, sat_level) %>%
  mutate(
    volume_loss = 
      volume - lag(volume, default = first(volume)),
    volume_loss_relative_to_preind = 
      100 * volume_loss / first(volume),
    volume_loss_cumulative = 
      volume - first(volume),
    volume_loss_cumulative_relative_to_preind = 
      100 * volume_loss_cumulative / first(volume),
    volume_relative_to_ocean = 100 * volume / volume_total,
    volume_loss_relative_to_ocean = 100 * volume_loss / volume_total,
    volume_loss_cumulative_relative_to_ocean = 100 * volume_loss_cumulative / volume_total,
  ) %>%
  ungroup()

acidification_volume <-
  acidification_volume %>%
  select(-volume_total) %>% 
  pivot_longer(contains("volume"),
               names_to = "estimate",
               values_to = "value")


pdf(
  here::here("output/all_variables/saturation_volumes.pdf"),
  width = 10,
  height = 8
)

print(
  acidification_volume %>%
    mutate(sat_level = as.factor(sat_level),
           tref = as.factor(tref)) %>%
    group_by(estimate) %>%
    group_split() %>%
    # head(1) %>%
    map(
      ~ ggplot(data = .x,
               aes(sat_level, value, fill = tref)) +
        labs(title = .x$estimate,
             x = "Saturation threshold") +
        geom_col(position = "dodge") +
        scale_fill_viridis_d() +
        facet_nested_wrap(vars(basin, mineral))
    )
)

dev.off()



rm(acidification_saturation_horizon,
   acidification_saturation_horizon_levels,
   acidification_volume,
   acidification_area_profile)

```


# Zonal sections

## Computation


```{r compute_zonal_mean_sections}

acidification_zonal <- acidification_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()



```


```{r compute_zonal_mean_sections_dCant_temp}

acidification_zonal_dCant_temp <- dCant_temp_trend %>%
  group_by(tref, driver) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()



```


```{r compute_zonal_mean_sections_buffer}

acidification_zonal_buffer <- buffer_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_zonal_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()

```


## Incremental changes

### dCant + Temperature

```{r zonal_dcant_temp_change}

acidification_zonal_dCant_temp <-
  acidification_zonal_dCant_temp %>%
  select(-contains("_sd")) %>% 
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))

# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_dCant_temp_changes.pdf"),
  width = 20,
  height = 6
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[10]
  
  # subset OIA variable
  
  i_acidification_zonal_dCant_temp <-
    acidification_zonal_dCant_temp %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_zonal_dCant_temp %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_zonal_dcant_temp <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_dCant_temp %>% 
        filter(driver == "dCant + temp"),
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = "Driver: dCant + temp",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)
  
  p_zonal_dcant <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_dCant_temp %>% 
        filter(driver == "dCant"),
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = "Driver: dCant",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)

  p_decadal_offset <-
    i_acidification_zonal_dCant_temp %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, driver, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = "Decadal difference",
      subtitle_text = NULL
    ) +
    facet_grid(driver ~ basin_AIP)

  p_temperature_offset <-
    i_acidification_zonal_dCant_temp %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, driver, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = driver,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `dCant + temp` - `dCant`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = "Driver difference",
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP)
  
  print(
    wrap_plots(
      p_zonal_dcant &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_zonal_dcant_temp &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_decadal_offset,
      p_temperature_offset,
      ncol = 2
    )
  )
  
}

dev.off()

rm(acidification_zonal_dCant_temp)

```

### dCant

```{r zonal_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_zonal_incremental <-
  acidification_zonal %>%
  select(MLR_basins:basin_AIP,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_zonal_uncertainty <-
  acidification_zonal_incremental %>%
  mutate(lat = as.numeric(as.character(cut(
    lat, seq(-90, 90, 10), seq(-85, 85, 10)
  ))),
  depth = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  )))
  ) %>%
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean)) %>%
  ungroup()

# compute uncertainty

acidification_zonal_uncertainty <-
  additive_uncertainty(acidification_zonal_uncertainty)

delta_acidification_zonal_uncertainty <- acidification_zonal_uncertainty[[3]]
acidification_zonal_uncertainty <- acidification_zonal_uncertainty[[1]]


# subset reference reconstruction

acidification_zonal_incremental <-
  acidification_zonal_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_incremental_changes.pdf"),
  width = 12,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_incremental <-
    acidification_zonal_incremental %>%
    filter(variable == i_var,
           depth <= 3000)
  
  i_acidification_zonal_uncertainty = acidification_zonal_uncertainty %>%
    filter(variable == i_var,
           depth <= 3000)

  i_delta_acidification_zonal_uncertainty = delta_acidification_zonal_uncertainty %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_zonal_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_zonal_dec <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_incremental,
      var = "delta_interval",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_single == 0),
      aes(lat, depth),
      shape = 20,
      size = 1,
      col = "grey"
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_double == 0),
      aes(lat, depth),
      shape = 20,
      size = 0.1,
      col = "grey"
    ) +
    facet_grid(tref ~ basin_AIP)

  
  
  
  p_zonal_offset <-
    i_acidification_zonal_incremental %>%
    arrange(depth, lat) %>%
    select(depth, lat, basin_AIP, tref, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_zonal_continous_depth(
      var = "delta_delta_interval",
      legend_title = paste0("delta\n",i_var),
      plot_slabs = "n",
      breaks = NULL,
      col = "div",
      title_text = NULL,
      subtitle_text = NULL
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_single == 0),
      aes(lat, depth),
      shape = 20,
      size = 1
    ) +
    geom_point(
      data = i_acidification_zonal_uncertainty %>% filter(signif_double == 0),
      aes(lat, depth),
      shape = 20,
      size = 0.1
    ) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_zonal_dec &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_zonal_offset,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_incremental,
   acidification_zonal_uncertainty,
   delta_acidification_zonal_uncertainty
   )

```

## Total changes


```{r zonal_total_change}

# subset total change sections

acidification_zonal_total <-
  acidification_zonal %>%
  select(tref:basin_AIP,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_zonal_total <-
  acidification_zonal_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_total_changes.pdf"),
  width = 10,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_total <-
    acidification_zonal_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_total,
      var = "delta_total",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_total,
      aes(lat, depth, z = delta_total),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_total %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = delta_total,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_total,
   i_acidification_zonal_total)

```



```{r zonal_total_change_buffer}

# subset total change sections

acidification_zonal_buffer_total <-
  acidification_zonal_buffer %>%
  select(tref:basin_AIP,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_zonal_buffer_total <-
  acidification_zonal_buffer_total %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_total_changes_buffer.pdf"),
  width = 10,
  height = 8
)

# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables) {
  # i_var <- buffer_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_buffer_total <-
    acidification_zonal_buffer_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_buffer_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_buffer_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_buffer_total,
      var = "delta_total",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_buffer_total,
      aes(lat, depth, z = delta_total),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_buffer_total %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = delta_total,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_zonal_buffer_total,
   i_acidification_zonal_buffer_total)

```


## Absolute state

```{r zonal_absolute_state}

# subset absolute value sections

acidification_zonal_absolute <-
  acidification_zonal %>%
  select(tref:basin_AIP,
         contains("_mean"),
         -contains(c("_sd", "_delta")))

acidification_zonal_absolute <-
  acidification_zonal_absolute %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))

# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_absolute_state.pdf"),
  width = 8,
  height = 8
)
# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_absolute <-
    acidification_zonal_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_absolute,
      var = "mean",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_absolute,
      aes(lat, depth, z = mean),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_absolute %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = mean,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()


rm(acidification_zonal_absolute,
   acidification_zonal,
   i_acidification_zonal_absolute)

```


```{r zonal_absolute_state_buffer}

# subset absolute value sections

acidification_zonal_buffer_absolute <-
  acidification_zonal_buffer %>%
  select(tref:basin_AIP,
         contains("_mean"),
         -contains(c("_sd", "_delta")))

acidification_zonal_buffer_absolute <-
  acidification_zonal_buffer_absolute %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))

# create pdf document

pdf(
  here::here("output/all_variables/zonal_mean_sections_absolute_state_buffer.pdf"),
  width = 8,
  height = 8
)
# loop over OIA variables
# print incremental sections

for (i_var in buffer_variables) {
  # i_var <- buffer_variables[1]
  
  # subset OIA variable
  
  i_acidification_zonal_buffer_absolute <-
    acidification_zonal_buffer_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_zonal_buffer_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_zonal_buffer_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  breaks_sub <- breaks[seq(1, length(breaks), 3)]
  
  
  p_total_fill <-
    p_section_zonal_continous_depth(
      df = i_acidification_zonal_buffer_absolute,
      var = "mean",
      legend_title = i_var,
      plot_slabs = "n",
      breaks = breaks,
      title_text = NULL,
      subtitle_text = NULL
    ) +
    facet_grid(tref ~ basin_AIP) +
    geom_contour(
      data = i_acidification_zonal_buffer_absolute,
      aes(lat, depth, z = mean),
      col = "white",
      breaks = breaks_sub
    )
  
  p_total_contour <-
    i_acidification_zonal_buffer_absolute %>%
    mutate(tref = as.factor(tref)) %>%
    ggplot() +
    geom_contour(aes(lat, depth, z = mean,
                     col = tref),
                 breaks = breaks_sub) +
    scale_y_continuous(
      trans = trans_reverser("sqrt"),
      breaks = c(0, 100, 500, seq(1500, 5000, 1000)),
      limits = c(params_global$inventory_depth_standard, 0),
      name = "Depth (m)"
    ) +
    scale_x_continuous(
      breaks = seq(-100, 100, 20),
      limits = c(-80, 65),
      name = "Latitude (°N)"
    ) +
    scale_color_brewer(palette = "YlGnBu") +
    coord_fixed(ratio = 1, expand = 0) +
    facet_grid(. ~ basin_AIP)
  
  print(
    wrap_plots(
      p_total_fill,
      p_total_contour,
      ncol = 1
    )
  )
  
}

dev.off()


rm(acidification_zonal_buffer_absolute,
   acidification_zonal_buffer,
   i_acidification_zonal_buffer_absolute)

```



# Global sections

## Computation

```{r compute_global_sections}

acidification_global_section <- acidification_trend %>%
  group_by(tref) %>%
  nest() %>%
  mutate(zonal = map(.x = data, ~m_section_global_mean_sd(.x))) %>%
  select(-data) %>%
  unnest(zonal) %>% 
  ungroup()

```

## Incremental changes

```{r global_section_incremental_change, eval=FALSE}

# subset incremental change sections

acidification_global_section_incremental <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_delta_interval"),
         -contains("_sd")) %>%
  filter(tref %in% c(2004, 2014))

# downscaling for uncertainty computation

acidification_global_section_uncertainty <-
  acidification_global_section_incremental %>%
  mutate(dist = as.numeric(as.character(cut(
    dist, seq(0, 50, 1), seq(0.5, 49.5, 1)
  ))),
  depth = as.numeric(as.character(cut(
    depth,
    c(seq(0, 500, 100), seq(1000, 10000, 500)),
    c(seq(50, 450, 100), seq(750, 10000, 500)),
    right = FALSE
  )))) %>%
  group_by(across(-contains("_delta_interval"))) %>%
  summarise(across(everything(), mean)) %>%
  ungroup()

# compute uncertainty

acidification_global_section_uncertainty <-
  additive_uncertainty(acidification_global_section_uncertainty)

delta_acidification_global_section_uncertainty <- acidification_global_section_uncertainty[[3]]
acidification_global_section_uncertainty <- acidification_global_section_uncertainty[[1]]


# subset reference reconstruction

acidification_global_section_incremental <-
  acidification_global_section_incremental %>%
  filter(MLR_basins == MLR_basins_reference,
         Version_ID_group == Version_ID_group_reference) %>%
  select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  mutate(variable = str_remove(variable, "_delta_interval_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/global_sections_incremental_changes.pdf"),
  width = 10,
  height = 12
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_global_section_incremental <-
    acidification_global_section_incremental %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_global_section_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_low), names = FALSE)
  
  high <- i_acidification_global_section_incremental %>%
    filter(!is.na(delta_interval)) %>%
    pull(delta_interval) %>%
    quantile(c(quantile_high), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_global_section_dec1 <-
    i_acidification_global_section_incremental %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "delta_interval",
      legend_title = i_var,
      title_text = "A   1994 - 2004",
      df_uncertainty = acidification_global_section_uncertainty %>%
        filter(tref == 2004,
               variable == i_var),
      breaks = breaks,
      col_uncertainty = "grey",
      subtitle_text = NULL,
      plot_slabs = "n"
    ) &
    theme(axis.title.x = element_blank(),
          axis.text.x.bottom = element_blank())
  
  p_global_section_dec2 <-
    i_acidification_global_section_incremental %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "delta_interval",
      title_text = "B   2004 - 2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      df_uncertainty = acidification_global_section_uncertainty %>%
        filter(tref == 2014,
               variable == i_var),
      col_uncertainty = "grey",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  p_global_section_offset <-
    i_acidification_global_section_incremental %>%
    arrange(depth, dist) %>%
    select(depth, dist, tref, delta_interval) %>%
    drop_na() %>%
    pivot_wider(names_from = tref,
                values_from = delta_interval) %>%
    mutate(delta_delta_interval = `2014` - `2004`) %>%
    p_section_global(
      var = "delta_delta_interval",
      legend_title = paste("delta\n", i_var),
      df_uncertainty = delta_acidification_global_section_uncertainty %>%
        filter(variable == i_var),
      plot_slabs = "n",
      col = "div",
      title_text = "C   Decadal difference",
      subtitle_text = NULL
    )
  
  print(
    wrap_plots(
      p_global_section_dec1,
      p_global_section_dec2 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_offset &
        theme(axis.text.x.top = element_blank()),
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_global_section_incremental,
   acidification_global_section_uncertainty,
   delta_acidification_global_section_uncertainty
   )

```

## Total changes


```{r global_section_total_change}

# subset total change sections

acidification_global_section_total <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_delta_total_mean")) %>%
  filter(tref != 1800)


# subset reference reconstruction

acidification_global_section_total <-
  acidification_global_section_total %>%
  # filter(MLR_basins == MLR_basins_reference,
  #        Version_ID_group == Version_ID_group_reference) %>%
  # select(-c(MLR_basins, Version_ID_group)) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  mutate(variable = str_remove(variable, "_delta_total_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/global_sections_total_changes.pdf"),
  width = 10,
  height = 12
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables[-6]) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_global_section_total <-
    acidification_global_section_total %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_global_section_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_low), names = FALSE)

  high <- i_acidification_global_section_total %>%
    filter(!is.na(delta_total)) %>%
    pull(delta_total) %>%
    quantile(c(quantile_high), names = FALSE)

  breaks <- c(-Inf, seq(low, high, length.out = break_numbers), Inf)
  
  p_global_section_period1 <-
    i_acidification_global_section_total %>%
    filter(tref == 1994) %>%
    p_section_global(
      var = "delta_total",
      legend_title = i_var,
      title_text = "A   1800 - 1994",
      breaks = NULL,
      subtitle_text = NULL,
      plot_slabs = "n"
    ) &
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          axis.text.x.bottom = element_blank())
  
  p_global_section_period2 <-
    i_acidification_global_section_total %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "delta_total",
      legend_title = paste("delta\n", i_var),
      title_text = "B   1800 - 2004",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    )
  
  p_global_section_period3 <-
    i_acidification_global_section_total %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "delta_total",
      legend_title = i_var,
      title_text = "C   1800 - 2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  
  print(
    wrap_plots(
      p_global_section_period1,
      p_global_section_period2 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_period3 &
        theme(axis.text.x.top = element_blank()),
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_global_section_total,
   i_acidification_global_section_total)

```

## Absolute state

```{r global_section_absolute_state}

# subset absolute value sections

acidification_global_section_absolute <-
  acidification_global_section %>%
  select(tref:band, dist,
         contains("_mean"),
         -contains(c("_sd", "_delta")))


# subset reference reconstruction

acidification_global_section_absolute <-
  acidification_global_section_absolute %>%
  pivot_longer(contains("_mean"),
               names_to = "variable",
               values_to = "mean") %>%
  mutate(variable = str_remove(variable, "_mean"))


# create pdf document

pdf(
  here::here("output/all_variables/global_sections_absolute_state.pdf"),
  width = 10,
  height = 16
)

# loop over OIA variables
# print incremental sections

for (i_var in OIA_variables) {
  # i_var <- OIA_variables[1]
  
  # subset OIA variable
  
  i_acidification_global_section_absolute <-
    acidification_global_section_absolute %>%
    filter(variable == i_var,
           depth <= 3000)
  
  # determine endpoints and breaks of color scale
  
  low <- i_acidification_global_section_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(.02), names = FALSE)
  
  high <- i_acidification_global_section_absolute %>%
    filter(!is.na(mean)) %>%
    pull(mean) %>%
    quantile(c(.98), names = FALSE)
  
  breaks <- c(-Inf, seq(low, high, length.out = 10), Inf)
  
  p_global_section_period1 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 1800) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "A   1800",
      breaks = breaks,
      subtitle_text = NULL,
      plot_slabs = "n"
    ) &
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          axis.text.x.bottom = element_blank())
  
  p_global_section_period2 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 1994) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "B   1994",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    )
  
  p_global_section_period3 <-
    i_acidification_global_section_absolute %>%
    filter(tref == 2004) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "C   2004",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  p_global_section_period4<-
    i_acidification_global_section_absolute %>%
    filter(tref == 2014) %>%
    p_section_global(
      var = "mean",
      legend_title = i_var,
      title_text = "D   2014",
      subtitle_text = NULL,
      plot_slabs = "n",
      breaks = breaks
    ) &
    theme(legend.position = "none")
  
  
  print(
    wrap_plots(
      p_global_section_period1,
      p_global_section_period2 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_period3 &
        theme(axis.title.x = element_blank(),
              axis.text.x = element_blank()),
      p_global_section_period4 &
        theme(axis.text.x.top = element_blank()),
      ncol = 1
    )
  )
  
}

dev.off()

rm(acidification_global_section_absolute,
   acidification_global_section,
   i_acidification_global_section_absolute)

```




# Profiles

## Computation

```{r compute_mean_profiles_total_acidification}

# join with 3D acidification fields

acidification_profiles <-
  full_join(basinmask,
            acidification_trend %>%
              select(-c(basin_AIP, contains("temp")))) %>%
  drop_na() %>%
  relocate(tref)

# scale values to surface area

acidification_profiles <- acidification_profiles %>% 
  mutate(across(gamma:H_free_delta_interval,
                ~ . * area))

# calculate regional means

acidification_profiles_regional <- acidification_profiles %>%
  group_by(tref, basin, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

acidification_profiles_global <- acidification_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
acidification_profiles <-
  bind_rows(acidification_profiles_global,
            acidification_profiles_regional)
  
rm(acidification_profiles_regional,
   acidification_profiles_global)


# rename basins

acidification_profiles <- acidification_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

acidification_profiles <- acidification_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_total_acidification_biomes}

# join with 3D acidification fields

acidification_profiles_biomes <-
  full_join(biome_mask,
            acidification_trend %>%
              select(-c(basin_AIP, contains("temp")))) %>%
  drop_na() %>%
  relocate(tref)

# scale values to surface area

acidification_profiles_biomes <- acidification_profiles_biomes %>% 
  mutate(across(gamma:H_free_delta_interval,
                ~ . * area))

# calculate regional means

acidification_profiles_biomes_regional <- acidification_profiles_biomes %>%
  group_by(tref, region, biome, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

acidification_profiles_biomes_global <- acidification_profiles_biomes %>%
  mutate(region = "Global",
         biome = "Global") %>% 
  group_by(tref, region, biome, depth) %>%
  summarise(across(gamma:H_free_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
acidification_profiles_biomes <-
  bind_rows(acidification_profiles_biomes_global,
            acidification_profiles_biomes_regional)
  
rm(acidification_profiles_biomes_regional,
   acidification_profiles_biomes_global)


acidification_profiles_biomes <- acidification_profiles_biomes %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_temperature_trend}


# join with 3D acidification fields

dCant_temp_profiles <-
  full_join(basinmask,
            dCant_temp_trend)

# scale values to surface area

dCant_temp_profiles <- dCant_temp_profiles %>% 
  mutate(across(contains("_delta_interval"),
                ~ . * area))

# calculate regional means

dCant_temp_profiles_regional <- dCant_temp_profiles %>%
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

dCant_temp_profiles_global <- dCant_temp_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
dCant_temp_profiles <-
  bind_rows(dCant_temp_profiles_global,
            dCant_temp_profiles_regional)
  
rm(dCant_temp_profiles_regional,
   dCant_temp_profiles_global)


# rename basins

dCant_temp_profiles <- dCant_temp_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

dCant_temp_profiles <- dCant_temp_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_DIC_dCant_temperature_trend}


# join with 3D acidification fields

DIC_dCant_temp_profiles <-
  full_join(basinmask,
            dCant_DIC_temp_trend)

# scale values to surface area

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>% 
  mutate(across(contains("_delta_interval"),
                ~ . * area))

# calculate regional means

DIC_dCant_temp_profiles_regional <- DIC_dCant_temp_profiles %>%
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

DIC_dCant_temp_profiles_global <- DIC_dCant_temp_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth, driver) %>%
  summarise(across(contains("_delta_interval"),
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
DIC_dCant_temp_profiles <-
  bind_rows(DIC_dCant_temp_profiles_global,
            DIC_dCant_temp_profiles_regional)
  
rm(DIC_dCant_temp_profiles_regional,
   DIC_dCant_temp_profiles_global)


# rename basins

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_buffer}


# join with 3D acidification fields

buffer_profiles <-
  full_join(basinmask,
            buffer_trend %>% select(-basin_AIP))

# scale values to surface area

buffer_profiles <- buffer_profiles %>% 
  mutate(across(gammaDIC:tco2_talk_ratio_delta_interval,
                ~ . * area))

# calculate regional means

buffer_profiles_regional <- buffer_profiles %>%
  group_by(tref, basin, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

buffer_profiles_global <- buffer_profiles %>%
  mutate(basin = "Global") %>% 
  group_by(tref, basin, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
buffer_profiles <-
  bind_rows(buffer_profiles_global,
            buffer_profiles_regional)
  
rm(buffer_profiles_regional,
   buffer_profiles_global)


# rename basins

buffer_profiles <- buffer_profiles %>%
  mutate(
    basin = str_replace(basin,
                        "_",
                        ". "),
    basin = fct_relevel(
      basin,
      "Global",
      "N. Pacific",
      "N. Atlantic",
      "Indian",
      "S. Pacific",
      "S. Atlantic"
    )
  )

buffer_profiles <- buffer_profiles %>%
  mutate(tref = as.factor(tref))

```

```{r compute_mean_profiles_buffer_biome}


# join with 3D acidification fields

buffer_profiles_biome <-
  full_join(biome_mask,
            buffer_trend %>% select(-basin_AIP))

# scale values to surface area

buffer_profiles_biome <- buffer_profiles_biome %>% 
  mutate(across(gammaDIC:tco2_talk_ratio_delta_interval,
                ~ . * area))

# calculate regional means

buffer_profiles_biome_regional <- buffer_profiles_biome %>%
  group_by(tref, region, biome, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# calculate global means

buffer_profiles_biome_global <- buffer_profiles_biome %>%
  mutate(region = "Global",
         biome = "Global") %>% 
  group_by(tref, region, biome, depth) %>%
  summarise(across(gammaDIC:tco2_talk_ratio_delta_interval,
                   ~ sum(.) / sum(area))) %>%
  ungroup()

# join global and regional profiles
  
buffer_profiles_biome <-
  bind_rows(buffer_profiles_biome_global,
            buffer_profiles_biome_regional)
  
rm(buffer_profiles_biome_regional,
   buffer_profiles_biome_global)


buffer_profiles_biome <- buffer_profiles_biome %>%
  mutate(tref = as.factor(tref))

```

## Incremental changes

### DIC + dCant + Temperature

```{r profiles_DIC_dCant_temp_change}


DIC_dCant_temp_profiles <-
  DIC_dCant_temp_profiles %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  filter(variable %in% OIA_variables)


DIC_dCant_temp_profiles <- DIC_dCant_temp_profiles %>%
  mutate(
    temperature = if_else(str_detect(driver, "temp"), "variable", "climatology"),
    driver = if_else(str_detect(driver, "dCant"), "dCant", "DIC")
  )

# create pdf document

pdf(
  here::here("output/all_variables/profiles_DIC_dCant_temp_changes.pdf"),
  width = 14,
  height = 12
)

ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(data = DIC_dCant_temp_profiles, aes(delta_interval,
                                            depth,
                                            col = driver,
                                            linetype = temperature)) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "Depth (m)",
       title = "Decadal ocean interior acidification 2004 - 2014") +
  scale_y_reverse(breaks = seq(0, 5000, 500)) +
  # scale_x_continuous(guide = guide_axis(n.dodge = 2)) +
  # scale_y_continuous(trans = trans_reverser("sqrt"),
  #                    breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=1)) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()

DIC_dCant_temp_profiles %>%
  filter(variable == "tco2",
         basin == "Global",
         temperature == "climatology") %>%
  pivot_wider(names_from = driver,
              values_from = delta_interval) %>% 
  ggplot(aes(y = depth)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(aes(x = dCant, col = "dCant"), linewidth = 2) +
  geom_path(aes(x = DIC, col = "DIC"), linewidth = 2) +
  annotate(
    "text", label = "Anthropogenic\nDIC",
    x = 11.5, y = 200, colour = "#555555"
  ) +
  annotate(
    "text", label = "Total\nDIC",
    x = 4.5, y = 1000, colour = "#4477AA"
  ) +
  scale_color_manual(values = c("#555555", "#4477AA")) +
  scale_fill_manual(values = c("#228833", "#EE6677")) +
  labs(y = "Depth (m)",
       x = expression(Delta*DIC~(µmol~kg^{-1}~decade^{-1}))) +
  coord_cartesian(expand = 0) +
  scale_y_reverse(breaks = seq(0, 5000, 250)) +
  scale_x_continuous(limits = c(0,13),
                     breaks = seq(0,20,2),
                     position = "top") +
  theme_classic() +
  theme(legend.position = "none")

ggsave(  here::here("output/all_variables/profiles_MOBO-DIC_vs_eMLR_no_fill.jpg"),
  width = 5,
  height = 5,
  dpi = 600)


DIC_dCant_temp_profiles %>%
  filter(variable == "tco2",
         basin == "Global",
         temperature == "climatology") %>%
  pivot_wider(names_from = driver,
              values_from = delta_interval) %>% 
  ggplot(aes(y = depth)) +
  geom_vline(xintercept = 0, col = "grey") +
  stat_difference(aes(xmin = dCant, xmax = DIC), alpha = 0.3,
                  levels = c("Cnat gain", "Cnat loss")) +
  geom_path(aes(x = dCant, col = "dCant"), linewidth = 2) +
  geom_path(aes(x = DIC, col = "DIC"), linewidth = 2) +
  annotate(
    "text", label = "Anthropogenic\nDIC",
    x = 11.5, y = 200, colour = "#555555"
  ) +
  annotate(
    "text", label = "Total\nDIC",
    x = 4.5, y = 1000, colour = "#4477AA"
  ) +
  annotate(
    "text", label = "Natural\nDIC loss",
    x = 4, y = 100, colour = "#EE6677"
  ) +
  annotate(
    "segment", x = 5, xend = 9, y = 100, yend = 100, colour = "#EE6677"
  ) +
  annotate(
    "text", label = "Natural\nDIC gain",
    x = 2, y = 500, colour = "#228833"
  ) +
  annotate(
    "segment", x = 3, xend = 5, y = 500, yend = 500, colour = "#228833"
  ) +
  scale_color_manual(values = c("#555555", "#4477AA")) +
  scale_fill_manual(values = c("#228833", "#EE6677")) +
  labs(y = "Depth (m)",
       x = expression(Delta*DIC~(µmol~kg^{-1}~decade^{-1}))) +
  coord_cartesian(expand = 0) +
  scale_y_reverse(breaks = seq(0, 5000, 250)) +
  scale_x_continuous(limits = c(0,13),
                     breaks = seq(0,20,2),
                     position = "top") +
  theme_classic() +
  theme(legend.position = "none")

ggsave(  here::here("output/all_variables/profiles_MOBO-DIC_vs_eMLR.jpg"),
  width = 5,
  height = 5,
  dpi = 600)

#>      blue       red     green    yellow      cyan    purple      grey 
#> "#4477AA" "#EE6677" "#228833" "#CCBB44" "#66CCEE" "#AA3377" "#BBBBBB" 

rm(DIC_dCant_temp_profiles)


```


### dCant + Temperature

```{r profiles_dCant_temp_change}


dCant_temp_profiles <-
  dCant_temp_profiles %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval"))

dCant_temp_profiles_min_max <-
dCant_temp_profiles %>%
  pivot_wider(values_from = delta_interval,
              names_from = driver)
  
  
  
  
# create pdf document

pdf(
  here::here("output/all_variables/profiles_dCant_temp_changes.pdf"),
  width = 14,
  height = 8
)

ggplot() +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path(data = dCant_temp_profiles, aes(delta_interval,
                                            depth,
                                            col = tref,
                                            linetype = driver)) +
  geom_ribbon(data = dCant_temp_profiles_min_max,
              aes(y = depth, xmin = dCant, xmax = `dCant + temp`,
                  fill = tref),
              alpha = 0.3) +
  scale_color_manual(values = c("#EE7733", "#009988")) +
  scale_fill_manual(values = c("#EE7733", "#009988")) +
  labs(y = "Depth (m)",
       title = "Incremental change from previous estimate") +
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()

rm(dCant_temp_profiles, dCant_temp_profiles_min_max)


```


### dCant

```{r profiles_incremental_change, eval=FALSE}

# create pdf document

pdf(
  here::here("output/all_variables/profiles_incremental_changes.pdf"),
  width = 14,
  height = 8
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         MLR_basins,
         Version_ID_group,
         contains("_delta_interval")) %>%
  pivot_longer(contains("_delta_interval"),
               names_to = "variable",
               values_to = "delta_interval") %>%
  filter(tref %in% c(2004,2014),
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_interval")) %>% 
  ggplot(aes(
    delta_interval,
    depth,
    col = tref,
    group = interaction(tref, MLR_basins, Version_ID_group)
  )) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_manual(values = c("#EE7733", "#009988")) +
  labs(y = "Depth (m)",
       title = "Incremental change from previous estimate")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```


## Total changes

### Basins

```{r profiles_total_change}

# create pdf document

pdf(
  here::here("output/all_variables/profiles_total_changes.pdf"),
  width = 14,
  height = 8
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  filter(tref != 1800,
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>% 
  ggplot(aes(
    delta_total,
    depth,
    col = tref)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Total change since 1800")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")


dev.off()

pdf(
  here::here("output/all_variables/profiles_total_changes_color.pdf"),
  width = 14,
  height = 6
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  filter(tref != 1800,
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>% 
  ggplot(aes(
    delta_total,
    depth,
    col = basin)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  labs(y = "Depth (m)",
       title = "Total change since 1800")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(tref ~ variable, scales = "free_x")



dev.off()

# acidification_profiles_interval <-
#   acidification_profiles %>%
#   select(tref,
#          basin,
#          depth,
#          contains("_delta_interval")) %>%
#   pivot_longer(contains("_delta_interval"),
#                names_to = "variable",
#                values_to = "delta_interval") %>%
#   filter(tref != 1800,
#          depth <= 3000) %>%
#   mutate(variable = str_remove(variable, "_delta_interval"))
# # filter(basin == "Global",
# #        variable == "pCO2insitu")
# 
# acidification_profiles_total <-
#   acidification_profiles %>%
#   select(tref,
#          basin,
#          depth,
#          contains("_delta_total")) %>%
#   pivot_longer(contains("_delta_total"),
#                names_to = "variable",
#                values_to = "delta_total") %>%
#   filter(tref != 1800,
#          depth <= 3000) %>%
#   mutate(variable = str_remove(variable, "_delta_total"))
# # filter(basin == "Global",
# #        variable == "pCO2insitu")
# 
# 
# ggplot() +
#   geom_area(
#     data = acidification_profiles_interval,
#     aes(delta_interval,
#         depth,
#         fill = tref),
#     alpha = 0.5,
#     orientation = "y",
#     position = position_stack(reverse = TRUE)
#   ) +
#   geom_path(data = acidification_profiles_total,
#             aes(delta_total,
#                 depth,
#                 group = tref),
#             col = "grey20") +
#   scale_fill_viridis_d(option = "viridis") +
#   labs(y = "Depth (m)",
#        title = "Total change since 1800") +
#   scale_y_continuous(trans = trans_reverser("sqrt"),
#                      breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
#   coord_cartesian(expand = 0) +
#   theme(legend.title = element_blank(),
#         axis.title.x = element_blank()) +
#   facet_grid(basin ~ variable, scales = "free_x")


```

### Biomes


```{r profiles_total_change_biome}

# create pdf document

pdf(
  here::here("output/all_variables/profiles_total_changes_biome.pdf"),
  width = 14,
  height = 20
)

acidification_profiles_biomes %>%
  select(tref,
         region,
         biome,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  filter(tref != 1800,
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>% 
  ggplot(aes(
    delta_total,
    depth,
    col = tref)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Total change since 1800")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(biome ~ variable, scales = "free_x")

dev.off()

# create pdf document

pdf(
  here::here("output/all_variables/profiles_total_changes_biome_color.pdf"),
  width = 14,
  height = 6
)


acidification_profiles_biomes %>%
  select(tref,
         region,
         biome,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  filter(tref != 1800,
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>% 
  ggplot(aes(
    delta_total,
    depth,
    col = biome)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  labs(y = "Depth (m)",
       title = "Total change since 1800")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(tref ~ variable, scales = "free_x")



dev.off()


```


```{r profiles_total_change_buffer}

# create pdf document

pdf(
  here::here("output/all_variables/profiles_total_changes_buffer.pdf"),
  width = 10,
  height = 8
)

buffer_profiles %>%
  select(tref,
         basin,
         depth,
         contains("_delta_total")) %>%
  pivot_longer(contains("_delta_total"),
               names_to = "variable",
               values_to = "delta_total") %>%
  filter(tref != 1800,
         depth <= 3000) %>%
  mutate(variable = str_remove(variable, "_delta_total")) %>% 
  ggplot(aes(
    delta_total,
    depth,
    col = tref)) +
  geom_vline(xintercept = 0, col = "grey") +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Total change since 1800")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")



dev.off()

```

## Absolute state

```{r profiles_absolute_state}


# create pdf document

pdf(
  here::here("output/all_variables/profiles_absolute_state.pdf"),
  width = 14,
  height = 8
)

acidification_profiles %>%
  select(tref,
         basin,
         depth,
         # MLR_basins,
         # Version_ID_group,
         all_of(OIA_variables[-6])) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = tref
  )) +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```

## Buffer

### Basins

```{r profiles_absolute_state_buffer}


# create pdf document

pdf(
  here::here("output/all_variables/profiles_absolute_state_buffer.pdf"),
  width = 10,
  height = 8
)

buffer_profiles %>%
  select(tref,
         basin,
         depth,
         gammaDIC:R,
         tco2_talk_ratio) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = tref
  )) +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_continuous(trans = trans_reverser("sqrt"),
                     breaks = c(0, 100, 500, seq(1500, 5000, 1000))) +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(basin ~ variable, scales = "free_x")

dev.off()


```

### Biomes


```{r profiles_absolute_state_buffer_biome}


# create pdf document

pdf(
  here::here("output/all_variables/profiles_absolute_state_buffer_biome.pdf"),
  width = 10,
  height = 20
)

buffer_profiles_biome %>%
  select(tref,
         region,
         biome,
         depth,
         gammaDIC:R,
         tco2_talk_ratio) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = tref
  )) +
  geom_path() +
  scale_color_brewer(palette = "YlGnBu") +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_reverse() +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(biome ~ variable, scales = "free_x")

dev.off()

pdf(
  here::here("output/all_variables/profiles_absolute_state_buffer_biome_color.pdf"),
  width = 10,
  height = 8
)

buffer_profiles_biome %>%
  select(tref,
         region,
         biome,
         depth,
         gammaDIC:R,
         tco2_talk_ratio) %>%
  pivot_longer(-c(tref:depth),
               names_to = "variable",
               values_to = "total") %>%
  filter(depth <= 3000) %>%
  ggplot(aes(
    total,
    depth,
    col = biome
  )) +
  geom_path() +
  labs(y = "Depth (m)",
       title = "Absolute state at reference years")+
  scale_y_reverse() +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank()) +
  facet_grid(tref ~ variable, scales = "free_x")

dev.off()


```



Write ouput

```{r write_output_files, eval=FALSE}

acidification_trend %>% 
  write_csv(paste0(path_OIA, "OIA.csv"))


acidification_layer %>% 
  write_csv(paste0(path_OIA, "OIA_layer.csv"))

acidification_zonal %>% 
  write_csv(paste0(path_OIA, "OIA_zonal.csv"))


acidification_global_section %>% 
  write_csv(paste0(path_OIA, "OIA_global_section.csv"))

acidification_profiles %>% 
  write_csv(paste0(path_OIA, "OIA_profiles.csv"))




```



